<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Dash Play Unblocked!</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* Base CSS remains the same but enhanced */
        :root {
            --neon-blue: #00ffff;
            --neon-pink: #ff0088;
            --neon-green: #00ff00;
            --neon-yellow: #ffff00;
            --neon-orange: #ff8800;
            --neon-red: #ff0000;
            --neon-purple: #d000ff;
            --player-main: #00ffff;
            --player-sec: #ff0088;
            --border-glow: 0 0 15px var(--neon-blue);
            --button-glow: 0 0 20px currentColor;
            --black-outline: 2px solid #000;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        body {
            background: #000011;
            color: var(--neon-blue);
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        canvas {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
        }
        
        /* UI Layers */
        .ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 20, 0.9);
            z-index: 100;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }
        
        .ui-layer.visible {
            opacity: 1;
            pointer-events: all;
            transform: scale(1);
        }
        
        .ui-layer.hidden {
            display: none;
        }
        
        /* Menu Box */
        .menu-box {
            background: rgba(0, 0, 30, 0.95);
            border: 3px solid var(--neon-blue);
            border-radius: 15px;
            padding: 30px;
            min-width: 320px;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 0 50px var(--neon-blue), 0 0 100px rgba(0, 255, 255, 0.3);
            position: relative;
            overflow-y: auto;
            max-height: 90vh;
        }
        
        .menu-box::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 17px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink), var(--neon-green), var(--neon-yellow));
            z-index: -1;
            filter: blur(10px);
            opacity: 0.3;
        }
        
        h1, h2, h3 {
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        h1 { font-size: 2.5em; }
        h2 { font-size: 2em; }
        h3 { font-size: 1.5em; }
        
        /* Buttons */
        button {
            background: rgba(0, 0, 0, 0.8);
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
            padding: 15px 25px;
            margin: 10px;
            font-size: 1.2em;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            width: 250px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            box-shadow: var(--button-glow);
            outline: var(--black-outline) !important;
            position: relative;
            z-index: 1;
        }
        
        button:hover, button:focus {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 40px var(--neon-blue);
            transform: translateY(-2px);
        }
        
        button.green { border-color: var(--neon-green); color: var(--neon-green); }
        button.green:hover { background: var(--neon-green); }
        
        button.pink { border-color: var(--neon-pink); color: var(--neon-pink); }
        button.pink:hover { background: var(--neon-pink); }
        
        button.red { border-color: var(--neon-red); color: var(--neon-red); }
        button.red:hover { background: var(--neon-red); }
        
        button.yellow { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        button.yellow:hover { background: var(--neon-yellow); }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Level Grid */
        #lvl-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .lvl-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--button-glow);
            outline: var(--black-outline) !important;
            position: relative;
            z-index: 1;
        }
        
        .lvl-btn.unlocked:hover, .lvl-btn:focus {
            background: var(--neon-blue);
            color: #000;
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--neon-blue);
        }
        
        .lvl-btn.locked {
            border-color: #666;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* HUD */
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 50;
            color: white;
            font-size: 1.5em;
            text-shadow: 0 0 10px #000;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid var(--neon-blue);
            box-shadow: var(--border-glow);
            outline: var(--black-outline);
        }
        
        .hud-stats {
            margin-bottom: 10px;
        }
        
        #prog-bar {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            outline: var(--black-outline);
        }
        
        #prog {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
            transition: width 0.3s ease;
            width: 0%;
        }
        
        #msg {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: var(--neon-green);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.5em;
            border: 2px solid var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
            transition: opacity 0.3s ease;
            outline: var(--black-outline);
            z-index: 50;
        }
        
        #tutorial-msg {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: var(--neon-yellow);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.3em;
            border: 2px solid var(--neon-yellow);
            box-shadow: 0 0 30px var(--neon-yellow);
            text-align: center;
            max-width: 80%;
            outline: var(--black-outline);
            z-index: 50;
        }
        
        /* Mobile Controls */
        #game-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 150px;
            z-index: 40;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        
        #game-container.show-mobile {
            display: flex;
        }
        
        .mobile-btn {
            width: 120px;
            height: 120px;
            background: rgba(0, 255, 255, 0.3);
            border: 3px solid var(--neon-blue);
            border-radius: 50%;
            color: white;
            font-size: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
            pointer-events: auto;
            box-shadow: 0 0 30px var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .mobile-btn:active {
            background: rgba(0, 255, 255, 0.7);
            transform: scale(0.95);
        }
        
        /* Shop Items */
        .costume-item {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            width: 180px;
            text-align: center;
            box-shadow: var(--border-glow);
            outline: var(--black-outline);
        }
        
        .costume-item:hover {
            transform: translateY(-5px);
            border-color: var(--neon-pink);
            box-shadow: 0 0 30px var(--neon-pink);
        }
        
        .costume-item.unlocked {
            border-color: var(--neon-green);
        }
        
        .costume-item.equipped {
            border-color: var(--neon-yellow);
            background: rgba(255, 255, 0, 0.1);
        }
        
        .costume-preview {
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
            border: 3px solid;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            outline: var(--black-outline);
        }
        
        .player-preview-cube {
            width: 60px;
            height: 60px;
            position: relative;
            border: 3px solid;
            outline: var(--black-outline);
        }
        
        /* Settings */
        .settings-group {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            outline: var(--black-outline);
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            outline: var(--black-outline);
        }
        
        .settings-label {
            color: var(--neon-blue);
            font-weight: bold;
        }
        
        .settings-value {
            color: var(--neon-green);
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 34px;
            border: 2px solid var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 2px;
            background-color: var(--neon-blue);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--neon-blue);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
            background-color: #000;
        }
        
        /* Sliders */
        .slider-container {
            margin: 10px 0 20px 0;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            background: rgba(0, 0, 0, 0.8);
            outline: none;
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            outline: var(--black-outline);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            background: var(--neon-blue);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #000;
            box-shadow: 0 0 10px var(--neon-blue);
        }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000011;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(0, 255, 255, 0.3);
            border-top: 8px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
            box-shadow: 0 0 50px var(--neon-blue);
            outline: var(--black-outline);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Screen Transition */
        .screen-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .transition-active {
            opacity: 1;
            background: rgba(0, 0, 0, 0.95);
        }
        
        /* Screen Shake */
        .screen-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        /* Performance Indicator */
        .performance-indicator {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: var(--neon-green);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            border: 1px solid var(--neon-green);
            z-index: 1000;
            display: none;
            outline: var(--black-outline);
        }
        
        /* Editor Tools */
        #editor-tools {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            border: 3px solid var(--neon-blue);
            border-radius: 10px;
            padding: 10px;
            display: none;
            gap: 10px;
            z-index: 100;
            box-shadow: 0 0 30px var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .editor-tool-btn {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--neon-blue);
            border-radius: 8px;
            color: var(--neon-blue);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            outline: var(--black-outline);
        }
        
        .editor-tool-btn:hover, .editor-tool-btn.active {
            background: var(--neon-blue);
            color: #000;
            transform: scale(1.1);
        }
        
        .editor-coin-counter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: var(--neon-yellow);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1.2em;
            border: 2px solid var(--neon-yellow);
            z-index: 100;
            display: none;
            box-shadow: 0 0 20px var(--neon-yellow);
            outline: var(--black-outline);
        }
        
        /* Editor Crosshair */
        .editor-crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            pointer-events: none;
            z-index: 60;
            display: none;
        }
        
        .crosshair-horizontal,
        .crosshair-vertical {
            position: absolute;
            background: var(--neon-red);
            box-shadow: 0 0 10px var(--neon-red);
            outline: var(--black-outline);
        }
        
        .crosshair-horizontal {
            width: 40px;
            height: 4px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }
        
        .crosshair-vertical {
            width: 4px;
            height: 40px;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* NEW: Achievement System */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: -400px;
            background: linear-gradient(90deg, rgba(0,0,0,0.9), rgba(0,0,0,0.7));
            border: 3px solid var(--neon-yellow);
            border-radius: 15px;
            padding: 20px;
            width: 350px;
            z-index: 1000;
            transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 40px var(--neon-yellow);
            outline: var(--black-outline);
        }
        
        .achievement-popup.show {
            right: 20px;
        }
        
        .achievement-icon {
            font-size: 2.5em;
            float: left;
            margin-right: 15px;
        }
        
        .achievement-title {
            color: var(--neon-yellow);
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .achievement-desc {
            color: var(--neon-green);
            font-size: 0.9em;
        }
        
        .achievement-progress {
            background: rgba(0,0,0,0.7);
            height: 8px;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
            border: 1px solid var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* NEW: Save System UI */
        .save-system {
            background: rgba(0,0,0,0.9);
            border: 3px solid var(--neon-green);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 20px auto;
            text-align: center;
            box-shadow: 0 0 40px var(--neon-green);
            outline: var(--black-outline);
        }
        
        .save-slot {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            outline: var(--black-outline);
        }
        
        .save-slot:hover {
            border-color: var(--neon-green);
            transform: translateY(-2px);
            box-shadow: 0 0 20px var(--neon-green);
        }
        
        .save-slot.active {
            border-color: var(--neon-yellow);
            background: rgba(255,255,0,0.1);
        }
        
        .save-slot-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .save-slot-title {
            color: var(--neon-blue);
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .save-slot-date {
            color: var(--neon-green);
            font-size: 0.9em;
        }
        
        .save-slot-stats {
            color: var(--neon-pink);
            font-size: 0.9em;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        /* NEW: Leaderboard */
        .leaderboard {
            background: rgba(0,0,0,0.9);
            border: 3px solid var(--neon-purple);
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px auto;
            box-shadow: 0 0 40px var(--neon-purple);
            outline: var(--black-outline);
        }
        
        .leaderboard-entry {
            background: rgba(0,0,0,0.7);
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            display: grid;
            grid-template-columns: 50px 1fr 100px;
            align-items: center;
            transition: all 0.3s ease;
            outline: var(--black-outline);
        }
        
        .leaderboard-entry:hover {
            transform: translateX(5px);
            border-color: var(--neon-yellow);
        }
        
        .leaderboard-rank {
            color: var(--neon-yellow);
            font-weight: bold;
            font-size: 1.5em;
            text-align: center;
        }
        
        .leaderboard-name {
            color: var(--neon-blue);
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .leaderboard-score {
            color: var(--neon-green);
            font-weight: bold;
            text-align: right;
        }
        
        /* NEW: Time Trial Display */
        .time-trial-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: var(--neon-orange);
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.5em;
            border: 3px solid var(--neon-orange);
            z-index: 50;
            box-shadow: 0 0 30px var(--neon-orange);
            display: none;
            text-align: center;
            outline: var(--black-outline);
        }
        
        .time-trial-best {
            color: var(--neon-green);
            font-size: 0.8em;
            margin-top: 5px;
        }
        
        /* NEW: Accessibility Features */
        .accessibility-high-contrast {
            filter: contrast(2) brightness(1.2);
        }
        
        .accessibility-large-text * {
            font-size: 1.2em !important;
        }
        
        /* Add new styles for particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .coin-effect {
            position: absolute;
            color: var(--neon-yellow);
            font-weight: 900;
            font-size: 1.5em;
            text-shadow: 0 0 20px var(--neon-yellow);
            pointer-events: none;
            z-index: 100;
            animation: float-up 1s ease-out forwards;
        }
        
        .dash-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            opacity: 0;
            pointer-events: none;
            z-index: 90;
            animation: dash-pulse 0.3s ease-out forwards;
        }
        
        @keyframes float-up {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }
        
        @keyframes dash-pulse {
            0% {
                transform: scale(0.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }
        
        /* New button for What's New */
        .whats-new-btn {
            border-color: var(--neon-orange);
            color: var(--neon-orange);
            box-shadow: var(--border-glow);
        }
        
        .whats-new-btn:hover {
            background: linear-gradient(135deg, var(--neon-orange) 0%, var(--neon-red) 100%);
            color: #000;
            box-shadow: 0 0 40px var(--neon-orange), 0 0 80px var(--neon-red);
        }
        
        /* Controller Status Indicator */
        .controller-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: var(--neon-green);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            border: 1px solid var(--neon-green);
            z-index: 1000;
            display: none;
            outline: var(--black-outline);
        }
        
        /* iPad Mode Indicator */
        .ipad-mode-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: var(--neon-blue);
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            border: 2px solid var(--neon-blue);
            z-index: 1000;
            display: none;
            text-align: center;
            outline: var(--black-outline);
        }
        
        /* Updated Settings */
        .settings-value {
            min-width: 60px;
            text-align: center;
        }
        
        /* NEW: Achievement Menu */
        .achievement-item {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--neon-blue);
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            outline: var(--black-outline);
        }
        
        .achievement-item.locked {
            border-color: #666;
            opacity: 0.7;
        }
        
        .achievement-item.unlocked {
            border-color: var(--neon-yellow);
            box-shadow: 0 0 20px var(--neon-yellow);
        }
        
        .achievement-item-icon {
            font-size: 2em;
            margin-right: 15px;
            width: 60px;
            text-align: center;
        }
        
        .achievement-item-content {
            flex: 1;
        }
        
        .achievement-item-title {
            color: var(--neon-blue);
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .achievement-item.locked .achievement-item-title {
            color: #666;
        }
        
        .achievement-item-desc {
            color: var(--neon-green);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .achievement-item.locked .achievement-item-desc {
            color: #888;
        }
        
        .achievement-item-progress {
            color: var(--neon-pink);
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* NEW: Sound Library */
        .sound-item {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--neon-purple);
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            outline: var(--black-outline);
        }
        
        .sound-item:hover {
            border-color: var(--neon-pink);
            transform: translateY(-2px);
        }
        
        .sound-item.active {
            border-color: var(--neon-green);
            background: rgba(0,255,0,0.1);
        }
        
        .sound-item-preview {
            width: 50px;
            height: 50px;
            margin: 0 auto 10px;
            background: rgba(0,0,0,0.5);
            border: 2px solid currentColor;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        /* NEW: Level Rating */
        .rating-stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }
        
        .rating-star {
            font-size: 2em;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .rating-star:hover {
            transform: scale(1.2);
        }
        
        .rating-star.active {
            color: var(--neon-yellow);
            text-shadow: 0 0 10px var(--neon-yellow);
        }
        
        /* NEW: Game Modes */
        .game-mode-item {
            background: rgba(0,0,0,0.7);
            border: 2px solid var(--neon-blue);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            outline: var(--black-outline);
        }
        
        .game-mode-item:hover {
            border-color: var(--neon-green);
            transform: translateY(-5px);
            box-shadow: 0 0 30px var(--neon-green);
        }
        
        .game-mode-item.active {
            border-color: var(--neon-yellow);
            background: rgba(255,255,0,0.1);
        }
        
        .game-mode-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .game-mode-difficulty {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .difficulty-easy { background: var(--neon-green); color: #000; }
        .difficulty-medium { background: var(--neon-yellow); color: #000; }
        .difficulty-hard { background: var(--neon-orange); color: #000; }
        .difficulty-insane { background: var(--neon-red); color: #fff; }
        
        /* NEW: Controller Layout Display */
        .controller-layout {
            background: rgba(0,0,0,0.9);
            border: 3px solid var(--neon-blue);
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 0 40px var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .controller-button {
            display: inline-block;
            width: 70px;
            height: 70px;
            background: rgba(0,0,0,0.8);
            border: 3px solid var(--neon-blue);
            border-radius: 50%;
            margin: 10px;
            font-weight: bold;
            font-size: 1.2em;
            line-height: 70px;
            text-align: center;
            color: var(--neon-blue);
            box-shadow: 0 0 20px var(--neon-blue);
            outline: var(--black-outline);
        }
        
        .controller-button.active {
            background: var(--neon-blue);
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <h2 style="color: var(--neon-blue);">Loading NEON DASH...</h2>
        <p style="color: var(--neon-green); margin-top: 10px;" id="loading-text">Optimizing for your device...</p>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- Performance Indicator -->
    <div class="performance-indicator" id="performance-indicator">Performance: High</div>
    
    <!-- iPad Mode Indicator -->
    <div class="ipad-mode-indicator" id="ipad-mode-indicator">üì± iPad Mode Active</div>
    
    <!-- Controller Status -->
    <div class="controller-status" id="controller-status">üéÆ Controller Connected</div>

    <!-- Editor Coin Counter -->
    <div class="editor-coin-counter" id="editor-coin-counter">Coins: 0/15</div>
    
    <!-- Editor Crosshair -->
    <div class="editor-crosshair" id="editor-crosshair">
        <div class="crosshair-horizontal"></div>
        <div class="crosshair-vertical"></div>
    </div>
    
    <!-- Time Trial Display -->
    <div class="time-trial-display" id="time-trial-display">
        <div id="time-trial-timer">00:00.00</div>
        <div class="time-trial-best" id="time-trial-best">Best: --:--.--</div>
    </div>
    
    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <div class="achievement-icon" id="achievement-icon">üèÜ</div>
        <div class="achievement-title" id="achievement-title">Achievement Unlocked!</div>
        <div class="achievement-desc" id="achievement-desc">Complete the first level</div>
        <div class="achievement-progress">
            <div class="achievement-progress-bar" id="achievement-progress-bar"></div>
        </div>
    </div>

    <div id="hud">
        <div class="hud-stats">
            Att: <span id="att">1</span><br>
            Coins: <span id="coin-count-val">0</span>
        </div>
        <div class="hud-progress">
            <span id="progress-percent">0%</span>
        </div>
        <div id="prog-bar"><div id="prog"></div></div>
        <div id="msg">CUBE</div>
        <div id="tutorial-msg" style="display:none;"></div>
    </div>
    
    <!-- Main Menu -->
    <div id="menu-main" class="ui-layer visible">
        <div class="menu-box">
            <h1>OFFICIAL GAME OF SALVADO</h1>
            <h1>NEON DASH</h1>
            <p style="font-size: 1.2em; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">Levels unlocked: <span id="unlock-count">1</span>/50</p>
            <p style="font-size: 1.3em; color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow);">Coins: <span id="menu-coins">0</span> üí∞</p>
            <p style="font-size: 1.1em; color: var(--neon-pink); margin: 10px 0;">Achievements: <span id="menu-achievements">0/50</span> üèÜ</p>
            <button onclick="UI.startPlay()" class="green">PLAY</button>
            <button class="pink" onclick="UI.showShop()">CUSTOMIZE</button>
            <button class="pink" onclick="UI.showEditor()">LEVEL EDITOR</button>
            <button onclick="UI.showSettings()">SETTINGS</button>
            <button class="whats-new-btn" onclick="UI.showWhatsNew()">WHAT'S NEW?</button>
            <button class="yellow" onclick="UI.showAchievements()">ACHIEVEMENTS üèÜ</button>
            <button onclick="UI.showGameModes()">GAME MODES</button>
            <button onclick="UI.showSaveSystem()">SAVE/LOAD</button>
            <button onclick="UI.showLeaderboard()">LEADERBOARDS</button>
            <button onclick="UI.showSoundLibrary()">SOUND LIBRARY</button>
            <button onclick="UI.showControllerLayout()">CONTROLLER LAYOUT</button>
        </div>
    </div>

    <!-- Levels Menu -->
    <div id="menu-levels" class="ui-layer hidden">
        <div class="menu-box">
            <h2>SELECT LEVEL</h2>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0;">
                <button id="level-prev" onclick="UI.changeLevelPage(-1)">‚Üê</button>
                <div id="lvl-grid"></div>
                <button id="level-next" onclick="UI.changeLevelPage(1)">‚Üí</button>
            </div>
            <div id="level-rating" style="margin: 20px 0; display: none;">
                <h3 style="color: var(--neon-yellow);">Rate This Level</h3>
                <div class="rating-stars" id="rating-stars">
                    <span class="rating-star" data-value="1">‚òÖ</span>
                    <span class="rating-star" data-value="2">‚òÖ</span>
                    <span class="rating-star" data-value="3">‚òÖ</span>
                    <span class="rating-star" data-value="4">‚òÖ</span>
                    <span class="rating-star" data-value="5">‚òÖ</span>
                </div>
                <div id="level-rating-average" style="color: var(--neon-green); margin-top: 10px;"></div>
            </div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Shop Menu -->
    <div id="menu-shop" class="ui-layer hidden">
        <div class="menu-box">
            <h2>CUSTOMIZE</h2>
            <p style="font-size: 1.3em; color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow);">Your Coins: <span id="shop-coins">0</span> üí∞</p>
            <div id="shop-content"></div>
            <button id="shop-back-btn" onclick="UI.home()">BACK</button>
        </div>
    </div>

    <!-- Pause Menu -->
    <div id="menu-pause" class="ui-layer hidden">
        <div class="menu-box">
            <h2 id="pause-title">PAUSED</h2>
            <p id="pause-p" style="color: var(--neon-yellow);">Press R to Retry</p>
            <button id="pause-main-btn" onclick="Game.retry()">RETRY (Y Button)</button>
            <button class="pink" onclick="UI.home()">RETURN TO MENU</button>
            <button class="yellow" onclick="UI.showSaveSystem()">SAVE GAME</button>
            <button onclick="Achievements.showCurrentProgress()">VIEW ACHIEVEMENTS</button>
        </div>
    </div>

    <!-- Editor Menu -->
    <div id="menu-editor" class="ui-layer hidden">
        <div class="menu-box">
            <h2>LEVEL EDITOR</h2>
            <p style="color: var(--neon-yellow);">Create your own levels!</p>
            <button onclick="LevelEditor.startNew()" class="green">NEW LEVEL</button>
            <button onclick="LevelEditor.load()" class="pink">LOAD LEVEL</button>
            <button onclick="LevelEditor.showCloudLevels()">CLOUD LEVELS</button>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Settings Menu -->
    <div id="menu-settings" class="ui-layer hidden">
        <div class="menu-box">
            <h2>SETTINGS</h2>
            
            <div class="settings-group">
                <h3>Graphics</h3>
                <div class="settings-item">
                    <span class="settings-label">Quality:</span>
                    <select id="quality-select" style="background: rgba(0,0,0,0.7); color: var(--neon-blue); border: 2px solid var(--neon-blue); padding: 5px; border-radius: 5px; outline: var(--black-outline);">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high" selected>High</option>
                    </select>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Particle Effects:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="particles-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Screen Shake:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="screenshake-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">iPad Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="ipad-mode-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3>Audio</h3>
                <div class="settings-item">
                    <span class="settings-label">Master Volume:</span>
                    <span class="settings-value" id="volume-value">70%</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="70" class="slider" id="volume-slider">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Sound Effects:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sfx-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Enable Background Music:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="music-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Music Volume:</span>
                    <span class="settings-value" id="music-volume-value">50%</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="0" max="100" value="50" class="slider" id="music-volume-slider">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Sound Pack:</span>
                    <select id="sound-pack-select" style="background: rgba(0,0,0,0.7); color: var(--neon-purple); border: 2px solid var(--neon-purple); padding: 5px; border-radius: 5px; outline: var(--black-outline);">
                        <option value="default">Default</option>
                        <option value="retro">Retro</option>
                        <option value="synth">Synthwave</option>
                        <option value="chiptune">Chiptune</option>
                    </select>
                </div>
            </div>

            <div class="settings-group">
                <h3>Gameplay</h3>
                <div class="settings-item">
                    <span class="settings-label">Mobile Optimization:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="mobile-opt-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Show FPS:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="fps-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Controller Vibration:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="vibration-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Auto Retry:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-retry-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Time Trial Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="time-trial-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3>Controls</h3>
                <div class="settings-item">
                    <span class="settings-label">Touch Sensitivity:</span>
                    <span class="settings-value" id="sensitivity-value">Medium</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="1" max="3" value="2" class="slider" id="sensitivity-slider">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Enable Controller:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="controller-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Controller Deadzone:</span>
                    <span class="settings-value" id="deadzone-value">8%</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="1" max="20" value="8" class="slider" id="deadzone-slider">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Controller Sensitivity:</span>
                    <span class="settings-value" id="controller-sensitivity-value">0.3</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="1" max="100" value="30" class="slider" id="controller-sensitivity-slider">
                </div>
            </div>

            <div class="settings-group">
                <h3>Accessibility</h3>
                <div class="settings-item">
                    <span class="settings-label">High Contrast Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="high-contrast-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Large Text:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="large-text-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Color Blind Mode:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="colorblind-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Reduced Motion:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="reduced-motion-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3>Display</h3>
                <div class="settings-item">
                    <span class="settings-label">UI Scale:</span>
                    <span class="settings-value" id="ui-scale-value">100%</span>
                </div>
                <div class="slider-container">
                    <input type="range" min="80" max="120" value="100" class="slider" id="ui-scale-slider">
                </div>
                <div class="settings-item">
                    <span class="settings-label">Show Timer:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timer-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <span class="settings-label">Show Button Borders:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="button-borders-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <button onclick="UI.saveSettings()" class="green">SAVE SETTINGS</button>
            <button onclick="UI.resetToDefaults()" class="red">RESET TO DEFAULTS</button>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- What's New Menu -->
    <div id="menu-whatsnew" class="ui-layer hidden">
        <div class="menu-box">
            <h2>WHAT'S NEW</h2>
            <div style="text-align: left; max-width: 600px; margin: 20px auto;">
                <h3 style="color: var(--neon-green);">Update v2.0 - Ultimate Edition</h3>
                <ul style="color: var(--neon-blue); font-size: 1.1em; line-height: 1.6;">
                    <li><strong>üèÜ Achievement System:</strong> 50+ achievements to unlock with progress tracking</li>
                    <li><strong>üíæ Enhanced Save System:</strong> Multiple save slots with cloud backup</li>
                    <li><strong>üèÜ Leaderboards:</strong> Global and friend leaderboards for all levels</li>
                    <li><strong>‚è±Ô∏è Time Trial Mode:</strong> Race against the clock with best time tracking</li>
                    <li><strong>üéÆ Advanced Controller Support:</strong> Full button mapping with improved sensitivity</li>
                    <li><strong>üé® Editor Crosshair:</strong> Precision editing with controller support</li>
                    <li><strong>üåü Level Rating System:</strong> Rate and review community levels</li>
                    <li><strong>üéµ Sound Library:</strong> Multiple sound packs to choose from</li>
                    <li><strong>‚ôø Accessibility Features:</strong> High contrast, large text, color blind modes</li>
                    <li><strong>üéØ Multiple Game Modes:</strong> Endless, Challenge, Practice modes</li>
                    <li><strong>üìä Enhanced Statistics:</strong> Detailed gameplay analytics</li>
                    <li><strong>‚ú® Visual Improvements:</strong> Better particles, effects, and UI borders</li>
                    <li><strong>üîß Performance Optimizations:</strong> Even smoother gameplay on all devices</li>
                </ul>
                <p style="color: var(--neon-yellow); margin-top: 20px; font-size: 1.2em;">
                    Enjoy the ultimate Neon Dash experience!
                </p>
            </div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Achievement Menu -->
    <div id="menu-achievements" class="ui-layer hidden">
        <div class="menu-box">
            <h2>ACHIEVEMENTS üèÜ</h2>
            <p style="color: var(--neon-yellow); font-size: 1.2em; margin-bottom: 20px;">
                Progress: <span id="achievements-progress">0/50</span> (<span id="achievements-percentage">0%</span>)
            </p>
            <div id="achievements-list" style="max-height: 400px; overflow-y: auto; padding: 10px;"></div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Save System Menu -->
    <div id="menu-savesystem" class="ui-layer hidden">
        <div class="menu-box">
            <h2>SAVE & LOAD</h2>
            <div class="save-system">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="SaveSystem.saveGame(1)" class="green">SAVE TO SLOT 1</button>
                    <button onclick="SaveSystem.saveGame(2)" class="green">SAVE TO SLOT 2</button>
                    <button onclick="SaveSystem.saveGame(3)" class="green">SAVE TO SLOT 3</button>
                </div>
                <div id="save-slots"></div>
                <div style="margin-top: 20px;">
                    <button onclick="SaveSystem.exportSave()" class="yellow">EXPORT SAVE DATA</button>
                    <button onclick="SaveSystem.importSave()" class="yellow">IMPORT SAVE DATA</button>
                    <button onclick="SaveSystem.cloudBackup()" class="pink">CLOUD BACKUP</button>
                    <button onclick="SaveSystem.cloudRestore()" class="pink">CLOUD RESTORE</button>
                </div>
            </div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Leaderboard Menu -->
    <div id="menu-leaderboard" class="ui-layer hidden">
        <div class="menu-box">
            <h2>LEADERBOARDS</h2>
            <div style="margin: 20px 0;">
                <select id="leaderboard-type" style="background: rgba(0,0,0,0.7); color: var(--neon-purple); border: 2px solid var(--neon-purple); padding: 10px; border-radius: 10px; font-size: 1.1em; outline: var(--black-outline);">
                    <option value="level">Level Completion</option>
                    <option value="time">Best Times</option>
                    <option value="coins">Most Coins</option>
                    <option value="achievements">Achievements</option>
                </select>
                <select id="leaderboard-level" style="background: rgba(0,0,0,0.7); color: var(--neon-blue); border: 2px solid var(--neon-blue); padding: 10px; border-radius: 10px; font-size: 1.1em; margin-left: 10px; outline: var(--black-outline);">
                    <option value="global">Global</option>
                    <option value="friends">Friends</option>
                </select>
            </div>
            <div class="leaderboard" id="leaderboard-content"></div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Sound Library Menu -->
    <div id="menu-soundlibrary" class="ui-layer hidden">
        <div class="menu-box">
            <h2>SOUND LIBRARY</h2>
            <p style="color: var(--neon-yellow); margin-bottom: 20px;">Choose your sound pack</p>
            <div id="sound-library-content" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
            <div style="margin-top: 30px;">
                <button onclick="SoundLibrary.testSounds()" class="yellow">TEST SOUNDS</button>
                <button onclick="UI.home()">BACK TO MENU</button>
            </div>
        </div>
    </div>

    <!-- Game Modes Menu -->
    <div id="menu-gamemodes" class="ui-layer hidden">
        <div class="menu-box">
            <h2>GAME MODES</h2>
            <div id="game-modes-content">
                <!-- Game modes will be loaded here -->
            </div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <!-- Controller Layout Menu -->
    <div id="menu-controllerlayout" class="ui-layer hidden">
        <div class="menu-box">
            <h2>CONTROLLER LAYOUT</h2>
            <div class="controller-layout">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px;">
                    <div class="controller-button" id="controller-button-a">A</div>
                    <div class="controller-button" id="controller-button-b">B</div>
                    <div class="controller-button" id="controller-button-x">X</div>
                    <div class="controller-button" id="controller-button-y">Y</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 30px;">
                    <div class="controller-button" id="controller-button-lb">LB</div>
                    <div class="controller-button" id="controller-button-rb">RB</div>
                    <div class="controller-button" id="controller-button-lt">LT</div>
                    <div class="controller-button" id="controller-button-rt">RT</div>
                </div>
                <div style="margin-bottom: 30px;">
                    <div style="color: var(--neon-blue); margin-bottom: 10px;">D-Pad</div>
                    <div style="display: inline-block; position: relative; width: 150px; height: 150px;">
                        <div class="controller-button" style="position: absolute; top: 0; left: 50px;">‚Üë</div>
                        <div class="controller-button" style="position: absolute; bottom: 0; left: 50px;">‚Üì</div>
                        <div class="controller-button" style="position: absolute; top: 50px; left: 0;">‚Üê</div>
                        <div class="controller-button" style="position: absolute; top: 50px; right: 0;">‚Üí</div>
                    </div>
                </div>
                <div style="color: var(--neon-green); font-size: 1.1em; line-height: 1.6; text-align: left;">
                    <p><strong>Game Controls:</strong></p>
                    <p>üÖ∞Ô∏è - Jump/Hold to Jump</p>
                    <p>üÖ±Ô∏è - Dash/Special Action</p>
                    <p>‚ùå - Test Level (Editor)</p>
                    <p>üéÆ - Retry</p>
                    <p>üì± - Menu/Back</p>
                    <p>D-Pad - Navigate/Move Crosshair</p>
                    <p>LB/RB - Switch Blocks (Editor)</p>
                    <p>LT/RT - Place/Destroy (Editor)</p>
                </div>
            </div>
            <button onclick="UI.home()">BACK TO MENU</button>
        </div>
    </div>

    <div id="game-container">
        <div id="mobile-controls">
            <button class="mobile-btn" 
                ontouchstart="Input.touchStartAction(event)" 
                ontouchend="Input.touchEndAction(event)"
                oncontextmenu="return false;">
                ‚¨ÜÔ∏è
            </button>
        </div>
    </div>

    <!-- Level Editor Tools -->
    <div id="editor-tools">
        <!-- Editor tools will be populated by JavaScript -->
    </div>

    <!-- Screen Transition Overlay -->
    <div id="screen-transition" class="screen-transition"></div>

<script>
// --- CONFIG & GLOBALS ---
const CFG = {
    tile: 50,
    spd: 8.5,
    jmp: 27,
    g: 0.9,
    term: 20,
    START_X: 6,
    maxHeight: -400,
    PAD_JUMP: 85,
    DASH_DIST: 200,
    DASH_COLOR: '#ff0000',
    SLOW_FACTOR: 0.5,
    SLOW_DURATION: 1000,
    MINI_SCALE: 0.6,
    MACRO_SCALE: 1.0,
    TOTAL_LEVELS: 50,
    LEVELS_PER_PAGE: 10,
    SPIKE_HEIGHT: 8,
    FLYING_SPIKE_ZONE: 8 * 50,
    GRAVITY_BLOCK_HEIGHT: 150,
    EDITOR_COIN_LIMIT: 15
};

// Game state
let unlocked = parseInt(localStorage.getItem('nd_level') || 1);
let totalCoins = parseInt(localStorage.getItem('nd_coins') || 0);
let equippedSkinIndex = parseInt(localStorage.getItem('nd_equipped_skin') || 0);
let unlockedSkins = JSON.parse(localStorage.getItem('nd_skins') || '[0]');
let tutorialDone = localStorage.getItem('nd_tutorial_done') === 'true';
let currentPage = 1;

// Enhanced settings with defaults
let settings = JSON.parse(localStorage.getItem('nd_settings') || '{}');
if (!settings.graphics) settings.graphics = { 
    quality: 'high', 
    particles: true, 
    screenshake: true, 
    ipadMode: false 
};
if (!settings.audio) settings.audio = { 
    volume: 70, 
    sfx: true, 
    music: true, 
    musicVolume: 50,
    soundPack: 'default'
};
if (!settings.gameplay) settings.gameplay = { 
    mobileOpt: true, 
    showFPS: false, 
    vibration: true, 
    autoRetry: false,
    timeTrial: false
};
if (!settings.controls) settings.controls = { 
    sensitivity: 2, 
    controller: true, 
    deadzone: 8, // Lower default deadzone
    controllerSensitivity: 0.3 // Lower default sensitivity
};
if (!settings.display) settings.display = { 
    uiScale: 100, 
    showTimer: false, 
    colorblind: false,
    buttonBorders: true,
    highContrast: false,
    largeText: false,
    reducedMotion: false
};
if (!settings.saveSystem) settings.saveSystem = {
    autoSave: true,
    cloudBackup: false,
    saveSlots: [{}, {}, {}]
};

// Apply button borders immediately
if (settings.display.buttonBorders) {
    document.documentElement.style.setProperty('--black-outline', '2px solid #000');
} else {
    document.documentElement.style.setProperty('--black-outline', 'none');
}

const THEMES = [
    ['C4', 200, 100],
    ['A4', 120, 90],
    ['F4', 300, 90],
    ['D4', 40, 95],
    ['G4', 0, 90]
];

const SKINS = [
    { name: 'Neon Blue', main: '#00ffff', secondary: '#ff0088', cost: 0 },
    { name: 'Matrix Green', main: '#33ff00', secondary: '#ff8800', cost: 50 },
    { name: 'Lava', main: '#ff4d00', secondary: '#ffff00', cost: 100 },
    { name: 'Royal Purple', main: '#d000ff', secondary: '#ff00d0', cost: 150 },
    { name: 'Dark Ops', main: '#333333', secondary: '#ffffff', cost: 200 },
    { name: 'Season 1 Special', main: '#ff00ff', secondary: '#00ffff', cost: 400 }
];

// --- ACHIEVEMENT SYSTEM ---
const Achievements = {
    list: [
        { id: 'first_jump', name: 'First Jump', desc: 'Make your first jump', icon: 'ü¶ò', points: 10, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'first_coin', name: 'Coin Collector', desc: 'Collect your first coin', icon: 'üí∞', points: 15, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'first_level', name: 'Getting Started', desc: 'Complete Level 1', icon: 'üöÄ', points: 20, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'five_levels', name: 'Level Master', desc: 'Complete 5 levels', icon: 'üéØ', points: 50, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'ten_coins', name: 'Rich Gamer', desc: 'Collect 10 coins', icon: 'üíé', points: 30, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'fifty_jumps', name: 'Bouncy', desc: 'Perform 50 jumps', icon: '‚öΩ', points: 25, unlocked: false, progress: 0, maxProgress: 50 },
        { id: 'no_death', name: 'Perfect Run', desc: 'Complete a level without dying', icon: 'üëë', points: 100, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'all_coins', name: 'Completionist', desc: 'Collect all coins in a level', icon: 'üèÜ', points: 75, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'dash_master', name: 'Speed Demon', desc: 'Use dash 10 times', icon: '‚ö°', points: 40, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'mode_changer', name: 'Versatile', desc: 'Use all character modes', icon: 'üîÑ', points: 60, unlocked: false, progress: 0, maxProgress: 6 },
        { id: 'checkpoint_saver', name: 'Safety First', desc: 'Use 5 checkpoints', icon: 'üíæ', points: 35, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'skin_collector', name: 'Fashionista', desc: 'Unlock 3 skins', icon: 'üëï', points: 45, unlocked: false, progress: 0, maxProgress: 3 },
        { id: 'fast_runner', name: 'Speedrun', desc: 'Complete a level in under 30 seconds', icon: '‚è±Ô∏è', points: 80, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'chain_jumper', name: 'Air Time', desc: 'Perform 5 jumps in a row without touching ground', icon: 'ü™Ω', points: 55, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'editor_master', name: 'Creator', desc: 'Create a level in editor', icon: 'üõ†Ô∏è', points: 70, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'gravity_defier', name: 'Upside Down', desc: 'Complete a level with reversed gravity', icon: 'üåÄ', points: 90, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'wave_rider', name: 'Wave Master', desc: 'Travel 500 units in wave mode', icon: 'üåä', points: 65, unlocked: false, progress: 0, maxProgress: 500 },
        { id: 'ship_pilot', name: 'Space Explorer', desc: 'Travel 1000 units in ship mode', icon: 'üöÄ', points: 85, unlocked: false, progress: 0, maxProgress: 1000 },
        { id: 'ufo_expert', name: 'Alien Tech', desc: 'Travel 800 units in UFO mode', icon: 'üëΩ', points: 75, unlocked: false, progress: 0, maxProgress: 800 },
        { id: 'robot_walker', name: 'Robotic', desc: 'Travel 600 units in robot mode', icon: 'ü§ñ', points: 70, unlocked: false, progress: 0, maxProgress: 600 },
        { id: 'swing_king', name: 'Tarzan', desc: 'Use swing mode 10 times', icon: 'ü¶ç', points: 60, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'mini_macro', name: 'Size Changer', desc: 'Use both mini and macro modes', icon: 'üìè', points: 45, unlocked: false, progress: 0, maxProgress: 2 },
        { id: 'slow_mo', name: 'Matrix', desc: 'Use slow motion 5 times', icon: 'üêå', points: 40, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'spike_dodger', name: 'Ninja', desc: 'Dodge 20 spikes', icon: 'üó°Ô∏è', points: 50, unlocked: false, progress: 0, maxProgress: 20 },
        { id: 'pad_jumper', name: 'Trampoline', desc: 'Use 10 jump pads', icon: 'ü¶ò', points: 35, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'portal_traveler', name: 'Portal Master', desc: 'Go through 15 portals', icon: 'üåÄ', points: 55, unlocked: false, progress: 0, maxProgress: 15 },
        { id: 'level_10', name: 'Decade', desc: 'Complete Level 10', icon: 'üîü', points: 100, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'level_25', name: 'Quarter Century', desc: 'Complete Level 25', icon: '2Ô∏è‚É£5Ô∏è‚É£', points: 250, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'level_50', name: 'Golden Master', desc: 'Complete all 50 levels', icon: '5Ô∏è‚É£0Ô∏è‚É£', points: 500, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'coin_100', name: 'Century', desc: 'Collect 100 coins', icon: 'üíØ', points: 150, unlocked: false, progress: 0, maxProgress: 100 },
        { id: 'coin_500', name: 'Half Thousand', desc: 'Collect 500 coins', icon: '5Ô∏è‚É£0Ô∏è‚É£0Ô∏è‚É£', points: 300, unlocked: false, progress: 0, maxProgress: 500 },
        { id: 'coin_1000', name: 'Millennium', desc: 'Collect 1000 coins', icon: '1Ô∏è‚É£0Ô∏è‚É£0Ô∏è‚É£0Ô∏è‚É£', points: 500, unlocked: false, progress: 0, maxProgress: 1000 },
        { id: 'attempt_100', name: 'Persistent', desc: 'Make 100 attempts', icon: 'üí™', points: 75, unlocked: false, progress: 0, maxProgress: 100 },
        { id: 'attempt_500', name: 'Determined', desc: 'Make 500 attempts', icon: 'üî•', points: 150, unlocked: false, progress: 0, maxProgress: 500 },
        { id: 'attempt_1000', name: 'Unstoppable', desc: 'Make 1000 attempts', icon: '‚ö°', points: 250, unlocked: false, progress: 0, maxProgress: 1000 },
        { id: 'time_1h', name: 'Hour Played', desc: 'Play for 1 hour', icon: '‚è∞', points: 100, unlocked: false, progress: 0, maxProgress: 3600 },
        { id: 'time_5h', name: 'Marathon', desc: 'Play for 5 hours', icon: 'üèÉ', points: 200, unlocked: false, progress: 0, maxProgress: 18000 },
        { id: 'time_10h', name: 'Veteran', desc: 'Play for 10 hours', icon: 'üéñÔ∏è', points: 300, unlocked: false, progress: 0, maxProgress: 36000 },
        { id: 'shop_spender', name: 'Big Spender', desc: 'Spend 1000 coins in shop', icon: 'üí∏', points: 200, unlocked: false, progress: 0, maxProgress: 1000 },
        { id: 'all_skins', name: 'Fashion King', desc: 'Unlock all skins', icon: 'üëë', points: 400, unlocked: false, progress: 0, maxProgress: SKINS.length },
        { id: 'editor_10', name: 'Prolific Creator', desc: 'Create 10 levels', icon: 'üé®', points: 300, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'rating_giver', name: 'Critic', desc: 'Rate 5 levels', icon: '‚≠ê', points: 75, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'leaderboard_top', name: 'Champion', desc: 'Reach top 10 in any leaderboard', icon: 'üèÖ', points: 200, unlocked: false, progress: 0, maxProgress: 1 },
        { id: 'time_trial', name: 'Speedster', desc: 'Complete 5 time trials', icon: '‚ö°', points: 150, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'endless_500', name: 'Endless Runner', desc: 'Score 500 in endless mode', icon: '‚àû', points: 175, unlocked: false, progress: 0, maxProgress: 500 },
        { id: 'challenge_complete', name: 'Challenge Accepted', desc: 'Complete 10 challenges', icon: 'üéØ', points: 225, unlocked: false, progress: 0, maxProgress: 10 },
        { id: 'practice_master', name: 'Practiced', desc: 'Use practice mode 5 times', icon: 'üìö', points: 100, unlocked: false, progress: 0, maxProgress: 5 },
        { id: 'controller_user', name: 'Pro Gamer', desc: 'Play with controller for 1 hour', icon: 'üéÆ', points: 125, unlocked: false, progress: 0, maxProgress: 3600 },
        { id: 'mobile_user', name: 'On the Go', desc: 'Play on mobile for 30 minutes', icon: 'üì±', points: 100, unlocked: false, progress: 0, maxProgress: 1800 },
        { id: 'secret_finder', name: 'Explorer', desc: 'Find a secret area', icon: 'üóùÔ∏è', points: 500, unlocked: false, progress: 0, maxProgress: 1 }
    ],
    
    stats: {
        totalJumps: 0,
        totalCoins: 0,
        totalDeaths: 0,
        totalDistance: 0,
        totalTime: 0,
        levelsCompleted: 0,
        dashUses: 0,
        modeChanges: 0,
        checkpointsUsed: 0,
        spikesDodged: 0,
        padsUsed: 0,
        portalsUsed: 0
    },
    
    init: function() {
        // Load achievements from localStorage
        const saved = localStorage.getItem('nd_achievements');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.list = data.list || this.list;
                this.stats = data.stats || this.stats;
            } catch(e) {
                console.warn("Failed to load achievements:", e);
            }
        }
        
        // Update achievement progress
        this.updateProgress();
    },
    
    updateProgress: function() {
        // Update achievement progress based on stats
        this.list.forEach(ach => {
            switch(ach.id) {
                case 'first_jump':
                    ach.progress = this.stats.totalJumps > 0 ? 1 : 0;
                    break;
                case 'first_coin':
                    ach.progress = this.stats.totalCoins > 0 ? 1 : 0;
                    break;
                case 'five_levels':
                    ach.progress = Math.min(this.stats.levelsCompleted, 5);
                    break;
                case 'ten_coins':
                    ach.progress = Math.min(this.stats.totalCoins, 10);
                    break;
                case 'fifty_jumps':
                    ach.progress = Math.min(this.stats.totalJumps, 50);
                    break;
                case 'dash_master':
                    ach.progress = Math.min(this.stats.dashUses, 10);
                    break;
                case 'mode_changer':
                    ach.progress = Math.min(this.stats.modeChanges, 6);
                    break;
                case 'checkpoint_saver':
                    ach.progress = Math.min(this.stats.checkpointsUsed, 5);
                    break;
                case 'skin_collector':
                    ach.progress = Math.min(unlockedSkins.length, 3);
                    break;
                case 'wave_rider':
                    ach.progress = Math.min(this.stats.totalDistance, 500);
                    break;
                case 'ship_pilot':
                    ach.progress = Math.min(this.stats.totalDistance, 1000);
                    break;
                case 'ufo_expert':
                    ach.progress = Math.min(this.stats.totalDistance, 800);
                    break;
                case 'robot_walker':
                    ach.progress = Math.min(this.stats.totalDistance, 600);
                    break;
                case 'swing_king':
                    ach.progress = Math.min(this.stats.modeChanges, 10);
                    break;
                case 'spike_dodger':
                    ach.progress = Math.min(this.stats.spikesDodged, 20);
                    break;
                case 'pad_jumper':
                    ach.progress = Math.min(this.stats.padsUsed, 10);
                    break;
                case 'portal_traveler':
                    ach.progress = Math.min(this.stats.portalsUsed, 15);
                    break;
                case 'coin_100':
                    ach.progress = Math.min(this.stats.totalCoins, 100);
                    break;
                case 'coin_500':
                    ach.progress = Math.min(this.stats.totalCoins, 500);
                    break;
                case 'coin_1000':
                    ach.progress = Math.min(this.stats.totalCoins, 1000);
                    break;
                case 'attempt_100':
                    ach.progress = Math.min(this.stats.totalDeaths, 100);
                    break;
                case 'attempt_500':
                    ach.progress = Math.min(this.stats.totalDeaths, 500);
                    break;
                case 'attempt_1000':
                    ach.progress = Math.min(this.stats.totalDeaths, 1000);
                    break;
                case 'time_1h':
                    ach.progress = Math.min(this.stats.totalTime, 3600);
                    break;
                case 'time_5h':
                    ach.progress = Math.min(this.stats.totalTime, 18000);
                    break;
                case 'time_10h':
                    ach.progress = Math.min(this.stats.totalTime, 36000);
                    break;
                case 'shop_spender':
                    ach.progress = Math.min(totalCoins, 1000);
                    break;
                case 'all_skins':
                    ach.progress = Math.min(unlockedSkins.length, SKINS.length);
                    break;
            }
            
            // Check if achievement is unlocked
            if (!ach.unlocked && ach.progress >= ach.maxProgress) {
                this.unlock(ach.id);
            }
        });
        
        this.save();
        this.updateDisplay();
    },
    
    unlock: function(achievementId) {
        const ach = this.list.find(a => a.id === achievementId);
        if (ach && !ach.unlocked) {
            ach.unlocked = true;
            ach.unlockedAt = Date.now();
            
            // Show popup
            this.showPopup(ach);
            
            // Award points/coins
            totalCoins += ach.points;
            Game.updateCoinDisplay();
            
            // Save immediately
            this.save();
            
            // Play unlock sound
            if (settings.audio.sfx) {
                AUDIO.playTone(1500, 'sine', 0.5, 0.7);
                AUDIO.playTone(2000, 'sine', 0.5, 0.5);
            }
            
            console.log(`Achievement unlocked: ${ach.name}!`);
        }
    },
    
    showPopup: function(achievement) {
        const popup = document.getElementById('achievement-popup');
        const icon = document.getElementById('achievement-icon');
        const title = document.getElementById('achievement-title');
        const desc = document.getElementById('achievement-desc');
        const progressBar = document.getElementById('achievement-progress-bar');
        
        icon.textContent = achievement.icon;
        title.textContent = achievement.name;
        desc.textContent = achievement.desc;
        progressBar.style.width = '100%';
        
        popup.classList.add('show');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            popup.classList.remove('show');
        }, 5000);
    },
    
    incrementStat: function(stat, amount = 1) {
        if (this.stats[stat] !== undefined) {
            this.stats[stat] += amount;
            this.updateProgress();
        }
    },
    
    save: function() {
        localStorage.setItem('nd_achievements', JSON.stringify({
            list: this.list,
            stats: this.stats
        }));
    },
    
    getUnlockedCount: function() {
        return this.list.filter(a => a.unlocked).length;
    },
    
    getTotalPoints: function() {
        return this.list.filter(a => a.unlocked).reduce((sum, a) => sum + a.points, 0);
    },
    
    updateDisplay: function() {
        const unlockedCount = this.getUnlockedCount();
        const totalCount = this.list.length;
        const percentage = Math.round((unlockedCount / totalCount) * 100);
        
        if (document.getElementById('menu-achievements')) {
            document.getElementById('menu-achievements').textContent = `${unlockedCount}/${totalCount}`;
        }
        
        if (document.getElementById('achievements-progress')) {
            document.getElementById('achievements-progress').textContent = `${unlockedCount}/${totalCount}`;
            document.getElementById('achievements-percentage').textContent = `${percentage}%`;
        }
    },
    
    showCurrentProgress: function() {
        const unlocked = this.getUnlockedCount();
        const total = this.list.length;
        const points = this.getTotalPoints();
        
        Game.showTutorialMessage(`Achievements: ${unlocked}/${total} | Points: ${points}`, 3000);
    },
    
    renderList: function() {
        const container = document.getElementById('achievements-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Sort: unlocked first, then by progress, then by points
        const sorted = [...this.list].sort((a, b) => {
            if (a.unlocked !== b.unlocked) return b.unlocked - a.unlocked;
            if (a.progress !== b.progress) return b.progress - a.progress;
            return b.points - a.points;
        });
        
        sorted.forEach(ach => {
            const item = document.createElement('div');
            item.className = `achievement-item ${ach.unlocked ? 'unlocked' : 'locked'}`;
            
            const progressPercent = Math.round((ach.progress / ach.maxProgress) * 100);
            
            item.innerHTML = `
                <div class="achievement-item-icon">${ach.icon}</div>
                <div class="achievement-item-content">
                    <div class="achievement-item-title">${ach.name}</div>
                    <div class="achievement-item-desc">${ach.desc}</div>
                    <div class="achievement-item-progress">
                        ${ach.unlocked ? '‚úÖ UNLOCKED' : `${progressPercent}% ‚Ä¢ ${ach.progress}/${ach.maxProgress}`}
                    </div>
                </div>
            `;
            
            container.appendChild(item);
        });
    }
};

// --- SAVE SYSTEM ---
const SaveSystem = {
    currentSlot: 1,
    slots: [null, null, null, null, null], // 5 slots
    
    init: function() {
        this.loadSlots();
    },
    
    saveGame: function(slot = this.currentSlot) {
        if (slot < 1 || slot > 5) return;
        
        const saveData = {
            timestamp: Date.now(),
            date: new Date().toISOString(),
            level: Game.currLvlIdx,
            coins: totalCoins,
            unlocked: unlocked,
            skins: unlockedSkins,
            equippedSkin: equippedSkinIndex,
            achievements: Achievements.list.filter(a => a.unlocked).map(a => a.id),
            stats: Achievements.stats,
            playerState: {
                x: Player.x,
                y: Player.y,
                mode: Player.mode,
                scale: Player.scale
            },
            levelState: JSON.parse(JSON.stringify(Game.level)),
            attempts: Game.att,
            checkpoint: Game.currentCheckpoint
        };
        
        this.slots[slot - 1] = saveData;
        localStorage.setItem(`nd_save_slot_${slot}`, JSON.stringify(saveData));
        
        Game.showTutorialMessage(`Game saved to Slot ${slot}!`, 2000);
        
        // Update UI
        this.updateSlotDisplay();
    },
    
    loadGame: function(slot) {
        if (slot < 1 || slot > 5 || !this.slots[slot - 1]) return false;
        
        const saveData = this.slots[slot - 1];
        
        // Load basic data
        Game.currLvlIdx = saveData.level || 0;
        totalCoins = saveData.coins || 0;
        unlocked = saveData.unlocked || 1;
        unlockedSkins = saveData.skins || [0];
        equippedSkinIndex = saveData.equippedSkin || 0;
        
        // Load achievements
        if (saveData.achievements) {
            Achievements.list.forEach(ach => {
                ach.unlocked = saveData.achievements.includes(ach.id);
            });
        }
        
        // Load stats
        if (saveData.stats) {
            Achievements.stats = { ...Achievements.stats, ...saveData.stats };
        }
        
        // Load player state if in game
        if (Game.state === 'game' && saveData.playerState) {
            Player.x = saveData.playerState.x;
            Player.y = saveData.playerState.y;
            Player.mode = saveData.playerState.mode;
            Player.scale = saveData.playerState.scale;
            Player.updateSize(Player.scale);
        }
        
        // Load level state
        if (saveData.levelState) {
            Game.level = JSON.parse(JSON.stringify(saveData.levelState));
        }
        
        // Load checkpoint
        Game.currentCheckpoint = saveData.checkpoint;
        
        // Update displays
        Game.updateCoinDisplay();
        Player.loadColors();
        document.getElementById('unlock-count').innerText = unlocked;
        Achievements.updateDisplay();
        
        Game.showTutorialMessage(`Game loaded from Slot ${slot}!`, 2000);
        
        return true;
    },
    
    loadSlots: function() {
        for (let i = 1; i <= 5; i++) {
            const saved = localStorage.getItem(`nd_save_slot_${i}`);
            if (saved) {
                try {
                    this.slots[i - 1] = JSON.parse(saved);
                } catch(e) {
                    console.warn(`Failed to load save slot ${i}:`, e);
                }
            }
        }
        this.updateSlotDisplay();
    },
    
    updateSlotDisplay: function() {
        const container = document.getElementById('save-slots');
        if (!container) return;
        
        container.innerHTML = '';
        
        this.slots.forEach((slot, index) => {
            const slotNum = index + 1;
            const slotEl = document.createElement('div');
            slotEl.className = 'save-slot';
            if (slot && slot.timestamp === this.slots[this.currentSlot - 1]?.timestamp) {
                slotEl.classList.add('active');
            }
            
            if (slot) {
                const date = new Date(slot.timestamp);
                slotEl.innerHTML = `
                    <div class="save-slot-header">
                        <div class="save-slot-title">Slot ${slotNum}</div>
                        <div class="save-slot-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                    </div>
                    <div class="save-slot-stats">
                        <div>Level: ${(slot.level || 0) + 1}</div>
                        <div>Coins: ${slot.coins || 0}</div>
                        <div>Progress: ${Math.round(((slot.level || 0) + 1) / CFG.TOTAL_LEVELS * 100)}%</div>
                    </div>
                `;
                
                slotEl.onclick = () => {
                    this.currentSlot = slotNum;
                    this.loadGame(slotNum);
                    this.updateSlotDisplay();
                };
            } else {
                slotEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìÅ</div>
                        <div>Empty Slot ${slotNum}</div>
                    </div>
                `;
                
                slotEl.onclick = () => {
                    this.currentSlot = slotNum;
                    this.updateSlotDisplay();
                };
            }
            
            container.appendChild(slotEl);
        });
    },
    
    exportSave: function() {
        const allData = {
            slots: this.slots,
            achievements: Achievements.list,
            stats: Achievements.stats,
            settings: settings,
            version: '2.0'
        };
        
        const dataStr = JSON.stringify(allData);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `neon-dash-save-${Date.now()}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        Game.showTutorialMessage('Save data exported!', 2000);
    },
    
    importSave: function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const imported = JSON.parse(event.target.result);
                    
                    // Validate version
                    if (imported.version !== '2.0') {
                        alert('Invalid save file version. Please export from v2.0 or later.');
                        return;
                    }
                    
                    // Import data
                    if (imported.slots) {
                        imported.slots.forEach((slot, index) => {
                            if (slot) {
                                localStorage.setItem(`nd_save_slot_${index + 1}`, JSON.stringify(slot));
                            }
                        });
                    }
                    
                    if (imported.achievements) {
                        Achievements.list = imported.achievements;
                    }
                    
                    if (imported.stats) {
                        Achievements.stats = imported.stats;
                    }
                    
                    if (imported.settings) {
                        settings = imported.settings;
                        localStorage.setItem('nd_settings', JSON.stringify(settings));
                        Game.loadSettings();
                    }
                    
                    // Reload
                    this.loadSlots();
                    Achievements.save();
                    Achievements.updateDisplay();
                    
                    Game.showTutorialMessage('Save data imported successfully!', 3000);
                } catch(error) {
                    alert('Failed to import save file: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    },
    
    cloudBackup: function() {
        // Simulated cloud backup (in real implementation, this would use a server)
        const backupData = {
            slots: this.slots.filter(slot => slot !== null),
            achievements: Achievements.list,
            stats: Achievements.stats,
            timestamp: Date.now()
        };
        
        localStorage.setItem('nd_cloud_backup', JSON.stringify(backupData));
        
        Game.showTutorialMessage('Cloud backup created!', 2000);
    },
    
    cloudRestore: function() {
        const backup = localStorage.getItem('nd_cloud_backup');
        if (!backup) {
            alert('No cloud backup found!');
            return;
        }
        
        if (confirm('Restore from cloud backup? This will overwrite current save data.')) {
            try {
                const backupData = JSON.parse(backup);
                
                // Restore slots
                backupData.slots.forEach((slot, index) => {
                    if (slot && index < 5) {
                        localStorage.setItem(`nd_save_slot_${index + 1}`, JSON.stringify(slot));
                    }
                });
                
                // Restore achievements
                if (backupData.achievements) {
                    Achievements.list = backupData.achievements;
                }
                
                if (backupData.stats) {
                    Achievements.stats = backupData.stats;
                }
                
                // Reload
                this.loadSlots();
                Achievements.save();
                Achievements.updateDisplay();
                
                Game.showTutorialMessage('Cloud restore completed!', 3000);
            } catch(error) {
                alert('Failed to restore from cloud: ' + error.message);
            }
        }
    },
    
    autoSave: function() {
        if (settings.saveSystem.autoSave && Game.state === 'game') {
            this.saveGame(this.currentSlot);
        }
    }
};

// --- LEADERBOARD SYSTEM ---
const Leaderboard = {
    entries: [],
    
    init: function() {
        this.load();
    },
    
    load: function() {
        const saved = localStorage.getItem('nd_leaderboard');
        if (saved) {
            try {
                this.entries = JSON.parse(saved);
            } catch(e) {
                console.warn("Failed to load leaderboard:", e);
            }
        }
    },
    
    save: function() {
        localStorage.setItem('nd_leaderboard', JSON.stringify(this.entries));
    },
    
    submitScore: function(name, level, score, type = 'level') {
        const entry = {
            name: name || 'Player',
            level: level,
            score: score,
            type: type,
            timestamp: Date.now(),
            date: new Date().toISOString()
        };
        
        this.entries.push(entry);
        
        // Keep only top 100 entries per type
        this.entries = this.entries
            .filter(e => e.type === type)
            .sort((a, b) => b.score - a.score)
            .slice(0, 100);
        
        this.save();
        
        // Check for achievement
        if (this.entries.slice(0, 10).some(e => e.name === (name || 'Player'))) {
            Achievements.unlock('leaderboard_top');
        }
    },
    
    getTopScores: function(type = 'level', limit = 10) {
        return this.entries
            .filter(e => e.type === type)
            .sort((a, b) => b.score - a.score)
            .slice(0, limit);
    },
    
    render: function(type = 'level') {
        const container = document.getElementById('leaderboard-content');
        if (!container) return;
        
        const scores = this.getTopScores(type, 20);
        
        container.innerHTML = '';
        
        if (scores.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No scores yet!</div>';
            return;
        }
        
        scores.forEach((entry, index) => {
            const entryEl = document.createElement('div');
            entryEl.className = 'leaderboard-entry';
            
            let scoreDisplay = '';
            switch(type) {
                case 'level':
                    scoreDisplay = `Level ${entry.level + 1}`;
                    break;
                case 'time':
                    const minutes = Math.floor(entry.score / 60000);
                    const seconds = Math.floor((entry.score % 60000) / 1000);
                    const ms = Math.floor((entry.score % 1000) / 10);
                    scoreDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
                    break;
                case 'coins':
                    scoreDisplay = `${entry.score} coins`;
                    break;
                case 'achievements':
                    scoreDisplay = `${entry.score} points`;
                    break;
            }
            
            entryEl.innerHTML = `
                <div class="leaderboard-rank">#${index + 1}</div>
                <div class="leaderboard-name">${entry.name}</div>
                <div class="leaderboard-score">${scoreDisplay}</div>
            `;
            
            container.appendChild(entryEl);
        });
    }
};

// --- TIME TRIAL SYSTEM ---
const TimeTrial = {
    active: false,
    startTime: 0,
    currentTime: 0,
    bestTime: 0,
    levelTimes: {},
    
    init: function() {
        this.loadTimes();
    },
    
    loadTimes: function() {
        const saved = localStorage.getItem('nd_timetrial');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                this.levelTimes = data.levelTimes || {};
            } catch(e) {
                console.warn("Failed to load time trial data:", e);
            }
        }
    },
    
    saveTimes: function() {
        localStorage.setItem('nd_timetrial', JSON.stringify({
            levelTimes: this.levelTimes
        }));
    },
    
    start: function() {
        if (!settings.gameplay.timeTrial) return;
        
        this.active = true;
        this.startTime = Date.now();
        this.currentTime = 0;
        
        const display = document.getElementById('time-trial-display');
        if (display) {
            display.style.display = 'block';
        }
        
        // Get best time for this level
        this.bestTime = this.levelTimes[Game.currLvlIdx] || 0;
        this.updateDisplay();
    },
    
    stop: function() {
        if (!this.active) return;
        
        this.active = false;
        const endTime = Date.now();
        this.currentTime = endTime - this.startTime;
        
        // Check if this is a new best time
        if (this.bestTime === 0 || this.currentTime < this.bestTime) {
            this.bestTime = this.currentTime;
            this.levelTimes[Game.currLvlIdx] = this.bestTime;
            this.saveTimes();
            
            // Submit to leaderboard
            Leaderboard.submitScore('Player', Game.currLvlIdx, this.bestTime, 'time');
            
            // Show message
            Game.showTutorialMessage('New Best Time!', 3000);
            
            // Achievement check
            if (this.currentTime < 30000) { // Under 30 seconds
                Achievements.unlock('fast_runner');
            }
        }
        
        // Hide display
        const display = document.getElementById('time-trial-display');
        if (display) {
            setTimeout(() => {
                display.style.display = 'none';
            }, 3000);
        }
    },
    
    update: function() {
        if (!this.active) return;
        
        this.currentTime = Date.now() - this.startTime;
        this.updateDisplay();
    },
    
    updateDisplay: function() {
        const timerEl = document.getElementById('time-trial-timer');
        const bestEl = document.getElementById('time-trial-best');
        
        if (!timerEl || !bestEl) return;
        
        // Format current time
        const minutes = Math.floor(this.currentTime / 60000);
        const seconds = Math.floor((this.currentTime % 60000) / 1000);
        const ms = Math.floor((this.currentTime % 1000) / 10);
        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        
        // Format best time
        if (this.bestTime > 0) {
            const bestMinutes = Math.floor(this.bestTime / 60000);
            const bestSeconds = Math.floor((this.bestTime % 60000) / 1000);
            const bestMs = Math.floor((this.bestTime % 1000) / 10);
            bestEl.textContent = `Best: ${bestMinutes.toString().padStart(2, '0')}:${bestSeconds.toString().padStart(2, '0')}.${bestMs.toString().padStart(2, '0')}`;
        } else {
            bestEl.textContent = 'Best: --:--.--';
        }
    },
    
    reset: function() {
        this.active = false;
        this.startTime = 0;
        this.currentTime = 0;
        
        const display = document.getElementById('time-trial-display');
        if (display) {
            display.style.display = 'none';
        }
    }
};

// --- SOUND LIBRARY ---
const SoundLibrary = {
    currentPack: 'default',
    packs: {
        default: {
            name: 'Default',
            description: 'Original Neon Dash sounds',
            jump: [880, 'sine', 0.08, 0.4],
            pad: [1320, 'square', 0.1, 0.5],
            coin: [1000, 'triangle', 0.05, 0.3],
            gravity: [1800, 'sawtooth', 0.1, 0.5],
            die: [100, 'square', 0.3, 0.6],
            win: [1500, 'sine', 0.4, 0.7],
            dash: [1600, 'square', 0.08, 0.6],
            slow: [500, 'triangle', 0.1, 0.4],
            checkpoint: [1200, 'sine', 0.15, 0.4]
        },
        retro: {
            name: 'Retro',
            description: 'Classic 8-bit sounds',
            jump: [440, 'square', 0.1, 0.3],
            pad: [880, 'square', 0.08, 0.4],
            coin: [660, 'square', 0.05, 0.2],
            gravity: [220, 'square', 0.15, 0.5],
            die: [110, 'square', 0.4, 0.7],
            win: [1760, 'square', 0.5, 0.8],
            dash: [1320, 'square', 0.06, 0.5],
            slow: [330, 'square', 0.12, 0.4],
            checkpoint: [990, 'square', 0.2, 0.3]
        },
        synth: {
            name: 'Synthwave',
            description: '80s inspired synth sounds',
            jump: [523.25, 'sawtooth', 0.15, 0.5],
            pad: [1046.50, 'sine', 0.2, 0.6],
            coin: [783.99, 'triangle', 0.1, 0.4],
            gravity: [261.63, 'sawtooth', 0.25, 0.7],
            die: [130.81, 'sawtooth', 0.5, 0.8],
            win: [1567.98, 'sine', 0.6, 0.9],
            dash: [1174.66, 'square', 0.12, 0.7],
            slow: [392.00, 'sawtooth', 0.18, 0.5],
            checkpoint: [659.25, 'sine', 0.3, 0.6]
        },
        chiptune: {
            name: 'Chiptune',
            description: 'NES-style chiptune sounds',
            jump: [493.88, 'square', 0.08, 0.3],
            pad: [987.77, 'square', 0.12, 0.4],
            coin: [739.99, 'square', 0.06, 0.25],
            gravity: [246.94, 'square', 0.2, 0.6],
            die: [123.47, 'square', 0.35, 0.7],
            win: [1975.53, 'square', 0.45, 0.8],
            dash: [1479.98, 'square', 0.1, 0.5],
            slow: [369.99, 'square', 0.15, 0.4],
            checkpoint: [830.61, 'square', 0.25, 0.35]
        }
    },
    
    init: function() {
        this.currentPack = settings.audio.soundPack || 'default';
        this.render();
    },
    
    setPack: function(packId) {
        if (this.packs[packId]) {
            this.currentPack = packId;
            settings.audio.soundPack = packId;
            localStorage.setItem('nd_settings', JSON.stringify(settings));
            
            Game.showTutorialMessage(`Sound pack: ${this.packs[packId].name}`, 2000);
            this.render();
        }
    },
    
    render: function() {
        const container = document.getElementById('sound-library-content');
        if (!container) return;
        
        container.innerHTML = '';
        
        Object.keys(this.packs).forEach(packId => {
            const pack = this.packs[packId];
            const item = document.createElement('div');
            item.className = `sound-item ${this.currentPack === packId ? 'active' : ''}`;
            
            item.innerHTML = `
                <div class="sound-item-preview" style="color: ${this.currentPack === packId ? 'var(--neon-green)' : 'var(--neon-purple)'};">üéµ</div>
                <strong>${pack.name}</strong><br>
                <small style="color: #aaa;">${pack.description}</small>
            `;
            
            item.onclick = () => {
                this.setPack(packId);
                item.parentNode.querySelectorAll('.sound-item').forEach(el => {
                    el.classList.remove('active');
                });
                item.classList.add('active');
            };
            
            container.appendChild(item);
        });
    },
    
    testSounds: function() {
        if (!settings.audio.sfx) return;
        
        // Play a sequence of sounds
        const sounds = ['jump', 'coin', 'pad', 'dash', 'win'];
        let delay = 0;
        
        sounds.forEach((sound, index) => {
            setTimeout(() => {
                const pack = this.packs[this.currentPack];
                if (pack && pack[sound]) {
                    AUDIO.playTone(...pack[sound]);
                }
            }, delay);
            delay += 300;
        });
    },
    
    getSound: function(soundName) {
        const pack = this.packs[this.currentPack];
        if (pack && pack[soundName]) {
            return pack[soundName];
        }
        // Fallback to default
        return this.packs.default[soundName];
    }
};

// --- GAME MODES ---
const GameModes = {
    modes: [
        {
            id: 'normal',
            name: 'Normal',
            description: 'Standard gameplay',
            icon: 'üéÆ',
            difficulty: 'medium',
            timeLimit: 0,
            coinMultiplier: 1,
            unlockRequirement: 0
        },
        {
            id: 'time_trial',
            name: 'Time Trial',
            description: 'Race against the clock',
            icon: '‚è±Ô∏è',
            difficulty: 'hard',
            timeLimit: 60000, // 1 minute
            coinMultiplier: 1.5,
            unlockRequirement: 5
        },
        {
            id: 'endless',
            name: 'Endless',
            description: 'Survive as long as possible',
            icon: '‚àû',
            difficulty: 'hard',
            timeLimit: 0,
            coinMultiplier: 2,
            unlockRequirement: 10
        },
        {
            id: 'challenge',
            name: 'Daily Challenge',
            description: 'New challenge every day',
            icon: 'üéØ',
            difficulty: 'varies',
            timeLimit: 0,
            coinMultiplier: 2,
            unlockRequirement: 3
        },
        {
            id: 'practice',
            name: 'Practice',
            description: 'No penalties, learn mechanics',
            icon: 'üìö',
            difficulty: 'easy',
            timeLimit: 0,
            coinMultiplier: 0.5,
            unlockRequirement: 0
        },
        {
            id: 'hardcore',
            name: 'Hardcore',
            description: 'One life, no checkpoints',
            icon: 'üíÄ',
            difficulty: 'insane',
            timeLimit: 0,
            coinMultiplier: 3,
            unlockRequirement: 20
        }
    ],
    
    currentMode: 'normal',
    
    init: function() {
        this.render();
    },
    
    setMode: function(modeId) {
        const mode = this.modes.find(m => m.id === modeId);
        if (mode && unlocked >= mode.unlockRequirement) {
            this.currentMode = modeId;
            
            // Apply mode settings
            if (modeId === 'time_trial') {
                settings.gameplay.timeTrial = true;
                TimeTrial.start();
            } else {
                settings.gameplay.timeTrial = false;
                TimeTrial.reset();
            }
            
            Game.showTutorialMessage(`Mode: ${mode.name}`, 2000);
            this.render();
        } else if (mode) {
            Game.showTutorialMessage(`Unlock at level ${mode.unlockRequirement + 1}`, 2000);
        }
    },
    
    render: function() {
        const container = document.getElementById('game-modes-content');
        if (!container) return;
        
        container.innerHTML = '';
        
        this.modes.forEach(mode => {
            const item = document.createElement('div');
            item.className = `game-mode-item ${this.currentMode === mode.id ? 'active' : ''} ${unlocked < mode.unlockRequirement ? 'locked' : ''}`;
            
            if (unlocked < mode.unlockRequirement) {
                item.style.opacity = '0.6';
                item.style.cursor = 'not-allowed';
            }
            
            item.innerHTML = `
                <div class="game-mode-icon">${mode.icon}</div>
                <h3>${mode.name}</h3>
                <p style="color: #aaa; margin: 10px 0;">${mode.description}</p>
                <div class="game-mode-difficulty difficulty-${mode.difficulty}">${mode.difficulty.toUpperCase()}</div>
                ${unlocked < mode.unlockRequirement ? 
                    `<div style="color: var(--neon-red); margin-top: 10px; font-size: 0.9em;">Unlocks at Level ${mode.unlockRequirement + 1}</div>` : 
                    `<div style="color: var(--neon-green); margin-top: 10px; font-size: 0.9em;">${mode.coinMultiplier}x Coins</div>`
                }
            `;
            
            if (unlocked >= mode.unlockRequirement) {
                item.onclick = () => {
                    this.setMode(mode.id);
                    item.parentNode.querySelectorAll('.game-mode-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    item.classList.add('active');
                };
            }
            
            container.appendChild(item);
        });
    },
    
    getCurrentMode: function() {
        return this.modes.find(m => m.id === this.currentMode) || this.modes[0];
    }
};

// --- IMPROVED AUDIO ENGINE ---
const AUDIO = {
    ctx: null,
    bgmOsc: null,
    audioEnabled: true,
    gainNode: null,
    musicGainNode: null,
    
    init: function() {
        try {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.gainNode = this.ctx.createGain();
            this.musicGainNode = this.ctx.createGain();
            this.gainNode.connect(this.ctx.destination);
            this.musicGainNode.connect(this.gainNode);
            
            this.setVolume(settings.audio.volume / 100);
            this.setMusicVolume(settings.audio.musicVolume / 100);
            
            if (this.ctx.state === 'suspended') {
                const resumeAudio = () => {
                    this.ctx.resume();
                    document.removeEventListener('click', resumeAudio);
                    document.removeEventListener('touchstart', resumeAudio);
                };
                document.addEventListener('click', resumeAudio);
                document.addEventListener('touchstart', resumeAudio);
            }
            
            console.log("Audio initialized successfully");
        } catch (e) {
            console.warn("Audio context not supported:", e);
            this.audioEnabled = false;
        }
    },

    setVolume: function(volume) {
        if (!this.audioEnabled || !this.gainNode) return;
        this.gainNode.gain.setValueAtTime(volume, this.ctx.currentTime);
    },

    setMusicVolume: function(volume) {
        if (!this.audioEnabled || !this.musicGainNode) return;
        this.musicGainNode.gain.setValueAtTime(volume, this.ctx.currentTime);
    },

    playTone: function(freq, type, duration = 0.1, volume = 0.5) {
        if (!this.audioEnabled || !settings.audio.sfx || !this.ctx) return;
        
        try {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(volume * (settings.audio.volume / 100), this.ctx.currentTime);

            osc.connect(gain);
            gain.connect(this.gainNode);

            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
            osc.stop(this.ctx.currentTime + duration);
        } catch (e) {
            console.warn("Audio play failed:", e);
        }
    },

    startBGM: function(freq = 'C4') {
        if (!this.audioEnabled || !settings.audio.music || !this.ctx) return;
        this.stopBGM();
        
        try {
            const noteMap = {
                'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23,
                'G4': 392.00, 'A4': 440.00, 'B4': 493.88, 'C5': 523.25
            };
            const f = noteMap[freq] || noteMap['C4'];

            this.bgmOsc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            gain.gain.setValueAtTime(0.1 * (settings.audio.musicVolume / 100), this.ctx.currentTime);

            this.bgmOsc.type = 'sawtooth';
            this.bgmOsc.frequency.setValueAtTime(f, this.ctx.currentTime);

            this.bgmOsc.connect(gain);
            gain.connect(this.musicGainNode);
            this.bgmOsc.start();
        } catch (e) {
            console.warn("BGM failed:", e);
        }
    },

    stopBGM: function() {
        if (this.bgmOsc) {
            try {
                this.bgmOsc.stop(this.ctx.currentTime);
                this.bgmOsc = null;
            } catch (e) {
                console.warn("BGM stop failed:", e);
            }
        }
    },

    jump: () => {
        const sound = SoundLibrary.getSound('jump');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('totalJumps');
    },
    
    pad: () => {
        const sound = SoundLibrary.getSound('pad');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('padsUsed');
    },
    
    coin: () => {
        const sound = SoundLibrary.getSound('coin');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('totalCoins');
    },
    
    gravity: () => {
        const sound = SoundLibrary.getSound('gravity');
        AUDIO.playTone(...sound);
    },
    
    die: () => {
        const sound = SoundLibrary.getSound('die');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('totalDeaths');
    },
    
    win: () => {
        const sound = SoundLibrary.getSound('win');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('levelsCompleted');
    },
    
    dash: () => {
        const sound = SoundLibrary.getSound('dash');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('dashUses');
    },
    
    slow: () => {
        const sound = SoundLibrary.getSound('slow');
        AUDIO.playTone(...sound);
    },
    
    checkpoint: () => {
        const sound = SoundLibrary.getSound('checkpoint');
        AUDIO.playTone(...sound);
        Achievements.incrementStat('checkpointsUsed');
    }
};

// --- LEVEL DATA ---
const L = (t, x, y) => ({ t: t, x: x, y: y });

const createLevel = (id, objects) => {
    objects.push(L(99, 250, 0));
    return objects;
}

const LEVELS = [];

// Level 0: Tutorial
LEVELS[0] = createLevel(0, [
    L(1,10,0), L(1,14,0), L(1,18,0), L(1,22,0), L(1,26,0), L(7,30,0), L(1,34,0), L(1,38,0), L(7,42,0),
    L(2,46,0), L(1,50,0), L(2,54,0), L(1,58,0), L(7,62,0), L(1,66,0), L(1,70,0), L(1,74,0), L(7,78,0),
    L(1,82,0), L(1,86,0), L(1,90,2), L(1,94,2), L(1,98,2), L(7,102,0), L(1,106,0), L(1,110,0), L(7,114,0),
    L(2,118,0), L(2,122,0), L(2,126,0), L(1,130,0), L(1,134,0), L(7,138,0), L(1,142,0), L(1,146,0),
    L(1,150,0), L(2,154,0), L(1,158,0), L(1,162,0), L(7,166,0), L(1,170,0), L(1,174,0), L(1,178,0),
    L(2,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(7,198,0), L(1,202,0), L(1,206,0), L(1,210,0),
    L(2,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(7,230,0), L(1,234,0), L(1,238,0), L(1,242,0),
    L(3,12,0), L(3,20,0), L(3,28,0), L(3,36,0), L(3,44,0), L(3,52,0), L(3,60,0), L(3,68,0), L(3,76,0),
    L(3,84,0), L(3,92,0), L(3,100,0), L(3,108,0), L(3,116,0), L(3,124,0), L(3,132,0), L(3,140,0),
    L(3,148,0), L(3,156,0), L(3,164,0), L(3,172,0), L(3,180,0), L(3,188,0), L(3,196,0), L(3,204,0),
    L(3,212,0), L(3,220,0), L(3,228,0), L(3,236,0), L(3,244,0)
]);

// Level 1: Cube Precision
LEVELS[1] = createLevel(1, [
    L(1,10,0), L(1,14,0), L(2,18,2), L(1,22,0), L(1,26,0), L(2,30,2), L(1,34,0), L(1,38,0), L(2,42,2),
    L(1,46,0), L(1,50,0), L(2,54,2), L(1,58,0), L(1,62,0), L(2,66,2), L(1,70,0), L(1,74,0), L(2,78,2),
    L(1,82,0), L(1,86,0), L(2,90,2), L(1,94,0), L(1,98,0), L(2,102,2), L(1,106,0), L(1,110,0), L(2,114,2),
    L(1,118,0), L(1,122,0), L(2,126,2), L(1,130,0), L(1,134,0), L(2,138,2), L(1,142,0), L(1,146,0),
    L(2,150,2), L(1,154,0), L(1,158,0), L(2,162,2), L(1,166,0), L(1,170,0), L(2,174,2), L(1,178,0),
    L(1,182,0), L(2,186,2), L(1,190,0), L(1,194,0), L(2,198,2), L(1,202,0), L(1,206,0), L(2,210,2),
    L(1,214,0), L(1,218,0), L(2,222,2), L(1,226,0), L(1,230,0), L(2,234,2), L(1,238,0), L(1,242,0),
    L(3,15,0), L(3,25,0), L(3,35,0), L(3,45,0), L(3,55,0), L(3,65,0), L(3,75,0), L(3,85,0),
    L(3,95,0), L(3,105,0), L(3,115,0), L(3,125,0), L(3,135,0), L(3,145,0), L(3,155,0), L(3,165,0),
    L(3,175,0), L(3,185,0), L(3,195,0), L(3,205,0), L(3,215,0), L(3,225,0), L(3,235,0), L(3,245,0)
]);

// Level 2: Ship Flight Training
LEVELS[2] = createLevel(2, [
    L(4,10,2),
    L(1,15,0), L(1,20,0), L(1,25,0), L(1,30,0), L(1,35,0), L(1,40,0), L(1,45,0), L(1,50,0),
    L(2,55,3), L(2,60,3), L(2,65,3), L(2,70,3), L(2,75,3), L(2,80,3), L(2,85,3), L(2,90,3),
    L(1,95,0), L(1,100,0), L(1,105,0), L(1,110,0), L(1,115,0), L(1,120,0), L(1,125,0), L(1,130,0),
    L(2,135,7), L(2,140,7), L(2,145,7), L(2,150,7), L(2,155,7), L(2,160,7), L(2,165,7), L(2,170,7),
    L(1,175,0), L(1,180,0), L(1,185,0), L(1,190,0), L(1,195,0), L(1,200,0), L(1,205,0), L(1,210,0),
    L(3,12,0), L(3,22,0), L(3,32,0), L(3,42,0), L(3,52,0), L(3,62,0), L(3,72,0), L(3,82,0),
    L(3,92,0), L(3,102,0), L(3,112,0), L(3,122,0), L(3,132,0), L(3,142,0), L(3,152,0), L(3,162,0),
    L(3,172,0), L(3,182,0), L(3,192,0), L(3,202,0), L(3,212,0), L(3,222,0), L(3,232,0), L(3,242,0)
]);

// Level 3: UFO Precision Madness
LEVELS[3] = createLevel(3, [
    L(5,10,2),
    L(1,15,0), L(1,15,4), L(1,20,1), L(1,20,3), L(1,25,2), L(1,30,1), L(1,30,3), L(1,35,0), L(1,35,4),
    L(2,40,2), L(2,45,2), L(2,50,2), L(2,55,2), L(2,60,2), L(2,65,2), L(2,70,2), L(2,75,2),
    L(1,80,0), L(1,80,4), L(1,85,1), L(1,85,3), L(1,90,2), L(1,95,1), L(1,95,3), L(1,100,0), L(1,100,4),
    L(2,105,2), L(2,110,2), L(2,115,2), L(2,120,2), L(2,125,2), L(2,130,2), L(2,135,2), L(2,140,2),
    L(1,145,0), L(1,145,4), L(1,150,1), L(1,150,3), L(1,155,2), L(1,160,1), L(1,160,3), L(1,165,0), L(1,165,4),
    L(2,170,2), L(2,175,2), L(2,180,2), L(2,185,2), L(2,190,2), L(2,195,2), L(2,200,2), L(2,205,2),
    L(1,210,0), L(1,210,4), L(1,215,1), L(1,215,3), L(1,220,2), L(1,225,1), L(1,225,3), L(1,230,0), L(1,230,4),
    L(3,18,2), L(3,28,2), L(3,38,2), L(3,48,2), L(3,58,2), L(3,68,2), L(3,78,2), L(3,88,2),
    L(3,98,2), L(3,108,2), L(3,118,2), L(3,128,2), L(3,138,2), L(3,148,2), L(3,158,2), L(3,168,2),
    L(3,178,2), L(3,188,2), L(3,198,2), L(3,208,2), L(3,218,2), L(3,228,2), L(3,238,2), L(3,248,2)
]);

// Level 4: Wave Rhythm
LEVELS[4] = createLevel(4, [
    L(11,10,2),
    L(1,15,0), L(1,20,0), L(1,25,0), L(1,30,0), L(1,35,0), L(1,40,0), L(1,45,0), L(1,50,0),
    L(2,55,2), L(2,60,0), L(2,65,2), L(2,70,0), L(2,75,2), L(2,80,0), L(2,85,2), L(2,90,0),
    L(2,95,2), L(2,100,0), L(2,105,2), L(2,110,0), L(2,115,2), L(2,120,0), L(2,125,2), L(2,130,0),
    L(2,135,2), L(2,140,0), L(2,145,2), L(2,150,0), L(2,155,2), L(2,160,0), L(2,165,2), L(2,170,0),
    L(2,175,2), L(2,180,0), L(2,185,2), L(2,190,0), L(2,195,2), L(2,200,0), L(2,205,2), L(2,210,0),
    L(2,215,2), L(2,220,0), L(2,225,2), L(2,230,0), L(2,235,2), L(2,240,0), L(2,245,2), L(2,250,0),
    L(3,17,1), L(3,27,1), L(3,37,1), L(3,47,1), L(3,57,1), L(3,67,1), L(3,77,1), L(3,87,1),
    L(3,97,1), L(3,107,1), L(3,117,1), L(3,127,1), L(3,137,1), L(3,147,1), L(3,157,1), L(3,167,1),
    L(3,177,1), L(3,187,1), L(3,197,1), L(3,207,1), L(3,217,1), L(3,227,1), L(3,237,1), L(3,247,1)
]);

// Level 5: Robot Mini Challenge
LEVELS[5] = createLevel(5, [
    L(12,10,0), L(9,14,2),
    L(1,18,0), L(7,22,0), L(1,26,0), L(7,30,0), L(1,34,0), L(7,38,0), L(1,42,0), L(7,46,0),
    L(1,50,0), L(7,54,0), L(1,58,0), L(7,62,0), L(1,66,0), L(7,70,0), L(1,74,0), L(7,78,0),
    L(1,82,0), L(7,86,0), L(1,90,0), L(7,94,0), L(1,98,0), L(7,102,0), L(1,106,0), L(7,110,0),
    L(1,114,0), L(7,118,0), L(1,122,0), L(7,126,0), L(1,130,0), L(7,134,0), L(1,138,0), L(7,142,0),
    L(1,146,0), L(7,150,0), L(1,154,0), L(7,158,0), L(1,162,0), L(7,166,0), L(1,170,0), L(7,174,0),
    L(1,178,0), L(7,182,0), L(1,186,0), L(7,190,0), L(1,194,0), L(7,198,0), L(1,202,0), L(7,206,0),
    L(1,210,0), L(7,214,0), L(1,218,0), L(7,222,0), L(1,226,0), L(7,230,0), L(1,234,0), L(7,238,0),
    L(1,242,0), L(7,246,0),
    L(3,20,0), L(3,30,0), L(3,40,0), L(3,50,0), L(3,60,0), L(3,70,0), L(3,80,0), L(3,90,0),
    L(3,100,0), L(3,110,0), L(3,120,0), L(3,130,0), L(3,140,0), L(3,150,0), L(3,160,0), L(3,170,0),
    L(3,180,0), L(3,190,0), L(3,200,0), L(3,210,0), L(3,220,0), L(3,230,0), L(3,240,0), L(3,250,0)
]);

// Level 6: Swing Macro Adventure
LEVELS[6] = createLevel(6, [
    L(14,10,2), L(10,14,2),
    L(1,18,0), L(1,18,4), L(1,22,2), L(1,26,0), L(1,26,4), L(1,30,2), L(1,34,0), L(1,34,4),
    L(1,38,2), L(1,42,0), L(1,42,4), L(1,46,2), L(1,50,0), L(1,50,4), L(1,54,2), L(1,58,0), L(1,58,4),
    L(1,62,2), L(1,66,0), L(1,66,4), L(1,70,2), L(1,74,0), L(1,74,4), L(1,78,2), L(1,82,0), L(1,82,4),
    L(1,86,2), L(1,90,0), L(1,90,4), L(1,94,2), L(1,98,0), L(1,98,4), L(1,102,2), L(1,106,0), L(1,106,4),
    L(1,110,2), L(1,114,0), L(1,114,4), L(1,118,2), L(1,122,0), L(1,122,4), L(1,126,2), L(1,130,0), L(1,130,4),
    L(1,134,2), L(1,138,0), L(1,138,4), L(1,142,2), L(1,146,0), L(1,146,4), L(1,150,2), L(1,154,0), L(1,154,4),
    L(1,158,2), L(1,162,0), L(1,162,4), L(1,166,2), L(1,170,0), L(1,170,4), L(1,174,2), L(1,178,0), L(1,178,4),
    L(1,182,2), L(1,186,0), L(1,186,4), L(1,190,2), L(1,194,0), L(1,194,4), L(1,198,2), L(1,202,0), L(1,202,4),
    L(1,206,2), L(1,210,0), L(1,210,4), L(1,214,2), L(1,218,0), L(1,218,4), L(1,222,2), L(1,226,0), L(1,226,4),
    L(1,230,2), L(1,234,0), L(1,234,4), L(1,238,2), L(1,242,0), L(1,242,4), L(1,246,2),
    L(3,16,2), L(3,26,2), L(3,36,2), L(3,46,2), L(3,56,2), L(3,66,2), L(3,76,2), L(3,86,2),
    L(3,96,2), L(3,106,2), L(3,116,2), L(3,126,2), L(3,136,2), L(3,146,2), L(3,156,2), L(3,166,2),
    L(3,176,2), L(3,186,2), L(3,196,2), L(3,206,2), L(3,216,2), L(3,226,2), L(3,236,2), L(3,246,2)
]);

// Level 7: Dash Mania
LEVELS[7] = createLevel(7, [
    L(15,10,2),
    L(1,15,0), L(15,20,2), L(1,25,0), L(15,30,2), L(1,35,0), L(15,40,2), L(1,45,0), L(15,50,2),
    L(1,55,0), L(15,60,2), L(1,65,0), L(15,70,2), L(1,75,0), L(15,80,2), L(1,85,0), L(15,90,2),
    L(1,95,0), L(15,100,2), L(1,105,0), L(15,110,2), L(1,115,0), L(15,120,2), L(1,125,0), L(15,130,2),
    L(1,135,0), L(15,140,2), L(1,145,0), L(15,150,2), L(1,155,0), L(15,160,2), L(1,165,0), L(15,170,2),
    L(1,175,0), L(15,180,2), L(1,185,0), L(15,190,2), L(1,195,0), L(15,200,2), L(1,205,0), L(15,210,2),
    L(1,215,0), L(15,220,2), L(1,225,0), L(15,230,2), L(1,235,0), L(15,240,2), L(1,245,0), L(15,250,2),
    L(2,17,0), L(2,27,0), L(2,37,0), L(2,47,0), L(2,57,0), L(2,67,0), L(2,77,0), L(2,87,0),
    L(2,97,0), L(2,107,0), L(2,117,0), L(2,127,0), L(2,137,0), L(2,147,0), L(2,157,0), L(2,167,0),
    L(2,177,0), L(2,187,0), L(2,197,0), L(2,207,0), L(2,217,0), L(2,227,0), L(2,237,0), L(2,247,0)
]);

// Level 8: Slow Motion Zone
LEVELS[8] = createLevel(8, [
    L(16,10,2),
    L(1,15,0), L(1,20,0), L(1,25,0), L(1,30,0), L(1,35,0), L(1,40,0), L(1,45,0), L(1,50,0),
    L(16,55,2), L(16,60,2), L(16,65,2), L(16,70,2), L(16,75,2), L(16,80,2), L(16,85,2), L(16,90,2),
    L(1,95,0), L(1,100,0), L(1,105,0), L(1,110,0), L(1,115,0), L(1,120,0), L(1,125,0), L(1,130,0),
    L(2,135,2), L(2,140,0), L(2,145,2), L(2,150,0), L(2,155,2), L(2,160,0), L(2,165,2), L(2,170,0),
    L(2,175,2), L(2,180,0), L(2,185,2), L(2,190,0), L(2,195,2), L(2,200,0), L(2,205,2), L(2,210,0),
    L(2,215,2), L(2,220,0), L(2,225,2), L(2,230,0), L(2,235,2), L(2,240,0), L(2,245,2), L(2,250,0),
    L(3,18,1), L(3,28,1), L(3,38,1), L(3,48,1), L(3,58,1), L(3,68,1), L(3,78,1), L(3,88,1),
    L(3,98,1), L(3,108,1), L(3,118,1), L(3,128,1), L(3,138,1), L(3,148,1), L(3,158,1), L(3,168,1),
    L(3,178,1), L(3,188,1), L(3,198,1), L(3,208,1), L(3,218,1), L(3,228,1), L(3,238,1), L(3,248,1)
]);

// Level 9: Portal Party
LEVELS[9] = createLevel(9, [
    L(4,10,2), L(5,20,2), L(6,30,2), L(11,40,2), L(12,50,0), L(14,60,2), L(9,70,2), L(10,80,2),
    L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0), L(1,55,0), L(1,65,0), L(1,75,0), L(1,85,0),
    L(1,95,0), L(1,105,0), L(1,115,0), L(1,125,0), L(1,135,0), L(1,145,0), L(1,155,0), L(1,165,0),
    L(1,175,0), L(1,185,0), L(1,195,0), L(1,205,0), L(1,215,0), L(1,225,0), L(1,235,0), L(1,245,0),
    L(7,17,0), L(7,27,0), L(7,37,0), L(7,47,0), L(7,57,0), L(7,67,0), L(7,77,0), L(7,87,0),
    L(7,97,0), L(7,107,0), L(7,117,0), L(7,127,0), L(7,137,0), L(7,147,0), L(7,157,0), L(7,167,0),
    L(7,177,0), L(7,187,0), L(7,197,0), L(7,207,0), L(7,217,0), L(7,227,0), L(7,237,0), L(7,247,0),
    L(3,12,0), L(3,22,0), L(3,32,0), L(3,42,0), L(3,52,0), L(3,62,0), L(3,72,0), L(3,82,0),
    L(3,92,0), L(3,102,0), L(3,112,0), L(3,122,0), L(3,132,0), L(3,142,0), L(3,152,0), L(3,162,0),
    L(3,172,0), L(3,182,0), L(3,192,0), L(3,202,0), L(3,212,0), L(3,222,0), L(3,232,0), L(3,242,0)
]);

// Level 10: Moving Platform Mayhem
LEVELS[10] = createLevel(10, [
    L(20,10,2), L(20,15,4), L(20,20,2), L(20,25,4), L(20,30,2), L(20,35,4),
    L(1,40,0), L(1,45,0), L(1,50,0), L(1,55,0), L(1,60,0), L(1,65,0), L(1,70,0), L(1,75,0),
    L(20,80,2), L(20,85,4), L(20,90,2), L(20,95,4), L(20,100,2), L(20,105,4),
    L(1,110,0), L(1,115,0), L(1,120,0), L(1,125,0), L(1,130,0), L(1,135,0), L(1,140,0), L(1,145,0),
    L(20,150,2), L(20,155,4), L(20,160,2), L(20,165,4), L(20,170,2), L(20,175,4),
    L(1,180,0), L(1,185,0), L(1,190,0), L(1,195,0), L(1,200,0), L(1,205,0), L(1,210,0), L(1,215,0),
    L(20,220,2), L(20,225,4), L(20,230,2), L(20,235,4), L(20,240,2), L(20,245,4),
    L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0), L(2,92,0), L(2,102,0), L(2,112,0),
    L(2,122,0), L(2,132,0), L(2,142,0), L(2,152,0), L(2,162,0), L(2,172,0), L(2,182,0), L(2,192,0),
    L(2,202,0), L(2,212,0), L(2,222,0), L(2,232,0), L(2,242,0), L(2,252,0),
    L(3,44,0), L(3,54,0), L(3,64,0), L(3,74,0), L(3,84,0), L(3,94,0), L(3,104,0), L(3,114,0),
    L(3,124,0), L(3,134,0), L(3,144,0), L(3,154,0), L(3,164,0), L(3,174,0), L(3,184,0), L(3,194,0),
    L(3,204,0), L(3,214,0), L(3,224,0), L(3,234,0), L(3,244,0), L(3,254,0)
]);

// Level 11: Checkpoint Race
LEVELS[11] = createLevel(11, [
    L(13,10,2), L(13,30,2), L(13,50,2), L(13,70,2), L(13,90,2), L(13,110,2), L(13,130,2), L(13,150,2),
    L(13,170,2), L(13,190,2), L(13,210,2), L(13,230,2), L(13,250,2),
    L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0), L(1,55,0), L(1,65,0), L(1,75,0), L(1,85,0),
    L(1,95,0), L(1,105,0), L(1,115,0), L(1,125,0), L(1,135,0), L(1,145,0), L(1,155,0), L(1,165,0),
    L(1,175,0), L(1,185,0), L(1,195,0), L(1,205,0), L(1,215,0), L(1,225,0), L(1,235,0), L(1,245,0),
    L(2,18,0), L(2,28,0), L(2,38,0), L(2,48,0), L(2,58,0), L(2,68,0), L(2,78,0), L(2,88,0),
    L(2,98,0), L(2,108,0), L(2,118,0), L(2,128,0), L(2,138,0), L(2,148,0), L(2,158,0), L(2,168,0),
    L(2,178,0), L(2,188,0), L(2,198,0), L(2,208,0), L(2,218,0), L(2,228,0), L(2,238,0), L(2,248,0),
    L(3,20,0), L(3,40,0), L(3,60,0), L(3,80,0), L(3,100,0), L(3,120,0), L(3,140,0), L(3,160,0),
    L(3,180,0), L(3,200,0), L(3,220,0), L(3,240,0), L(3,260,0)
]);

// Level 12: Zigzag Extreme
LEVELS[12] = createLevel(12, [
    L(1,10,0), L(1,18,2), L(1,26,0), L(1,34,2), L(1,42,0), L(1,50,2), L(1,58,0), L(1,66,2),
    L(1,74,0), L(1,82,2), L(1,90,0), L(1,98,2), L(1,106,0), L(1,114,2), L(1,122,0), L(1,130,2),
    L(1,138,0), L(1,146,2), L(1,154,0), L(1,162,2), L(1,170,0), L(1,178,2), L(1,186,0), L(1,194,2),
    L(1,202,0), L(1,210,2), L(1,218,0), L(1,226,2), L(1,234,0), L(1,242,2), L(1,250,0),
    L(2,14,0), L(2,22,0), L(2,30,0), L(2,38,0), L(2,46,0), L(2,54,0), L(2,62,0), L(2,70,0),
    L(2,78,0), L(2,86,0), L(2,94,0), L(2,102,0), L(2,110,0), L(2,118,0), L(2,126,0), L(2,134,0),
    L(2,142,0), L(2,150,0), L(2,158,0), L(2,166,0), L(2,174,0), L(2,182,0), L(2,190,0), L(2,198,0),
    L(2,206,0), L(2,214,0), L(2,222,0), L(2,230,0), L(2,238,0), L(2,246,0),
    L(3,12,0), L(3,20,0), L(3,28,0), L(3,36,0), L(3,44,0), L(3,52,0), L(3,60,0), L(3,68,0),
    L(3,76,0), L(3,84,0), L(3,92,0), L(3,100,0), L(3,108,0), L(3,116,0), L(3,124,0), L(3,132,0),
    L(3,140,0), L(3,148,0), L(3,156,0), L(3,164,0), L(3,172,0), L(3,180,0), L(3,188,0), L(3,196,0),
    L(3,204,0), L(3,212,0), L(3,220,0), L(3,228,0), L(3,236,0), L(3,244,0)
]);

// Level 13: Wall Jump Madness
LEVELS[13] = createLevel(13, [
    L(1,10,0), L(1,10,4), L(1,18,0), L(1,18,4), L(1,26,0), L(1,26,4), L(1,34,0), L(1,34,4),
    L(1,42,0), L(1,42,4), L(1,50,0), L(1,50,4), L(1,58,0), L(1,58,4), L(1,66,0), L(1,66,4),
    L(1,74,0), L(1,74,4), L(1,82,0), L(1,82,4), L(1,90,0), L(1,90,4), L(1,98,0), L(1,98,4),
    L(1,106,0), L(1,106,4), L(1,114,0), L(1,114,4), L(1,122,0), L(1,122,4), L(1,130,0), L(1,130,4),
    L(1,138,0), L(1,138,4), L(1,146,0), L(1,146,4), L(1,154,0), L(1,154,4), L(1,162,0), L(1,162,4),
    L(1,170,0), L(1,170,4), L(1,178,0), L(1,178,4), L(1,186,0), L(1,186,4), L(1,194,0), L(1,194,4),
    L(1,202,0), L(1,202,4), L(1,210,0), L(1,210,4), L(1,218,0), L(1,218,4), L(1,226,0), L(1,226,4),
    L(1,234,0), L(1,234,4), L(1,242,0), L(1,242,4), L(1,250,0), L(1,250,4),
    L(7,14,2), L(7,22,2), L(7,30,2), L(7,38,2), L(7,46,2), L(7,54,2), L(7,62,2), L(7,70,2),
    L(7,78,2), L(7,86,2), L(7,94,2), L(7,102,2), L(7,110,2), L(7,118,2), L(7,126,2), L(7,134,2),
    L(7,142,2), L(7,150,2), L(7,158,2), L(7,166,2), L(7,174,2), L(7,182,2), L(7,190,2), L(7,198,2),
    L(7,206,2), L(7,214,2), L(7,222,2), L(7,230,2), L(7,238,2), L(7,246,2),
    L(3,12,0), L(3,20,0), L(3,28,0), L(3,36,0), L(3,44,0), L(3,52,0), L(3,60,0), L(3,68,0),
    L(3,76,0), L(3,84,0), L(3,92,0), L(3,100,0), L(3,108,0), L(3,116,0), L(3,124,0), L(3,132,0),
    L(3,140,0), L(3,148,0), L(3,156,0), L(3,164,0), L(3,172,0), L(3,180,0), L(3,188,0), L(3,196,0),
    L(3,204,0), L(3,212,0), L(3,220,0), L(3,228,0), L(3,236,0), L(3,244,0)
]);

// Level 14: Spike Tunnel
LEVELS[14] = createLevel(14, [
    L(2,10,0), L(2,10,8), L(2,14,0), L(2,14,8), L(2,18,0), L(2,18,8), L(2,22,0), L(2,22,8),
    L(2,26,0), L(2,26,8), L(2,30,0), L(2,30,8), L(2,34,0), L(2,34,8), L(2,38,0), L(2,38,8),
    L(2,42,0), L(2,42,8), L(2,46,0), L(2,46,8), L(2,50,0), L(2,50,8), L(2,54,0), L(2,54,8),
    L(2,58,0), L(2,58,8), L(2,62,0), L(2,62,8), L(2,66,0), L(2,66,8), L(2,70,0), L(2,70,8),
    L(2,74,0), L(2,74,8), L(2,78,0), L(2,78,8), L(2,82,0), L(2,82,8), L(2,86,0), L(2,86,8),
    L(2,90,0), L(2,90,8), L(2,94,0), L(2,94,8), L(2,98,0), L(2,98,8), L(2,102,0), L(2,102,8),
    L(2,106,0), L(2,106,8), L(2,110,0), L(2,110,8), L(2,114,0), L(2,114,8), L(2,118,0), L(2,118,8),
    L(2,122,0), L(2,122,8), L(2,126,0), L(2,126,8), L(2,130,0), L(2,130,8), L(2,134,0), L(2,134,8),
    L(2,138,0), L(2,138,8), L(2,142,0), L(2,142,8), L(2,146,0), L(2,146,8), L(2,150,0), L(2,150,8),
    L(2,154,0), L(2,154,8), L(2,158,0), L(2,158,8), L(2,162,0), L(2,162,8), L(2,166,0), L(2,166,8),
    L(2,170,0), L(2,170,8), L(2,174,0), L(2,174,8), L(2,178,0), L(2,178,8), L(2,182,0), L(2,182,8),
    L(2,186,0), L(2,186,8), L(2,190,0), L(2,190,8), L(2,194,0), L(2,194,8), L(2,198,0), L(2,198,8),
    L(2,202,0), L(2,202,8), L(2,206,0), L(2,206,8), L(2,210,0), L(2,210,8), L(2,214,0), L(2,214,8),
    L(2,218,0), L(2,218,8), L(2,222,0), L(2,222,8), L(2,226,0), L(2,226,8), L(2,230,0), L(2,230,8),
    L(2,234,0), L(2,234,8), L(2,238,0), L(2,238,8), L(2,242,0), L(2,242,8), L(2,246,0), L(2,246,8),
    L(1,12,4), L(1,20,4), L(1,28,4), L(1,36,4), L(1,44,4), L(1,52,4), L(1,60,4), L(1,68,4),
    L(1,76,4), L(1,84,4), L(1,92,4), L(1,100,4), L(1,108,4), L(1,116,4), L(1,124,4), L(1,132,4),
    L(1,140,4), L(1,148,4), L(1,156,4), L(1,164,4), L(1,172,4), L(1,180,4), L(1,188,4), L(1,196,4),
    L(1,204,4), L(1,212,4), L(1,220,4), L(1,228,4), L(1,236,4), L(1,244,4),
    L(3,14,4), L(3,22,4), L(3,30,4), L(3,38,4), L(3,46,4), L(3,54,4), L(3,62,4), L(3,70,4),
    L(3,78,4), L(3,86,4), L(3,94,4), L(3,102,4), L(3,110,4), L(3,118,4), L(3,126,4), L(3,134,4),
    L(3,142,4), L(3,150,4), L(3,158,4), L(3,166,4), L(3,174,4), L(3,182,4), L(3,190,4), L(3,198,4),
    L(3,206,4), L(3,214,4), L(3,222,4), L(3,230,4), L(3,238,4), L(3,246,4)
]);

// Level 15: Bounce Castle 2.0
LEVELS[15] = createLevel(15, [
    L(7,10,0), L(7,12,0), L(7,14,0), L(7,16,0), L(7,18,0), L(7,20,0), L(7,22,0), L(7,24,0),
    L(7,26,0), L(7,28,0), L(7,30,0), L(7,32,0), L(7,34,0), L(7,36,0), L(7,38,0), L(7,40,0),
    L(7,42,0), L(7,44,0), L(7,46,0), L(7,48,0), L(7,50,0), L(7,52,0), L(7,54,0), L(7,56,0),
    L(7,58,0), L(7,60,0), L(7,62,0), L(7,64,0), L(7,66,0), L(7,68,0), L(7,70,0), L(7,72,0),
    L(7,74,0), L(7,76,0), L(7,78,0), L(7,80,0), L(7,82,0), L(7,84,0), L(7,86,0), L(7,88,0),
    L(7,90,0), L(7,92,0), L(7,94,0), L(7,96,0), L(7,98,0), L(7,100,0), L(7,102,0), L(7,104,0),
    L(7,106,0), L(7,108,0), L(7,110,0), L(7,112,0), L(7,114,0), L(7,116,0), L(7,118,0), L(7,120,0),
    L(7,122,0), L(7,124,0), L(7,126,0), L(7,128,0), L(7,130,0), L(7,132,0), L(7,134,0), L(7,136,0),
    L(7,138,0), L(7,140,0), L(7,142,0), L(7,144,0), L(7,146,0), L(7,148,0), L(7,150,0), L(7,152,0),
    L(7,154,0), L(7,156,0), L(7,158,0), L(7,160,0), L(7,162,0), L(7,164,0), L(7,166,0), L(7,168,0),
    L(7,170,0), L(7,172,0), L(7,174,0), L(7,176,0), L(7,178,0), L(7,180,0), L(7,182,0), L(7,184,0),
    L(7,186,0), L(7,188,0), L(7,190,0), L(7,192,0), L(7,194,0), L(7,196,0), L(7,198,0), L(7,200,0),
    L(7,202,0), L(7,204,0), L(7,206,0), L(7,208,0), L(7,210,0), L(7,212,0), L(7,214,0), L(7,216,0),
    L(7,218,0), L(7,220,0), L(7,222,0), L(7,224,0), L(7,226,0), L(7,228,0), L(7,230,0), L(7,232,0),
    L(7,234,0), L(7,236,0), L(7,238,0), L(7,240,0), L(7,242,0), L(7,244,0), L(7,246,0), L(7,248,0),
    L(3,11,0), L(3,15,0), L(3,19,0), L(3,23,0), L(3,27,0), L(3,31,0), L(3,35,0), L(3,39,0),
    L(3,43,0), L(3,47,0), L(3,51,0), L(3,55,0), L(3,59,0), L(3,63,0), L(3,67,0), L(3,71,0),
    L(3,75,0), L(3,79,0), L(3,83,0), L(3,87,0), L(3,91,0), L(3,95,0), L(3,99,0), L(3,103,0),
    L(3,107,0), L(3,111,0), L(3,115,0), L(3,119,0), L(3,123,0), L(3,127,0), L(3,131,0), L(3,135,0),
    L(3,139,0), L(3,143,0), L(3,147,0), L(3,151,0), L(3,155,0), L(3,159,0), L(3,163,0), L(3,167,0),
    L(3,171,0), L(3,175,0), L(3,179,0), L(3,183,0), L(3,187,0), L(3,191,0), L(3,195,0), L(3,199,0),
    L(3,203,0), L(3,207,0), L(3,211,0), L(3,215,0), L(3,219,0), L(3,223,0), L(3,227,0), L(3,231,0),
    L(3,235,0), L(3,239,0), L(3,243,0), L(3,247,0)
]);

// Level 16: Dash Master
LEVELS[16] = createLevel(16, [
    L(15,10,2), L(15,14,2), L(15,18,2), L(15,22,2), L(15,26,2), L(15,30,2), L(15,34,2), L(15,38,2),
    L(15,42,2), L(15,46,2), L(15,50,2), L(15,54,2), L(15,58,2), L(15,62,2), L(15,66,2), L(15,70,2),
    L(15,74,2), L(15,78,2), L(15,82,2), L(15,86,2), L(15,90,2), L(15,94,2), L(15,98,2), L(15,102,2),
    L(15,106,2), L(15,110,2), L(15,114,2), L(15,118,2), L(15,122,2), L(15,126,2), L(15,130,2), L(15,134,2),
    L(15,138,2), L(15,142,2), L(15,146,2), L(15,150,2), L(15,154,2), L(15,158,2), L(15,162,2), L(15,166,2),
    L(15,170,2), L(15,174,2), L(15,178,2), L(15,182,2), L(15,186,2), L(15,190,2), L(15,194,2), L(15,198,2),
    L(15,202,2), L(15,206,2), L(15,210,2), L(15,214,2), L(15,218,2), L(15,222,2), L(15,226,2), L(15,230,2),
    L(15,234,2), L(15,238,2), L(15,242,2), L(15,246,2),
    L(1,12,0), L(1,16,0), L(1,20,0), L(1,24,0), L(1,28,0), L(1,32,0), L(1,36,0), L(1,40,0),
    L(1,44,0), L(1,48,0), L(1,52,0), L(1,56,0), L(1,60,0), L(1,64,0), L(1,68,0), L(1,72,0),
    L(1,76,0), L(1,80,0), L(1,84,0), L(1,88,0), L(1,92,0), L(1,96,0), L(1,100,0), L(1,104,0),
    L(1,108,0), L(1,112,0), L(1,116,0), L(1,120,0), L(1,124,0), L(1,128,0), L(1,132,0), L(1,136,0),
    L(1,140,0), L(1,144,0), L(1,148,0), L(1,152,0), L(1,156,0), L(1,160,0), L(1,164,0), L(1,168,0),
    L(1,172,0), L(1,176,0), L(1,180,0), L(1,184,0), L(1,188,0), L(1,192,0), L(1,196,0), L(1,200,0),
    L(1,204,0), L(1,208,0), L(1,212,0), L(1,216,0), L(1,220,0), L(1,224,0), L(1,228,0), L(1,232,0),
    L(1,236,0), L(1,240,0), L(1,244,0), L(1,248,0),
    L(3,13,0), L(3,17,0), L(3,21,0), L(3,25,0), L(3,29,0), L(3,33,0), L(3,37,0), L(3,41,0),
    L(3,45,0), L(3,49,0), L(3,53,0), L(3,57,0), L(3,61,0), L(3,65,0), L(3,69,0), L(3,73,0),
    L(3,77,0), L(3,81,0), L(3,85,0), L(3,89,0), L(3,93,0), L(3,97,0), L(3,101,0), L(3,105,0),
    L(3,109,0), L(3,113,0), L(3,117,0), L(3,121,0), L(3,125,0), L(3,129,0), L(3,133,0), L(3,137,0),
    L(3,141,0), L(3,145,0), L(3,149,0), L(3,153,0), L(3,157,0), L(3,161,0), L(3,165,0), L(3,169,0),
    L(3,173,0), L(3,177,0), L(3,181,0), L(3,185,0), L(3,189,0), L(3,193,0), L(3,197,0), L(3,201,0),
    L(3,205,0), L(3,209,0), L(3,213,0), L(3,217,0), L(3,221,0), L(3,225,0), L(3,229,0), L(3,233,0),
    L(3,237,0), L(3,241,0), L(3,245,0), L(3,249,0)
]);

// Level 17: Slow Motion Zone
LEVELS[17] = createLevel(17, [
    L(16,10,2), L(16,14,2), L(16,18,2), L(16,22,2), L(16,26,2), L(16,30,2), L(16,34,2), L(16,38,2),
    L(16,42,2), L(16,46,2), L(16,50,2), L(16,54,2), L(16,58,2), L(16,62,2), L(16,66,2), L(16,70,2),
    L(16,74,2), L(16,78,2), L(16,82,2), L(16,86,2), L(16,90,2), L(16,94,2), L(16,98,2), L(16,102,2),
    L(16,106,2), L(16,110,2), L(16,114,2), L(16,118,2), L(16,122,2), L(16,126,2), L(16,130,2), L(16,134,2),
    L(16,138,2), L(16,142,2), L(16,146,2), L(16,150,2), L(16,154,2), L(16,158,2), L(16,162,2), L(16,166,2),
    L(16,170,2), L(16,174,2), L(16,178,2), L(16,182,2), L(16,186,2), L(16,190,2), L(16,194,2), L(16,198,2),
    L(16,202,2), L(16,206,2), L(16,210,2), L(16,214,2), L(16,218,2), L(16,222,2), L(16,226,2), L(16,230,2),
    L(16,234,2), L(16,238,2), L(16,242,2), L(16,246,2),
    L(2,12,0), L(2,16,0), L(2,20,0), L(2,24,0), L(2,28,0), L(2,32,0), L(2,36,0), L(2,40,0),
    L(2,44,0), L(2,48,0), L(2,52,0), L(2,56,0), L(2,60,0), L(2,64,0), L(2,68,0), L(2,72,0),
    L(2,76,0), L(2,80,0), L(2,84,0), L(2,88,0), L(2,92,0), L(2,96,0), L(2,100,0), L(2,104,0),
    L(2,108,0), L(2,112,0), L(2,116,0), L(2,120,0), L(2,124,0), L(2,128,0), L(2,132,0), L(2,136,0),
    L(2,140,0), L(2,144,0), L(2,148,0), L(2,152,0), L(2,156,0), L(2,160,0), L(2,164,0), L(2,168,0),
    L(2,172,0), L(2,176,0), L(2,180,0), L(2,184,0), L(2,188,0), L(2,192,0), L(2,196,0), L(2,200,0),
    L(2,204,0), L(2,208,0), L(2,212,0), L(2,216,0), L(2,220,0), L(2,224,0), L(2,228,0), L(2,232,0),
    L(2,236,0), L(2,240,0), L(2,244,0), L(2,248,0),
    L(3,13,0), L(3,17,0), L(3,21,0), L(3,25,0), L(3,29,0), L(3,33,0), L(3,37,0), L(3,41,0),
    L(3,45,0), L(3,49,0), L(3,53,0), L(3,57,0), L(3,61,0), L(3,65,0), L(3,69,0), L(3,73,0),
    L(3,77,0), L(3,81,0), L(3,85,0), L(3,89,0), L(3,93,0), L(3,97,0), L(3,101,0), L(3,105,0),
    L(3,109,0), L(3,113,0), L(3,117,0), L(3,121,0), L(3,125,0), L(3,129,0), L(3,133,0), L(3,137,0),
    L(3,141,0), L(3,145,0), L(3,149,0), L(3,153,0), L(3,157,0), L(3,161,0), L(3,165,0), L(3,169,0),
    L(3,173,0), L(3,177,0), L(3,181,0), L(3,185,0), L(3,189,0), L(3,193,0), L(3,197,0), L(3,201,0),
    L(3,205,0), L(3,209,0), L(3,213,0), L(3,217,0), L(3,221,0), L(3,225,0), L(3,229,0), L(3,233,0),
    L(3,237,0), L(3,241,0), L(3,245,0), L(3,249,0)
]);

// Level 18: Mini Giant
LEVELS[18] = createLevel(18, [
    L(9,10,2), L(10,14,2), L(9,18,2), L(10,22,2), L(9,26,2), L(10,30,2), L(9,34,2), L(10,38,2),
    L(9,42,2), L(10,46,2), L(9,50,2), L(10,54,2), L(9,58,2), L(10,62,2), L(9,66,2), L(10,70,2),
    L(9,74,2), L(10,78,2), L(9,82,2), L(10,86,2), L(9,90,2), L(10,94,2), L(9,98,2), L(10,102,2),
    L(9,106,2), L(10,110,2), L(9,114,2), L(10,118,2), L(9,122,2), L(10,126,2), L(9,130,2), L(10,134,2),
    L(9,138,2), L(10,142,2), L(9,146,2), L(10,150,2), L(9,154,2), L(10,158,2), L(9,162,2), L(10,166,2),
    L(9,170,2), L(10,174,2), L(9,178,2), L(10,182,2), L(9,186,2), L(10,190,2), L(9,194,2), L(10,198,2),
    L(9,202,2), L(10,206,2), L(9,210,2), L(10,214,2), L(9,218,2), L(10,222,2), L(9,226,2), L(10,230,2),
    L(9,234,2), L(10,238,2), L(9,242,2), L(10,246,2),
    L(1,12,0), L(1,16,0), L(1,20,0), L(1,24,0), L(1,28,0), L(1,32,0), L(1,36,0), L(1,40,0),
    L(1,44,0), L(1,48,0), L(1,52,0), L(1,56,0), L(1,60,0), L(1,64,0), L(1,68,0), L(1,72,0),
    L(1,76,0), L(1,80,0), L(1,84,0), L(1,88,0), L(1,92,0), L(1,96,0), L(1,100,0), L(1,104,0),
    L(1,108,0), L(1,112,0), L(1,116,0), L(1,120,0), L(1,124,0), L(1,128,0), L(1,132,0), L(1,136,0),
    L(1,140,0), L(1,144,0), L(1,148,0), L(1,152,0), L(1,156,0), L(1,160,0), L(1,164,0), L(1,168,0),
    L(1,172,0), L(1,176,0), L(1,180,0), L(1,184,0), L(1,188,0), L(1,192,0), L(1,196,0), L(1,200,0),
    L(1,204,0), L(1,208,0), L(1,212,0), L(1,216,0), L(1,220,0), L(1,224,0), L(1,228,0), L(1,232,0),
    L(1,236,0), L(1,240,0), L(1,244,0), L(1,248,0),
    L(3,13,0), L(3,17,0), L(3,21,0), L(3,25,0), L(3,29,0), L(3,33,0), L(3,37,0), L(3,41,0),
    L(3,45,0), L(3,49,0), L(3,53,0), L(3,57,0), L(3,61,0), L(3,65,0), L(3,69,0), L(3,73,0),
    L(3,77,0), L(3,81,0), L(3,85,0), L(3,89,0), L(3,93,0), L(3,97,0), L(3,101,0), L(3,105,0),
    L(3,109,0), L(3,113,0), L(3,117,0), L(3,121,0), L(3,125,0), L(3,129,0), L(3,133,0), L(3,137,0),
    L(3,141,0), L(3,145,0), L(3,149,0), L(3,153,0), L(3,157,0), L(3,161,0), L(3,165,0), L(3,169,0),
    L(3,173,0), L(3,177,0), L(3,181,0), L(3,185,0), L(3,189,0), L(3,193,0), L(3,197,0), L(3,201,0),
    L(3,205,0), L(3,209,0), L(3,213,0), L(3,217,0), L(3,221,0), L(3,225,0), L(3,229,0), L(3,233,0),
    L(3,237,0), L(3,241,0), L(3,245,0), L(3,249,0)
]);

// Level 19: Portal Party
LEVELS[19] = createLevel(19, [
    L(4,10,2), L(5,14,2), L(6,18,2), L(11,22,2), L(12,26,2), L(14,30,2), L(4,34,2), L(5,38,2),
    L(6,42,2), L(11,46,2), L(12,50,2), L(14,54,2), L(4,58,2), L(5,62,2), L(6,66,2), L(11,70,2),
    L(12,74,2), L(14,78,2), L(4,82,2), L(5,86,2), L(6,90,2), L(11,94,2), L(12,98,2), L(14,102,2),
    L(4,106,2), L(5,110,2), L(6,114,2), L(11,118,2), L(12,122,2), L(14,126,2), L(4,130,2), L(5,134,2),
    L(6,138,2), L(11,142,2), L(12,146,2), L(14,150,2), L(4,154,2), L(5,158,2), L(6,162,2), L(11,166,2),
    L(12,170,2), L(14,174,2), L(4,178,2), L(5,182,2), L(6,186,2), L(11,190,2), L(12,194,2), L(14,198,2),
    L(4,202,2), L(5,206,2), L(6,210,2), L(11,214,2), L(12,218,2), L(14,222,2), L(4,226,2), L(5,230,2),
    L(6,234,2), L(11,238,2), L(12,242,2), L(14,246,2),
    L(1,12,0), L(1,16,0), L(1,20,0), L(1,24,0), L(1,28,0), L(1,32,0), L(1,36,0), L(1,40,0),
    L(1,44,0), L(1,48,0), L(1,52,0), L(1,56,0), L(1,60,0), L(1,64,0), L(1,68,0), L(1,72,0),
    L(1,76,0), L(1,80,0), L(1,84,0), L(1,88,0), L(1,92,0), L(1,96,0), L(1,100,0), L(1,104,0),
    L(1,108,0), L(1,112,0), L(1,116,0), L(1,120,0), L(1,124,0), L(1,128,0), L(1,132,0), L(1,136,0),
    L(1,140,0), L(1,144,0), L(1,148,0), L(1,152,0), L(1,156,0), L(1,160,0), L(1,164,0), L(1,168,0),
    L(1,172,0), L(1,176,0), L(1,180,0), L(1,184,0), L(1,188,0), L(1,192,0), L(1,196,0), L(1,200,0),
    L(1,204,0), L(1,208,0), L(1,212,0), L(1,216,0), L(1,220,0), L(1,224,0), L(1,228,0), L(1,232,0),
    L(1,236,0), L(1,240,0), L(1,244,0), L(1,248,0),
    L(3,13,0), L(3,17,0), L(3,21,0), L(3,25,0), L(3,29,0), L(3,33,0), L(3,37,0), L(3,41,0),
    L(3,45,0), L(3,49,0), L(3,53,0), L(3,57,0), L(3,61,0), L(3,65,0), L(3,69,0), L(3,73,0),
    L(3,77,0), L(3,81,0), L(3,85,0), L(3,89,0), L(3,93,0), L(3,97,0), L(3,101,0), L(3,105,0),
    L(3,109,0), L(3,113,0), L(3,117,0), L(3,121,0), L(3,125,0), L(3,129,0), L(3,133,0), L(3,137,0),
    L(3,141,0), L(3,145,0), L(3,149,0), L(3,153,0), L(3,157,0), L(3,161,0), L(3,165,0), L(3,169,0),
    L(3,173,0), L(3,177,0), L(3,181,0), L(3,185,0), L(3,189,0), L(3,193,0), L(3,197,0), L(3,201,0),
    L(3,205,0), L(3,209,0), L(3,213,0), L(3,217,0), L(3,221,0), L(3,225,0), L(3,229,0), L(3,233,0),
    L(3,237,0), L(3,241,0), L(3,245,0), L(3,249,0)
]);

// Level 20: Moving Platform Mayhem
LEVELS[20] = createLevel(20, [
    L(20,10,2), L(20,14,4), L(20,18,2), L(20,22,4), L(20,26,2), L(20,30,4), L(20,34,2), L(20,38,4),
    L(20,42,2), L(20,46,4), L(20,50,2), L(20,54,4), L(20,58,2), L(20,62,4), L(20,66,2), L(20,70,4),
    L(20,74,2), L(20,78,4), L(20,82,2), L(20,86,4), L(20,90,2), L(20,94,4), L(20,98,2), L(20,102,4),
    L(20,106,2), L(20,110,4), L(20,114,2), L(20,118,4), L(20,122,2), L(20,126,4), L(20,130,2), L(20,134,4),
    L(20,138,2), L(20,142,4), L(20,146,2), L(20,150,4), L(20,154,2), L(20,158,4), L(20,162,2), L(20,166,4),
    L(20,170,2), L(20,174,4), L(20,178,2), L(20,182,4), L(20,186,2), L(20,190,4), L(20,194,2), L(20,198,4),
    L(20,202,2), L(20,206,4), L(20,210,2), L(20,214,4), L(20,218,2), L(20,222,4), L(20,226,2), L(20,230,4),
    L(20,234,2), L(20,238,4), L(20,242,2), L(20,246,4),
    L(1,12,0), L(1,16,0), L(1,20,0), L(1,24,0), L(1,28,0), L(1,32,0), L(1,36,0), L(1,40,0),
    L(1,44,0), L(1,48,0), L(1,52,0), L(1,56,0), L(1,60,0), L(1,64,0), L(1,68,0), L(1,72,0),
    L(1,76,0), L(1,80,0), L(1,84,0), L(1,88,0), L(1,92,0), L(1,96,0), L(1,100,0), L(1,104,0),
    L(1,108,0), L(1,112,0), L(1,116,0), L(1,120,0), L(1,124,0), L(1,128,0), L(1,132,0), L(1,136,0),
    L(1,140,0), L(1,144,0), L(1,148,0), L(1,152,0), L(1,156,0), L(1,160,0), L(1,164,0), L(1,168,0),
    L(1,172,0), L(1,176,0), L(1,180,0), L(1,184,0), L(1,188,0), L(1,192,0), L(1,196,0), L(1,200,0),
    L(1,204,0), L(1,208,0), L(1,212,0), L(1,216,0), L(1,220,0), L(1,224,0), L(1,228,0), L(1,232,0),
    L(1,236,0), L(1,240,0), L(1,244,0), L(1,248,0),
    L(3,13,0), L(3,17,0), L(3,21,0), L(3,25,0), L(3,29,0), L(3,33,0), L(3,37,0), L(3,41,0),
    L(3,45,0), L(3,49,0), L(3,53,0), L(3,57,0), L(3,61,0), L(3,65,0), L(3,69,0), L(3,73,0),
    L(3,77,0), L(3,81,0), L(3,85,0), L(3,89,0), L(3,93,0), L(3,97,0), L(3,101,0), L(3,105,0),
    L(3,109,0), L(3,113,0), L(3,117,0), L(3,121,0), L(3,125,0), L(3,129,0), L(3,133,0), L(3,137,0),
    L(3,141,0), L(3,145,0), L(3,149,0), L(3,153,0), L(3,157,0), L(3,161,0), L(3,165,0), L(3,169,0),
    L(3,173,0), L(3,177,0), L(3,181,0), L(3,185,0), L(3,189,0), L(3,193,0), L(3,197,0), L(3,201,0),
    L(3,205,0), L(3,209,0), L(3,213,0), L(3,217,0), L(3,221,0), L(3,225,0), L(3,229,0), L(3,233,0),
    L(3,237,0), L(3,241,0), L(3,245,0), L(3,249,0)
]);

// Level 21: Neon Maze
LEVELS[21] = createLevel(21, [
    L(1,10,0), L(1,14,0), L(1,18,0), L(1,22,0), L(2,26,0), L(1,30,0), L(1,34,0), L(1,38,0),
    L(1,42,0), L(2,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(2,62,0), L(1,66,0), L(1,70,0),
    L(1,74,0), L(2,78,0), L(1,82,0), L(1,86,0), L(1,90,0), L(2,94,0), L(1,98,0), L(1,102,0),
    L(1,106,0), L(2,110,0), L(1,114,0), L(1,118,0), L(1,122,0), L(2,126,0), L(1,130,0), L(1,134,0),
    L(1,138,0), L(2,142,0), L(1,146,0), L(1,150,0), L(1,154,0), L(2,158,0), L(1,162,0), L(1,166,0),
    L(1,170,0), L(2,174,0), L(1,178,0), L(1,182,0), L(1,186,0), L(2,190,0), L(1,194,0), L(1,198,0),
    L(1,202,0), L(2,206,0), L(1,210,0), L(1,214,0), L(1,218,0), L(2,222,0), L(1,226,0), L(1,230,0),
    L(1,234,0), L(2,238,0), L(1,242,0), L(1,246,0), L(1,250,0),
    L(7,15,0), L(7,35,0), L(7,55,0), L(7,75,0), L(7,95,0), L(7,115,0), L(7,135,0), L(7,155,0),
    L(7,175,0), L(7,195,0), L(7,215,0), L(7,235,0), L(7,255,0),
    L(3,20,0), L(3,40,0), L(3,60,0), L(3,80,0), L(3,100,0), L(3,120,0), L(3,140,0), L(3,160,0),
    L(3,180,0), L(3,200,0), L(3,220,0), L(3,240,0), L(3,260,0)
]);

// Level 22: Gravity Switch
LEVELS[22] = createLevel(22, [
    L(1,10,0), L(16,15,2), L(1,20,0), L(16,25,2), L(1,30,0), L(16,35,2), L(1,40,0), L(16,45,2),
    L(1,50,0), L(16,55,2), L(1,60,0), L(16,65,2), L(1,70,0), L(16,75,2), L(1,80,0), L(16,85,2),
    L(1,90,0), L(16,95,2), L(1,100,0), L(16,105,2), L(1,110,0), L(16,115,2), L(1,120,0), L(16,125,2),
    L(1,130,0), L(16,135,2), L(1,140,0), L(16,145,2), L(1,150,0), L(16,155,2), L(1,160,0), L(16,165,2),
    L(1,170,0), L(16,175,2), L(1,180,0), L(16,185,2), L(1,190,0), L(16,195,2), L(1,200,0), L(16,205,2),
    L(1,210,0), L(16,215,2), L(1,220,0), L(16,225,2), L(1,230,0), L(16,235,2), L(1,240,0), L(16,245,2),
    L(1,250,0), L(16,255,2),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0), L(2,132,0), L(2,142,0), L(2,152,0), L(2,162,0),
    L(2,172,0), L(2,182,0), L(2,192,0), L(2,202,0), L(2,212,0), L(2,222,0), L(2,232,0), L(2,242,0),
    L(2,252,0),
    L(3,18,0), L(3,38,0), L(3,58,0), L(3,78,0), L(3,98,0), L(3,118,0), L(3,138,0), L(3,158,0),
    L(3,178,0), L(3,198,0), L(3,218,0), L(3,238,0), L(3,258,0)
]);

// Level 23: Speed Run
LEVELS[23] = createLevel(23, [
    L(15,10,2), L(15,12,2), L(15,14,2), L(15,16,2), L(15,18,2), L(15,20,2), L(15,22,2), L(15,24,2),
    L(15,26,2), L(15,28,2), L(15,30,2), L(15,32,2), L(15,34,2), L(15,36,2), L(15,38,2), L(15,40,2),
    L(15,42,2), L(15,44,2), L(15,46,2), L(15,48,2), L(15,50,2), L(15,52,2), L(15,54,2), L(15,56,2),
    L(15,58,2), L(15,60,2), L(15,62,2), L(15,64,2), L(15,66,2), L(15,68,2), L(15,70,2), L(15,72,2),
    L(15,74,2), L(15,76,2), L(15,78,2), L(15,80,2), L(15,82,2), L(15,84,2), L(15,86,2), L(15,88,2),
    L(15,90,2), L(15,92,2), L(15,94,2), L(15,96,2), L(15,98,2), L(15,100,2), L(15,102,2), L(15,104,2),
    L(15,106,2), L(15,108,2), L(15,110,2), L(15,112,2), L(15,114,2), L(15,116,2), L(15,118,2), L(15,120,2),
    L(15,122,2), L(15,124,2), L(15,126,2), L(15,128,2), L(15,130,2), L(15,132,2), L(15,134,2), L(15,136,2),
    L(15,138,2), L(15,140,2), L(15,142,2), L(15,144,2), L(15,146,2), L(15,148,2), L(15,150,2), L(15,152,2),
    L(15,154,2), L(15,156,2), L(15,158,2), L(15,160,2), L(15,162,2), L(15,164,2), L(15,166,2), L(15,168,2),
    L(15,170,2), L(15,172,2), L(15,174,2), L(15,176,2), L(15,178,2), L(15,180,2), L(15,182,2), L(15,184,2),
    L(15,186,2), L(15,188,2), L(15,190,2), L(15,192,2), L(15,194,2), L(15,196,2), L(15,198,2), L(15,200,2),
    L(15,202,2), L(15,204,2), L(15,206,2), L(15,208,2), L(15,210,2), L(15,212,2), L(15,214,2), L(15,216,2),
    L(15,218,2), L(15,220,2), L(15,222,2), L(15,224,2), L(15,226,2), L(15,228,2), L(15,230,2), L(15,232,2),
    L(15,234,2), L(15,236,2), L(15,238,2), L(15,240,2), L(15,242,2), L(15,244,2), L(15,246,2), L(15,248,2),
    L(1,11,0), L(1,13,0), L(1,15,0), L(1,17,0), L(1,19,0), L(1,21,0), L(1,23,0), L(1,25,0),
    L(1,27,0), L(1,29,0), L(1,31,0), L(1,33,0), L(1,35,0), L(1,37,0), L(1,39,0), L(1,41,0),
    L(1,43,0), L(1,45,0), L(1,47,0), L(1,49,0), L(1,51,0), L(1,53,0), L(1,55,0), L(1,57,0),
    L(1,59,0), L(1,61,0), L(1,63,0), L(1,65,0), L(1,67,0), L(1,69,0), L(1,71,0), L(1,73,0),
    L(1,75,0), L(1,77,0), L(1,79,0), L(1,81,0), L(1,83,0), L(1,85,0), L(1,87,0), L(1,89,0),
    L(1,91,0), L(1,93,0), L(1,95,0), L(1,97,0), L(1,99,0), L(1,101,0), L(1,103,0), L(1,105,0),
    L(1,107,0), L(1,109,0), L(1,111,0), L(1,113,0), L(1,115,0), L(1,117,0), L(1,119,0), L(1,121,0),
    L(1,123,0), L(1,125,0), L(1,127,0), L(1,129,0), L(1,131,0), L(1,133,0), L(1,135,0), L(1,137,0),
    L(1,139,0), L(1,141,0), L(1,143,0), L(1,145,0), L(1,147,0), L(1,149,0), L(1,151,0), L(1,153,0),
    L(1,155,0), L(1,157,0), L(1,159,0), L(1,161,0), L(1,163,0), L(1,165,0), L(1,167,0), L(1,169,0),
    L(1,171,0), L(1,173,0), L(1,175,0), L(1,177,0), L(1,179,0), L(1,181,0), L(1,183,0), L(1,185,0),
    L(1,187,0), L(1,189,0), L(1,191,0), L(1,193,0), L(1,195,0), L(1,197,0), L(1,199,0), L(1,201,0),
    L(1,203,0), L(1,205,0), L(1,207,0), L(1,209,0), L(1,211,0), L(1,213,0), L(1,215,0), L(1,217,0),
    L(1,219,0), L(1,221,0), L(1,223,0), L(1,225,0), L(1,227,0), L(1,229,0), L(1,231,0), L(1,233,0),
    L(1,235,0), L(1,237,0), L(1,239,0), L(1,241,0), L(1,243,0), L(1,245,0), L(1,247,0), L(1,249,0),
    L(3,14,0), L(3,34,0), L(3,54,0), L(3,74,0), L(3,94,0), L(3,114,0), L(3,134,0), L(3,154,0),
    L(3,174,0), L(3,194,0), L(3,214,0), L(3,234,0), L(3,254,0)
]);

// Level 24: Color Chaos
LEVELS[24] = createLevel(24, [
    L(1,10,0), L(7,15,0), L(2,20,0), L(15,25,2), L(1,30,0), L(16,35,2), L(2,40,0), L(11,45,2),
    L(1,50,0), L(5,55,2), L(2,60,0), L(4,65,2), L(1,70,0), L(12,75,0), L(2,80,0), L(14,85,2),
    L(1,90,0), L(9,95,2), L(2,100,0), L(10,105,2), L(1,110,0), L(13,115,2), L(2,120,0), L(20,125,2),
    L(1,130,0), L(7,135,0), L(2,140,0), L(15,145,2), L(1,150,0), L(16,155,2), L(2,160,0), L(11,165,2),
    L(1,170,0), L(5,175,2), L(2,180,0), L(4,185,2), L(1,190,0), L(12,195,0), L(2,200,0), L(14,205,2),
    L(1,210,0), L(9,215,2), L(2,220,0), L(10,225,2), L(1,230,0), L(13,235,2), L(2,240,0), L(20,245,2),
    L(1,250,0),
    L(3,12,0), L(3,22,0), L(3,32,0), L(3,42,0), L(3,52,0), L(3,62,0), L(3,72,0), L(3,82,0),
    L(3,92,0), L(3,102,0), L(3,112,0), L(3,122,0), L(3,132,0), L(3,142,0), L(3,152,0), L(3,162,0),
    L(3,172,0), L(3,182,0), L(3,192,0), L(3,202,0), L(3,212,0), L(3,222,0), L(3,232,0), L(3,242,0),
    L(3,252,0)
]);

// Level 25: Precision Platforming
LEVELS[25] = createLevel(25, [
    L(1,10,0), L(1,15,1), L(1,20,2), L(1,25,3), L(1,30,4), L(1,35,5), L(1,40,6), L(1,45,7),
    L(1,50,6), L(1,55,5), L(1,60,4), L(1,65,3), L(1,70,2), L(1,75,1), L(1,80,0),
    L(1,85,1), L(1,90,2), L(1,95,3), L(1,100,4), L(1,105,5), L(1,110,6), L(1,115,7),
    L(1,120,6), L(1,125,5), L(1,130,4), L(1,135,3), L(1,140,2), L(1,145,1), L(1,150,0),
    L(1,155,1), L(1,160,2), L(1,165,3), L(1,170,4), L(1,175,5), L(1,180,6), L(1,185,7),
    L(1,190,6), L(1,195,5), L(1,200,4), L(1,205,3), L(1,210,2), L(1,215,1), L(1,220,0),
    L(1,225,1), L(1,230,2), L(1,235,3), L(1,240,4), L(1,245,5), L(1,250,6),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0), L(2,132,0), L(2,142,0), L(2,152,0), L(2,162,0),
    L(2,172,0), L(2,182,0), L(2,192,0), L(2,202,0), L(2,212,0), L(2,222,0), L(2,232,0), L(2,242,0),
    L(2,252,0),
    L(3,18,3), L(3,38,3), L(3,58,3), L(3,78,3), L(3,98,3), L(3,118,3), L(3,138,3), L(3,158,3),
    L(3,178,3), L(3,198,3), L(3,218,3), L(3,238,3), L(3,258,3)
]);

// Levels 26-50: More unique levels (each completely different)
// Due to character limit, I'll create 25 more unique levels with brief descriptions

// Level 26: Wave Dash Combo
LEVELS[26] = createLevel(26, [
    L(11,10,2), L(15,15,2), L(11,20,2), L(15,25,2), L(11,30,2), L(15,35,2), L(11,40,2), L(15,45,2),
    L(11,50,2), L(15,55,2), L(11,60,2), L(15,65,2), L(11,70,2), L(15,75,2), L(11,80,2), L(15,85,2),
    L(1,12,0), L(1,22,0), L(1,32,0), L(1,42,0), L(1,52,0), L(1,62,0), L(1,72,0), L(1,82,0),
    L(2,14,0), L(2,24,0), L(2,34,0), L(2,44,0), L(2,54,0), L(2,64,0), L(2,74,0), L(2,84,0),
    L(3,16,1), L(3,36,1), L(3,56,1), L(3,76,1), L(3,96,1)
]);

// Level 27: UFO Precision 2
LEVELS[27] = createLevel(27, [
    L(5,10,2), L(2,15,1), L(2,20,3), L(2,25,1), L(2,30,3), L(2,35,1), L(2,40,3), L(2,45,1),
    L(2,50,3), L(2,55,1), L(2,60,3), L(2,65,1), L(2,70,3), L(2,75,1), L(2,80,3), L(2,85,1),
    L(2,90,3), L(2,95,1), L(2,100,3), L(2,105,1), L(2,110,3), L(2,115,1), L(2,120,3), L(2,125,1),
    L(1,14,0), L(1,24,0), L(1,34,0), L(1,44,0), L(1,54,0), L(1,64,0), L(1,74,0), L(1,84,0),
    L(1,94,0), L(1,104,0), L(1,114,0), L(1,124,0), L(1,134,0), L(1,144,0),
    L(3,18,2), L(3,38,2), L(3,58,2), L(3,78,2), L(3,98,2), L(3,118,2), L(3,138,2)
]);

// Level 28: Robot Mini Challenge 2
LEVELS[28] = createLevel(28, [
    L(12,10,0), L(9,15,2), L(1,20,0), L(7,25,0), L(1,30,0), L(9,35,2), L(1,40,0), L(7,45,0),
    L(1,50,0), L(9,55,2), L(1,60,0), L(7,65,0), L(1,70,0), L(9,75,2), L(1,80,0), L(7,85,0),
    L(1,90,0), L(9,95,2), L(1,100,0), L(7,105,0), L(1,110,0), L(9,115,2), L(1,120,0), L(7,125,0),
    L(2,22,0), L(2,42,0), L(2,62,0), L(2,82,0), L(2,102,0), L(2,122,0),
    L(3,18,0), L(3,38,0), L(3,58,0), L(3,78,0), L(3,98,0), L(3,118,0)
]);

// Level 29: Swing Macro Adventure 2
LEVELS[29] = createLevel(29, [
    L(14,10,2), L(10,15,2), L(1,20,0), L(1,20,4), L(1,25,2), L(1,30,0), L(1,30,4), L(1,35,2),
    L(1,40,0), L(1,40,4), L(1,45,2), L(1,50,0), L(1,50,4), L(1,55,2), L(1,60,0), L(1,60,4),
    L(1,65,2), L(1,70,0), L(1,70,4), L(1,75,2), L(1,80,0), L(1,80,4), L(1,85,2), L(1,90,0),
    L(1,90,4), L(1,95,2), L(1,100,0), L(1,100,4), L(1,105,2), L(1,110,0), L(1,110,4), L(1,115,2),
    L(2,22,1), L(2,42,1), L(2,62,1), L(2,82,1), L(2,102,1), L(2,122,1),
    L(3,18,2), L(3,38,2), L(3,58,2), L(3,78,2), L(3,98,2), L(3,118,2)
]);

// Level 30: Gravity Dash Combo
LEVELS[30] = createLevel(30, [
    L(16,10,2), L(15,15,2), L(16,20,2), L(15,25,2), L(16,30,2), L(15,35,2), L(16,40,2), L(15,45,2),
    L(16,50,2), L(15,55,2), L(16,60,2), L(15,65,2), L(16,70,2), L(15,75,2), L(16,80,2), L(15,85,2),
    L(1,12,0), L(1,22,0), L(1,32,0), L(1,42,0), L(1,52,0), L(1,62,0), L(1,72,0), L(1,82,0),
    L(7,14,0), L(7,24,0), L(7,34,0), L(7,44,0), L(7,54,0), L(7,64,0), L(7,74,0), L(7,84,0),
    L(3,16,1), L(3,36,1), L(3,56,1), L(3,76,1), L(3,96,1)
]);

// Continue creating unique levels 31-50...
// Due to character limits, I'll create a few more and note that the pattern continues

// Level 31: Laser Grid 2
LEVELS[31] = createLevel(31, [
    L(2,10,0), L(2,10,8), L(2,15,0), L(2,15,8), L(2,20,0), L(2,20,8), L(2,25,0), L(2,25,8),
    L(2,30,0), L(2,30,8), L(2,35,0), L(2,35,8), L(2,40,0), L(2,40,8), L(2,45,0), L(2,45,8),
    L(2,50,0), L(2,50,8), L(2,55,0), L(2,55,8), L(2,60,0), L(2,60,8), L(2,65,0), L(2,65,8),
    L(2,70,0), L(2,70,8), L(2,75,0), L(2,75,8), L(2,80,0), L(2,80,8), L(2,85,0), L(2,85,8),
    L(1,12,4), L(1,17,4), L(1,22,4), L(1,27,4), L(1,32,4), L(1,37,4), L(1,42,4), L(1,47,4),
    L(1,52,4), L(1,57,4), L(1,62,4), L(1,67,4), L(1,72,4), L(1,77,4), L(1,82,4), L(1,87,4),
    L(7,14,4), L(7,24,4), L(7,34,4), L(7,44,4), L(7,54,4), L(7,64,4), L(7,74,4), L(7,84,4),
    L(3,18,4), L(3,38,4), L(3,58,4), L(3,78,4), L(3,98,4)
]);

// Level 32: Bounce Maze 2
LEVELS[32] = createLevel(32, [
    L(7,10,0), L(7,12,0), L(2,14,0), L(7,16,0), L(7,18,0), L(2,20,0), L(7,22,0), L(7,24,0),
    L(2,26,0), L(7,28,0), L(7,30,0), L(2,32,0), L(7,34,0), L(7,36,0), L(2,38,0), L(7,40,0),
    L(7,42,0), L(2,44,0), L(7,46,0), L(7,48,0), L(2,50,0), L(7,52,0), L(7,54,0), L(2,56,0),
    L(7,58,0), L(7,60,0), L(2,62,0), L(7,64,0), L(7,66,0), L(2,68,0), L(7,70,0), L(7,72,0),
    L(2,74,0), L(7,76,0), L(7,78,0), L(2,80,0), L(7,82,0), L(7,84,0), L(2,86,0), L(7,88,0),
    L(7,90,0), L(2,92,0), L(7,94,0), L(7,96,0), L(2,98,0), L(7,100,0), L(7,102,0), L(2,104,0),
    L(1,11,0), L(1,21,0), L(1,31,0), L(1,41,0), L(1,51,0), L(1,61,0), L(1,71,0), L(1,81,0),
    L(1,91,0), L(1,101,0), L(1,111,0),
    L(3,15,0), L(3,35,0), L(3,55,0), L(3,75,0), L(3,95,0), L(3,115,0)
]);

// Level 33: Dash Race 2
LEVELS[33] = createLevel(33, [
    L(15,10,2), L(1,15,0), L(15,20,2), L(1,25,0), L(15,30,2), L(1,35,0), L(15,40,2), L(1,45,0),
    L(15,50,2), L(1,55,0), L(15,60,2), L(1,65,0), L(15,70,2), L(1,75,0), L(15,80,2), L(1,85,0),
    L(15,90,2), L(1,95,0), L(15,100,2), L(1,105,0), L(15,110,2), L(1,115,0), L(15,120,2), L(1,125,0),
    L(15,130,2), L(1,135,0), L(15,140,2), L(1,145,0), L(15,150,2), L(1,155,0), L(15,160,2), L(1,165,0),
    L(15,170,2), L(1,175,0), L(15,180,2), L(1,185,0), L(15,190,2), L(1,195,0), L(15,200,2), L(1,205,0),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0), L(2,132,0), L(2,142,0), L(2,152,0), L(2,162,0),
    L(2,172,0), L(2,182,0), L(2,192,0), L(2,202,0), L(2,212,0),
    L(3,18,0), L(3,38,0), L(3,58,0), L(3,78,0), L(3,98,0), L(3,118,0), L(3,138,0), L(3,158,0),
    L(3,178,0), L(3,198,0), L(3,218,0)
]);

// Continue creating levels 34-50 with unique patterns...
// Each level would have completely unique layout and challenges

// Level 34: Slow Motion Dash 2
LEVELS[34] = createLevel(34, [
    L(16,10,2), L(15,15,2), L(1,20,0), L(16,25,2), L(15,30,2), L(1,35,0), L(16,40,2), L(15,45,2),
    L(1,50,0), L(16,55,2), L(15,60,2), L(1,65,0), L(16,70,2), L(15,75,2), L(1,80,0), L(16,85,2),
    L(15,90,2), L(1,95,0), L(16,100,2), L(15,105,2), L(1,110,0), L(16,115,2), L(15,120,2), L(1,125,0),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0), L(2,132,0),
    L(7,14,0), L(7,24,0), L(7,34,0), L(7,44,0), L(7,54,0), L(7,64,0), L(7,74,0), L(7,84,0),
    L(7,94,0), L(7,104,0), L(7,114,0), L(7,124,0),
    L(3,18,1), L(3,38,1), L(3,58,1), L(3,78,1), L(3,98,1), L(3,118,1)
]);

// Level 35: Mini Wave 2
LEVELS[35] = createLevel(35, [
    L(11,10,2), L(9,15,2), L(1,20,0), L(11,25,2), L(9,30,2), L(1,35,0), L(11,40,2), L(9,45,2),
    L(1,50,0), L(11,55,2), L(9,60,2), L(1,65,0), L(11,70,2), L(9,75,2), L(1,80,0), L(11,85,2),
    L(9,90,2), L(1,95,0), L(11,100,2), L(9,105,2), L(1,110,0), L(11,115,2), L(9,120,2), L(1,125,0),
    L(2,12,1), L(2,22,1), L(2,32,1), L(2,42,1), L(2,52,1), L(2,62,1), L(2,72,1), L(2,82,1),
    L(2,92,1), L(2,102,1), L(2,112,1), L(2,122,1),
    L(7,14,0), L(7,24,0), L(7,34,0), L(7,44,0), L(7,54,0), L(7,64,0), L(7,74,0), L(7,84,0),
    L(7,94,0), L(7,104,0), L(7,114,0), L(7,124,0),
    L(3,18,2), L(3,38,2), L(3,58,2), L(3,78,2), L(3,98,2), L(3,118,2)
]);

// Create the remaining levels 36-50 with similar unique patterns...
// For brevity, I'll note that levels 36-50 would each have:
// - Unique block arrangements
// - Different combinations of obstacles
// - Varied portal placements
// - Unique coin placements
// - Different jump pad arrangements
// - Varied spike patterns
// - Unique moving platform configurations

// Level 36: UFO Wave Combo
LEVELS[36] = createLevel(36, [
    L(5,10,2), L(11,20,2), L(5,30,2), L(11,40,2), L(5,50,2), L(11,60,2), L(5,70,2), L(11,80,2),
    L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0), L(1,55,0), L(1,65,0), L(1,75,0), L(1,85,0),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(7,14,0), L(7,24,0), L(7,34,0), L(7,44,0), L(7,54,0), L(7,64,0), L(7,74,0), L(7,84,0),
    L(3,18,1), L(3,38,1), L(3,58,1), L(3,78,1), L(3,98,1)
]);

// Continue this pattern for levels 37-50, ensuring each is unique...

    // Level 37: Vertical Gauntlet
LEVELS[37] = createLevel(37, [
    L(1,10,0), L(1,14,0), L(1,18,0), L(1,22,0), L(1,26,0), L(7,30,0), L(1,34,0), L(1,38,0), L(1,42,0),
    L(2,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(2,62,0), L(1,66,0), L(1,70,0), L(1,74,0), L(2,78,0),
    L(1,82,0), L(1,86,0), L(1,90,0), L(2,94,0), L(1,98,0), L(1,102,0), L(1,106,0), L(2,110,0),
    L(4,114,2), L(1,118,0), L(1,122,0), L(1,126,0), L(1,130,0), L(1,134,0), L(1,138,0), L(1,142,0),
    L(2,146,2), L(2,150,0), L(2,154,2), L(2,158,0), L(2,162,2), L(2,166,0), L(2,170,2), L(2,174,0),
    L(1,178,0), L(1,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(1,198,0), L(1,202,0), L(1,206,0),
    L(5,210,2), L(1,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(1,230,0), L(1,234,0), L(1,238,0),
    L(2,242,2), L(2,246,0), L(2,250,2), L(2,254,0), L(2,258,2), L(2,262,0), L(2,266,2), L(2,270,0),
    L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0), L(1,298,0), L(1,302,0),
    L(11,306,2), L(1,310,0), L(1,314,0), L(1,318,0), L(1,322,0), L(1,326,0), L(1,330,0), L(1,334,0),
    L(2,338,2), L(2,342,0), L(2,346,2), L(2,350,0), L(2,354,2), L(2,358,0), L(2,362,2), L(2,366,0),
    L(1,370,0), L(1,374,0), L(1,378,0), L(1,382,0), L(1,386,0), L(1,390,0), L(1,394,0), L(1,398,0),
    L(12,402,0), L(9,406,2), L(1,410,0), L(1,414,0), L(1,418,0), L(1,422,0), L(1,426,0), L(1,430,0),
    L(2,434,0), L(2,438,0), L(2,442,0), L(2,446,0), L(2,450,0), L(2,454,0), L(2,458,0), L(2,462,0),
    L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0), L(1,490,0), L(1,494,0),
    L(14,498,2), L(10,502,2), L(1,506,0), L(1,510,0), L(1,514,0), L(1,518,0), L(1,522,0), L(1,526,0),
    L(2,530,0), L(2,534,0), L(2,538,0), L(2,542,0), L(2,546,0), L(2,550,0), L(2,554,0), L(2,558,0),
    L(1,562,0), L(1,566,0), L(1,570,0), L(1,574,0), L(1,578,0), L(1,582,0), L(1,586,0), L(1,590,0),
    L(15,594,2), L(1,598,0), L(1,602,0), L(1,606,0), L(1,610,0), L(1,614,0), L(1,618,0), L(1,622,0),
    L(2,626,0), L(2,630,0), L(2,634,0), L(2,638,0), L(2,642,0), L(2,646,0), L(2,650,0), L(2,654,0),
    L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0), L(1,682,0), L(1,686,0),
    L(3,12,0), L(3,20,0), L(3,28,0), L(3,36,0), L(3,44,0), L(3,52,0), L(3,60,0), L(3,68,0),
    L(3,76,0), L(3,84,0), L(3,92,0), L(3,100,0), L(3,108,0), L(3,116,0), L(3,124,0), L(3,132,0),
    L(3,140,0), L(3,148,0), L(3,156,0), L(3,164,0), L(3,172,0), L(3,180,0), L(3,188,0), L(3,196,0),
    L(3,204,0), L(3,212,0), L(3,220,0), L(3,228,0), L(3,236,0), L(3,244,0), L(3,252,0), L(3,260,0),
    L(3,268,0), L(3,276,0), L(3,284,0), L(3,292,0), L(3,300,0), L(3,308,0), L(3,316,0), L(3,324,0),
    L(3,332,0), L(3,340,0), L(3,348,0), L(3,356,0), L(3,364,0), L(3,372,0), L(3,380,0), L(3,388,0),
    L(3,396,0), L(3,404,0), L(3,412,0), L(3,420,0), L(3,428,0), L(3,436,0), L(3,444,0), L(3,452,0),
    L(3,460,0), L(3,468,0), L(3,476,0), L(3,484,0), L(3,492,0), L(3,500,0), L(3,508,0), L(3,516,0),
    L(3,524,0), L(3,532,0), L(3,540,0), L(3,548,0), L(3,556,0), L(3,564,0), L(3,572,0), L(3,580,0),
    L(3,588,0), L(3,596,0), L(3,604,0), L(3,612,0), L(3,620,0), L(3,628,0), L(3,636,0), L(3,644,0),
    L(3,652,0), L(3,660,0), L(3,668,0), L(3,676,0), L(3,684,0), L(3,692,0)
]);

// Level 38: Mega Speedway
LEVELS[38] = createLevel(38, [
    L(15,10,2), L(15,14,2), L(15,18,2), L(15,22,2), L(15,26,2), L(15,30,2), L(15,34,2), L(15,38,2),
    L(1,42,0), L(1,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(1,62,0), L(1,66,0), L(1,70,0),
    L(2,74,0), L(2,78,0), L(2,82,0), L(2,86,0), L(2,90,0), L(2,94,0), L(2,98,0), L(2,102,0),
    L(1,106,0), L(1,110,0), L(1,114,0), L(1,118,0), L(1,122,0), L(1,126,0), L(1,130,0), L(1,134,0),
    L(7,138,0), L(7,142,0), L(7,146,0), L(7,150,0), L(7,154,0), L(7,158,0), L(7,162,0), L(7,166,0),
    L(1,170,0), L(1,174,0), L(1,178,0), L(1,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(1,198,0),
    L(2,202,0), L(2,206,0), L(2,210,0), L(2,214,0), L(2,218,0), L(2,222,0), L(2,226,0), L(2,230,0),
    L(16,234,2), L(16,238,2), L(16,242,2), L(16,246,2), L(16,250,2), L(16,254,2), L(16,258,2), L(16,262,2),
    L(1,266,0), L(1,270,0), L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0),
    L(2,298,0), L(2,302,0), L(2,306,0), L(2,310,0), L(2,314,0), L(2,318,0), L(2,322,0), L(2,326,0),
    L(1,330,0), L(1,334,0), L(1,338,0), L(1,342,0), L(1,346,0), L(1,350,0), L(1,354,0), L(1,358,0),
    L(4,362,2), L(1,366,0), L(1,370,0), L(1,374,0), L(1,378,0), L(1,382,0), L(1,386,0), L(1,390,0),
    L(2,394,0), L(2,398,0), L(2,402,0), L(2,406,0), L(2,410,0), L(2,414,0), L(2,418,0), L(2,422,0),
    L(1,426,0), L(1,430,0), L(1,434,0), L(1,438,0), L(1,442,0), L(1,446,0), L(1,450,0), L(1,454,0),
    L(5,458,2), L(1,462,0), L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0),
    L(2,490,0), L(2,494,0), L(2,498,0), L(2,502,0), L(2,506,0), L(2,510,0), L(2,514,0), L(2,518,0),
    L(1,522,0), L(1,526,0), L(1,530,0), L(1,534,0), L(1,538,0), L(1,542,0), L(1,546,0), L(1,550,0),
    L(11,554,2), L(1,558,0), L(1,562,0), L(1,566,0), L(1,570,0), L(1,574,0), L(1,578,0), L(1,582,0),
    L(2,586,0), L(2,590,0), L(2,594,0), L(2,598,0), L(2,602,0), L(2,606,0), L(2,610,0), L(2,614,0),
    L(1,618,0), L(1,622,0), L(1,626,0), L(1,630,0), L(1,634,0), L(1,638,0), L(1,642,0), L(1,646,0),
    L(12,650,0), L(9,654,2), L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0),
    L(2,682,0), L(2,686,0), L(2,690,0), L(2,694,0), L(2,698,0), L(2,702,0), L(2,706,0), L(2,710,0),
    L(1,714,0), L(1,718,0), L(1,722,0), L(1,726,0), L(1,730,0), L(1,734,0), L(1,738,0), L(1,742,0),
    L(14,746,2), L(10,750,2), L(1,754,0), L(1,758,0), L(1,762,0), L(1,766,0), L(1,770,0), L(1,774,0),
    L(2,778,0), L(2,782,0), L(2,786,0), L(2,790,0), L(2,794,0), L(2,798,0), L(2,802,0), L(2,806,0),
    L(1,810,0), L(1,814,0), L(1,818,0), L(1,822,0), L(1,826,0), L(1,830,0), L(1,834,0), L(1,838,0),
    L(20,842,2), L(20,846,4), L(20,850,2), L(20,854,4), L(20,858,2), L(20,862,4), L(20,866,2), L(20,870,4),
    L(1,874,0), L(1,878,0), L(1,882,0), L(1,886,0), L(1,890,0), L(1,894,0), L(1,898,0), L(1,902,0),
    L(2,906,0), L(2,910,0), L(2,914,0), L(2,918,0), L(2,922,0), L(2,926,0), L(2,930,0), L(2,934,0),
    L(1,938,0), L(1,942,0), L(1,946,0), L(1,950,0), L(1,954,0), L(1,958,0), L(1,962,0), L(1,966,0),
    L(13,970,2), L(13,990,2), L(13,1010,2), L(13,1030,2), L(13,1050,2), L(13,1070,2), L(13,1090,2),
    L(3,15,0), L(3,35,0), L(3,55,0), L(3,75,0), L(3,95,0), L(3,115,0), L(3,135,0), L(3,155,0),
    L(3,175,0), L(3,195,0), L(3,215,0), L(3,235,0), L(3,255,0), L(3,275,0), L(3,295,0), L(3,315,0),
    L(3,335,0), L(3,355,0), L(3,375,0), L(3,395,0), L(3,415,0), L(3,435,0), L(3,455,0), L(3,475,0),
    L(3,495,0), L(3,515,0), L(3,535,0), L(3,555,0), L(3,575,0), L(3,595,0), L(3,615,0), L(3,635,0),
    L(3,655,0), L(3,675,0), L(3,695,0), L(3,715,0), L(3,735,0), L(3,755,0), L(3,775,0), L(3,795,0),
    L(3,815,0), L(3,835,0), L(3,855,0), L(3,875,0), L(3,895,0), L(3,915,0), L(3,935,0), L(3,955,0),
    L(3,975,0), L(3,995,0), L(3,1015,0), L(3,1035,0), L(3,1055,0), L(3,1075,0), L(3,1095,0)
]);

// Level 39: Portal Chaos
LEVELS[39] = createLevel(39, [
    L(4,10,2), L(1,14,0), L(1,18,0), L(1,22,0), L(5,26,2), L(1,30,0), L(1,34,0), L(1,38,0),
    L(6,42,2), L(1,46,0), L(1,50,0), L(1,54,0), L(11,58,2), L(1,62,0), L(1,66,0), L(1,70,0),
    L(12,74,0), L(9,78,2), L(1,82,0), L(1,86,0), L(1,90,0), L(14,94,2), L(10,98,2), L(1,102,0),
    L(1,106,0), L(1,110,0), L(15,114,2), L(1,118,0), L(1,122,0), L(1,126,0), L(16,130,2), L(1,134,0),
    L(1,138,0), L(1,142,0), L(4,146,2), L(1,150,0), L(1,154,0), L(1,158,0), L(5,162,2), L(1,166,0),
    L(1,170,0), L(1,174,0), L(6,178,2), L(1,182,0), L(1,186,0), L(1,190,0), L(11,194,2), L(1,198,0),
    L(1,202,0), L(1,206,0), L(12,210,0), L(9,214,2), L(1,218,0), L(1,222,0), L(1,226,0), L(14,230,2),
    L(10,234,2), L(1,238,0), L(1,242,0), L(1,246,0), L(15,250,2), L(1,254,0), L(1,258,0), L(1,262,0),
    L(16,266,2), L(1,270,0), L(1,274,0), L(1,278,0), L(4,282,2), L(1,286,0), L(1,290,0), L(1,294,0),
    L(5,298,2), L(1,302,0), L(1,306,0), L(1,310,0), L(6,314,2), L(1,318,0), L(1,322,0), L(1,326,0),
    L(11,330,2), L(1,334,0), L(1,338,0), L(1,342,0), L(12,346,0), L(9,350,2), L(1,354,0), L(1,358,0),
    L(1,362,0), L(14,366,2), L(10,370,2), L(1,374,0), L(1,378,0), L(1,382,0), L(15,386,2), L(1,390,0),
    L(1,394,0), L(1,398,0), L(16,402,2), L(1,406,0), L(1,410,0), L(1,414,0), L(4,418,2), L(1,422,0),
    L(1,426,0), L(1,430,0), L(5,434,2), L(1,438,0), L(1,442,0), L(1,446,0), L(6,450,2), L(1,454,0),
    L(1,458,0), L(1,462,0), L(11,466,2), L(1,470,0), L(1,474,0), L(1,478,0), L(12,482,0), L(9,486,2),
    L(1,490,0), L(1,494,0), L(1,498,0), L(14,502,2), L(10,506,2), L(1,510,0), L(1,514,0), L(1,518,0),
    L(15,522,2), L(1,526,0), L(1,530,0), L(1,534,0), L(16,538,2), L(1,542,0), L(1,546,0), L(1,550,0),
    L(4,554,2), L(1,558,0), L(1,562,0), L(1,566,0), L(5,570,2), L(1,574,0), L(1,578,0), L(1,582,0),
    L(6,586,2), L(1,590,0), L(1,594,0), L(1,598,0), L(11,602,2), L(1,606,0), L(1,610,0), L(1,614,0),
    L(12,618,0), L(9,622,2), L(1,626,0), L(1,630,0), L(1,634,0), L(14,638,2), L(10,642,2), L(1,646,0),
    L(1,650,0), L(1,654,0), L(15,658,2), L(1,662,0), L(1,666,0), L(1,670,0), L(16,674,2), L(1,678,0),
    L(1,682,0), L(1,686,0), L(4,690,2), L(1,694,0), L(1,698,0), L(1,702,0), L(5,706,2), L(1,710,0),
    L(1,714,0), L(1,718,0), L(6,722,2), L(1,726,0), L(1,730,0), L(1,734,0), L(11,738,2), L(1,742,0),
    L(1,746,0), L(1,750,0), L(12,754,0), L(9,758,2), L(1,762,0), L(1,766,0), L(1,770,0), L(14,774,2),
    L(10,778,2), L(1,782,0), L(1,786,0), L(1,790,0), L(15,794,2), L(1,798,0), L(1,802,0), L(1,806,0),
    L(16,810,2), L(1,814,0), L(1,818,0), L(1,822,0), L(4,826,2), L(1,830,0), L(1,834,0), L(1,838,0),
    L(5,842,2), L(1,846,0), L(1,850,0), L(1,854,0), L(6,858,2), L(1,862,0), L(1,866,0), L(1,870,0),
    L(11,874,2), L(1,878,0), L(1,882,0), L(1,886,0), L(12,890,0), L(9,894,2), L(1,898,0), L(1,902,0),
    L(1,906,0), L(14,910,2), L(10,914,2), L(1,918,0), L(1,922,0), L(1,926,0), L(15,930,2), L(1,934,0),
    L(1,938,0), L(1,942,0), L(16,946,2), L(1,950,0), L(1,954,0), L(1,958,0), L(4,962,2), L(1,966,0),
    L(1,970,0), L(1,974,0), L(5,978,2), L(1,982,0), L(1,986,0), L(1,990,0), L(6,994,2), L(1,998,0),
    L(1,1002,0), L(1,1006,0), L(11,1010,2), L(1,1014,0), L(1,1018,0), L(1,1022,0), L(12,1026,0),
    L(9,1030,2), L(1,1034,0), L(1,1038,0), L(1,1042,0), L(14,1046,2), L(10,1050,2), L(1,1054,0),
    L(1,1058,0), L(1,1062,0), L(15,1066,2), L(1,1070,0), L(1,1074,0), L(1,1078,0), L(16,1082,2),
    L(1,1086,0), L(1,1090,0), L(1,1094,0), L(4,1098,2), L(1,1102,0), L(1,1106,0), L(1,1110,0),
    L(2,20,0), L(2,40,0), L(2,60,0), L(2,80,0), L(2,100,0), L(2,120,0), L(2,140,0), L(2,160,0),
    L(2,180,0), L(2,200,0), L(2,220,0), L(2,240,0), L(2,260,0), L(2,280,0), L(2,300,0), L(2,320,0),
    L(2,340,0), L(2,360,0), L(2,380,0), L(2,400,0), L(2,420,0), L(2,440,0), L(2,460,0), L(2,480,0),
    L(2,500,0), L(2,520,0), L(2,540,0), L(2,560,0), L(2,580,0), L(2,600,0), L(2,620,0), L(2,640,0),
    L(2,660,0), L(2,680,0), L(2,700,0), L(2,720,0), L(2,740,0), L(2,760,0), L(2,780,0), L(2,800,0),
    L(2,820,0), L(2,840,0), L(2,860,0), L(2,880,0), L(2,900,0), L(2,920,0), L(2,940,0), L(2,960,0),
    L(2,980,0), L(2,1000,0), L(2,1020,0), L(2,1040,0), L(2,1060,0), L(2,1080,0), L(2,1100,0),
    L(3,25,0), L(3,45,0), L(3,65,0), L(3,85,0), L(3,105,0), L(3,125,0), L(3,145,0), L(3,165,0),
    L(3,185,0), L(3,205,0), L(3,225,0), L(3,245,0), L(3,265,0), L(3,285,0), L(3,305,0), L(3,325,0),
    L(3,345,0), L(3,365,0), L(3,385,0), L(3,405,0), L(3,425,0), L(3,445,0), L(3,465,0), L(3,485,0),
    L(3,505,0), L(3,525,0), L(3,545,0), L(3,565,0), L(3,585,0), L(3,605,0), L(3,625,0), L(3,645,0),
    L(3,665,0), L(3,685,0), L(3,705,0), L(3,725,0), L(3,745,0), L(3,765,0), L(3,785,0), L(3,805,0),
    L(3,825,0), L(3,845,0), L(3,865,0), L(3,885,0), L(3,905,0), L(3,925,0), L(3,945,0), L(3,965,0),
    L(3,985,0), L(3,1005,0), L(3,1025,0), L(3,1045,0), L(3,1065,0), L(3,1085,0), L(3,1105,0)
]);

// Level 40: Gravity Maze
LEVELS[40] = createLevel(40, [
    L(16,10,2), L(1,14,0), L(1,18,0), L(1,22,0), L(1,26,0), L(1,30,0), L(1,34,0), L(1,38,0),
    L(16,42,2), L(1,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(1,62,0), L(1,66,0), L(1,70,0),
    L(16,74,2), L(1,78,0), L(1,82,0), L(1,86,0), L(1,90,0), L(1,94,0), L(1,98,0), L(1,102,0),
    L(16,106,2), L(1,110,0), L(1,114,0), L(1,118,0), L(1,122,0), L(1,126,0), L(1,130,0), L(1,134,0),
    L(16,138,2), L(1,142,0), L(1,146,0), L(1,150,0), L(1,154,0), L(1,158,0), L(1,162,0), L(1,166,0),
    L(1,170,0), L(1,174,0), L(1,178,0), L(1,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(1,198,0),
    L(1,202,0), L(1,206,0), L(1,210,0), L(1,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(1,230,0),
    L(1,234,0), L(1,238,0), L(1,242,0), L(1,246,0), L(1,250,0), L(1,254,0), L(1,258,0), L(1,262,0),
    L(1,266,0), L(1,270,0), L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0),
    L(1,298,0), L(1,302,0), L(1,306,0), L(1,310,0), L(1,314,0), L(1,318,0), L(1,322,0), L(1,326,0),
    L(1,330,0), L(1,334,0), L(1,338,0), L(1,342,0), L(1,346,0), L(1,350,0), L(1,354,0), L(1,358,0),
    L(1,362,0), L(1,366,0), L(1,370,0), L(1,374,0), L(1,378,0), L(1,382,0), L(1,386,0), L(1,390,0),
    L(1,394,0), L(1,398,0), L(1,402,0), L(1,406,0), L(1,410,0), L(1,414,0), L(1,418,0), L(1,422,0),
    L(1,426,0), L(1,430,0), L(1,434,0), L(1,438,0), L(1,442,0), L(1,446,0), L(1,450,0), L(1,454,0),
    L(1,458,0), L(1,462,0), L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0),
    L(1,490,0), L(1,494,0), L(1,498,0), L(1,502,0), L(1,506,0), L(1,510,0), L(1,514,0), L(1,518,0),
    L(1,522,0), L(1,526,0), L(1,530,0), L(1,534,0), L(1,538,0), L(1,542,0), L(1,546,0), L(1,550,0),
    L(1,554,0), L(1,558,0), L(1,562,0), L(1,566,0), L(1,570,0), L(1,574,0), L(1,578,0), L(1,582,0),
    L(1,586,0), L(1,590,0), L(1,594,0), L(1,598,0), L(1,602,0), L(1,606,0), L(1,610,0), L(1,614,0),
    L(1,618,0), L(1,622,0), L(1,626,0), L(1,630,0), L(1,634,0), L(1,638,0), L(1,642,0), L(1,646,0),
    L(1,650,0), L(1,654,0), L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0),
    L(1,682,0), L(1,686,0), L(1,690,0), L(1,694,0), L(1,698,0), L(1,702,0), L(1,706,0), L(1,710,0),
    L(1,714,0), L(1,718,0), L(1,722,0), L(1,726,0), L(1,730,0), L(1,734,0), L(1,738,0), L(1,742,0),
    L(1,746,0), L(1,750,0), L(1,754,0), L(1,758,0), L(1,762,0), L(1,766,0), L(1,770,0), L(1,774,0),
    L(1,778,0), L(1,782,0), L(1,786,0), L(1,790,0), L(1,794,0), L(1,798,0), L(1,802,0), L(1,806,0),
    L(1,810,0), L(1,814,0), L(1,818,0), L(1,822,0), L(1,826,0), L(1,830,0), L(1,834,0), L(1,838,0),
    L(1,842,0), L(1,846,0), L(1,850,0), L(1,854,0), L(1,858,0), L(1,862,0), L(1,866,0), L(1,870,0),
    L(1,874,0), L(1,878,0), L(1,882,0), L(1,886,0), L(1,890,0), L(1,894,0), L(1,898,0), L(1,902,0),
    L(1,906,0), L(1,910,0), L(1,914,0), L(1,918,0), L(1,922,0), L(1,926,0), L(1,930,0), L(1,934,0),
    L(1,938,0), L(1,942,0), L(1,946,0), L(1,950,0), L(1,954,0), L(1,958,0), L(1,962,0), L(1,966,0),
    L(1,970,0), L(1,974,0), L(1,978,0), L(1,982,0), L(1,986,0), L(1,990,0), L(1,994,0), L(1,998,0),
    L(1,1002,0), L(1,1006,0), L(1,1010,0), L(1,1014,0), L(1,1018,0), L(1,1022,0), L(1,1026,0),
    L(1,1030,0), L(1,1034,0), L(1,1038,0), L(1,1042,0), L(1,1046,0), L(1,1050,0), L(1,1054,0),
    L(1,1058,0), L(1,1062,0), L(1,1066,0), L(1,1070,0), L(1,1074,0), L(1,1078,0), L(1,1082,0),
    L(2,16,0), L(2,36,0), L(2,56,0), L(2,76,0), L(2,96,0), L(2,116,0), L(2,136,0), L(2,156,0),
    L(2,176,0), L(2,196,0), L(2,216,0), L(2,236,0), L(2,256,0), L(2,276,0), L(2,296,0), L(2,316,0),
    L(2,336,0), L(2,356,0), L(2,376,0), L(2,396,0), L(2,416,0), L(2,436,0), L(2,456,0), L(2,476,0),
    L(2,496,0), L(2,516,0), L(2,536,0), L(2,556,0), L(2,576,0), L(2,596,0), L(2,616,0), L(2,636,0),
    L(2,656,0), L(2,676,0), L(2,696,0), L(2,716,0), L(2,736,0), L(2,756,0), L(2,776,0), L(2,796,0),
    L(2,816,0), L(2,836,0), L(2,856,0), L(2,876,0), L(2,896,0), L(2,916,0), L(2,936,0), L(2,956,0),
    L(2,976,0), L(2,996,0), L(2,1016,0), L(2,1036,0), L(2,1056,0), L(2,1076,0),
    L(3,20,0), L(3,40,0), L(3,60,0), L(3,80,0), L(3,100,0), L(3,120,0), L(3,140,0), L(3,160,0),
    L(3,180,0), L(3,200,0), L(3,220,0), L(3,240,0), L(3,260,0), L(3,280,0), L(3,300,0), L(3,320,0),
    L(3,340,0), L(3,360,0), L(3,380,0), L(3,400,0), L(3,420,0), L(3,440,0), L(3,460,0), L(3,480,0),
    L(3,500,0), L(3,520,0), L(3,540,0), L(3,560,0), L(3,580,0), L(3,600,0), L(3,620,0), L(3,640,0),
    L(3,660,0), L(3,680,0), L(3,700,0), L(3,720,0), L(3,740,0), L(3,760,0), L(3,780,0), L(3,800,0),
    L(3,820,0), L(3,840,0), L(3,860,0), L(3,880,0), L(3,900,0), L(3,920,0), L(3,940,0), L(3,960,0),
    L(3,980,0), L(3,1000,0), L(3,1020,0), L(3,1040,0), L(3,1060,0), L(3,1080,0)
]);

// Level 41: Wave Dance
LEVELS[41] = createLevel(41, [
    L(11,10,2), L(9,14,2), L(1,18,0), L(1,22,0), L(1,26,0), L(1,30,0), L(1,34,0), L(1,38,0),
    L(2,42,0), L(2,46,0), L(2,50,0), L(2,54,0), L(2,58,0), L(2,62,0), L(2,66,0), L(2,70,0),
    L(11,74,2), L(10,78,2), L(1,82,0), L(1,86,0), L(1,90,0), L(1,94,0), L(1,98,0), L(1,102,0),
    L(2,106,0), L(2,110,0), L(2,114,0), L(2,118,0), L(2,122,0), L(2,126,0), L(2,130,0), L(2,134,0),
    L(11,138,2), L(1,142,0), L(1,146,0), L(1,150,0), L(1,154,0), L(1,158,0), L(1,162,0), L(1,166,0),
    L(2,170,0), L(2,174,0), L(2,178,0), L(2,182,0), L(2,186,0), L(2,190,0), L(2,194,0), L(2,198,0),
    L(11,202,2), L(9,206,2), L(1,210,0), L(1,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(1,230,0),
    L(2,234,0), L(2,238,0), L(2,242,0), L(2,246,0), L(2,250,0), L(2,254,0), L(2,258,0), L(2,262,0),
    L(11,266,2), L(10,270,2), L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0),
    L(2,298,0), L(2,302,0), L(2,306,0), L(2,310,0), L(2,314,0), L(2,318,0), L(2,322,0), L(2,326,0),
    L(11,330,2), L(1,334,0), L(1,338,0), L(1,342,0), L(1,346,0), L(1,350,0), L(1,354,0), L(1,358,0),
    L(2,362,0), L(2,366,0), L(2,370,0), L(2,374,0), L(2,378,0), L(2,382,0), L(2,386,0), L(2,390,0),
    L(11,394,2), L(9,398,2), L(1,402,0), L(1,406,0), L(1,410,0), L(1,414,0), L(1,418,0), L(1,422,0),
    L(2,426,0), L(2,430,0), L(2,434,0), L(2,438,0), L(2,442,0), L(2,446,0), L(2,450,0), L(2,454,0),
    L(11,458,2), L(10,462,2), L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0),
    L(2,490,0), L(2,494,0), L(2,498,0), L(2,502,0), L(2,506,0), L(2,510,0), L(2,514,0), L(2,518,0),
    L(11,522,2), L(1,526,0), L(1,530,0), L(1,534,0), L(1,538,0), L(1,542,0), L(1,546,0), L(1,550,0),
    L(2,554,0), L(2,558,0), L(2,562,0), L(2,566,0), L(2,570,0), L(2,574,0), L(2,578,0), L(2,582,0),
    L(11,586,2), L(9,590,2), L(1,594,0), L(1,598,0), L(1,602,0), L(1,606,0), L(1,610,0), L(1,614,0),
    L(2,618,0), L(2,622,0), L(2,626,0), L(2,630,0), L(2,634,0), L(2,638,0), L(2,642,0), L(2,646,0),
    L(11,650,2), L(10,654,2), L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0),
    L(2,682,0), L(2,686,0), L(2,690,0), L(2,694,0), L(2,698,0), L(2,702,0), L(2,706,0), L(2,710,0),
    L(11,714,2), L(1,718,0), L(1,722,0), L(1,726,0), L(1,730,0), L(1,734,0), L(1,738,0), L(1,742,0),
    L(2,746,0), L(2,750,0), L(2,754,0), L(2,758,0), L(2,762,0), L(2,766,0), L(2,770,0), L(2,774,0),
    L(11,778,2), L(9,782,2), L(1,786,0), L(1,790,0), L(1,794,0), L(1,798,0), L(1,802,0), L(1,806,0),
    L(2,810,0), L(2,814,0), L(2,818,0), L(2,822,0), L(2,826,0), L(2,830,0), L(2,834,0), L(2,838,0),
    L(11,842,2), L(10,846,2), L(1,850,0), L(1,854,0), L(1,858,0), L(1,862,0), L(1,866,0), L(1,870,0),
    L(2,874,0), L(2,878,0), L(2,882,0), L(2,886,0), L(2,890,0), L(2,894,0), L(2,898,0), L(2,902,0),
    L(11,906,2), L(1,910,0), L(1,914,0), L(1,918,0), L(1,922,0), L(1,926,0), L(1,930,0), L(1,934,0),
    L(2,938,0), L(2,942,0), L(2,946,0), L(2,950,0), L(2,954,0), L(2,958,0), L(2,962,0), L(2,966,0),
    L(11,970,2), L(9,974,2), L(1,978,0), L(1,982,0), L(1,986,0), L(1,990,0), L(1,994,0), L(1,998,0),
    L(2,1002,0), L(2,1006,0), L(2,1010,0), L(2,1014,0), L(2,1018,0), L(2,1022,0), L(2,1026,0),
    L(11,1030,2), L(10,1034,2), L(1,1038,0), L(1,1042,0), L(1,1046,0), L(1,1050,0), L(1,1054,0),
    L(2,1058,0), L(2,1062,0), L(2,1066,0), L(2,1070,0), L(2,1074,0), L(2,1078,0), L(2,1082,0),
    L(11,1086,2), L(1,1090,0), L(1,1094,0), L(1,1098,0), L(1,1102,0), L(1,1106,0), L(1,1110,0),
    L(2,1114,0), L(2,1118,0), L(2,1122,0), L(2,1126,0), L(2,1130,0), L(2,1134,0), L(2,1138,0),
    L(3,20,0), L(3,40,0), L(3,60,0), L(3,80,0), L(3,100,0), L(3,120,0), L(3,140,0), L(3,160,0),
    L(3,180,0), L(3,200,0), L(3,220,0), L(3,240,0), L(3,260,0), L(3,280,0), L(3,300,0), L(3,320,0),
    L(3,340,0), L(3,360,0), L(3,380,0), L(3,400,0), L(3,420,0), L(3,440,0), L(3,460,0), L(3,480,0),
    L(3,500,0), L(3,520,0), L(3,540,0), L(3,560,0), L(3,580,0), L(3,600,0), L(3,620,0), L(3,640,0),
    L(3,660,0), L(3,680,0), L(3,700,0), L(3,720,0), L(3,740,0), L(3,760,0), L(3,780,0), L(3,800,0),
    L(3,820,0), L(3,840,0), L(3,860,0), L(3,880,0), L(3,900,0), L(3,920,0), L(3,940,0), L(3,960,0),
    L(3,980,0), L(3,1000,0), L(3,1020,0), L(3,1040,0), L(3,1060,0), L(3,1080,0), L(3,1100,0),
    L(3,1120,0), L(3,1140,0)
]);

// Level 42: Robot Revolution
LEVELS[42] = createLevel(42, [
    L(12,10,0), L(9,14,2), L(1,18,0), L(7,22,0), L(1,26,0), L(7,30,0), L(1,34,0), L(7,38,0),
    L(1,42,0), L(7,46,0), L(1,50,0), L(7,54,0), L(1,58,0), L(7,62,0), L(1,66,0), L(7,70,0),
    L(1,74,0), L(7,78,0), L(1,82,0), L(7,86,0), L(1,90,0), L(7,94,0), L(1,98,0), L(7,102,0),
    L(12,106,0), L(10,110,2), L(1,114,0), L(7,118,0), L(1,122,0), L(7,126,0), L(1,130,0), L(7,134,0),
    L(1,138,0), L(7,142,0), L(1,146,0), L(7,150,0), L(1,154,0), L(7,158,0), L(1,162,0), L(7,166,0),
    L(1,170,0), L(7,174,0), L(1,178,0), L(7,182,0), L(1,186,0), L(7,190,0), L(1,194,0), L(7,198,0),
    L(12,202,0), L(9,206,2), L(1,210,0), L(7,214,0), L(1,218,0), L(7,222,0), L(1,226,0), L(7,230,0),
    L(1,234,0), L(7,238,0), L(1,242,0), L(7,246,0), L(1,250,0), L(7,254,0), L(1,258,0), L(7,262,0),
    L(1,266,0), L(7,270,0), L(1,274,0), L(7,278,0), L(1,282,0), L(7,286,0), L(1,290,0), L(7,294,0),
    L(12,298,0), L(10,302,2), L(1,306,0), L(7,310,0), L(1,314,0), L(7,318,0), L(1,322,0), L(7,326,0),
    L(1,330,0), L(7,334,0), L(1,338,0), L(7,342,0), L(1,346,0), L(7,350,0), L(1,354,0), L(7,358,0),
    L(1,362,0), L(7,366,0), L(1,370,0), L(7,374,0), L(1,378,0), L(7,382,0), L(1,386,0), L(7,390,0),
    L(12,394,0), L(9,398,2), L(1,402,0), L(7,406,0), L(1,410,0), L(7,414,0), L(1,418,0), L(7,422,0),
    L(1,426,0), L(7,430,0), L(1,434,0), L(7,438,0), L(1,442,0), L(7,446,0), L(1,450,0), L(7,454,0),
    L(1,458,0), L(7,462,0), L(1,466,0), L(7,470,0), L(1,474,0), L(7,478,0), L(1,482,0), L(7,486,0),
    L(12,490,0), L(10,494,2), L(1,498,0), L(7,502,0), L(1,506,0), L(7,510,0), L(1,514,0), L(7,518,0),
    L(1,522,0), L(7,526,0), L(1,530,0), L(7,534,0), L(1,538,0), L(7,542,0), L(1,546,0), L(7,550,0),
    L(1,554,0), L(7,558,0), L(1,562,0), L(7,566,0), L(1,570,0), L(7,574,0), L(1,578,0), L(7,582,0),
    L(12,586,0), L(9,590,2), L(1,594,0), L(7,598,0), L(1,602,0), L(7,606,0), L(1,610,0), L(7,614,0),
    L(1,618,0), L(7,622,0), L(1,626,0), L(7,630,0), L(1,634,0), L(7,638,0), L(1,642,0), L(7,646,0),
    L(1,650,0), L(7,654,0), L(1,658,0), L(7,662,0), L(1,666,0), L(7,670,0), L(1,674,0), L(7,678,0),
    L(12,682,0), L(10,686,2), L(1,690,0), L(7,694,0), L(1,698,0), L(7,702,0), L(1,706,0), L(7,710,0),
    L(1,714,0), L(7,718,0), L(1,722,0), L(7,726,0), L(1,730,0), L(7,734,0), L(1,738,0), L(7,742,0),
    L(1,746,0), L(7,750,0), L(1,754,0), L(7,758,0), L(1,762,0), L(7,766,0), L(1,770,0), L(7,774,0),
    L(12,778,0), L(9,782,2), L(1,786,0), L(7,790,0), L(1,794,0), L(7,798,0), L(1,802,0), L(7,806,0),
    L(1,810,0), L(7,814,0), L(1,818,0), L(7,822,0), L(1,826,0), L(7,830,0), L(1,834,0), L(7,838,0),
    L(1,842,0), L(7,846,0), L(1,850,0), L(7,854,0), L(1,858,0), L(7,862,0), L(1,866,0), L(7,870,0),
    L(2,16,0), L(2,36,0), L(2,56,0), L(2,76,0), L(2,96,0), L(2,116,0), L(2,136,0), L(2,156,0),
    L(2,176,0), L(2,196,0), L(2,216,0), L(2,236,0), L(2,256,0), L(2,276,0), L(2,296,0), L(2,316,0),
    L(2,336,0), L(2,356,0), L(2,376,0), L(2,396,0), L(2,416,0), L(2,436,0), L(2,456,0), L(2,476,0),
    L(2,496,0), L(2,516,0), L(2,536,0), L(2,556,0), L(2,576,0), L(2,596,0), L(2,616,0), L(2,636,0),
    L(2,656,0), L(2,676,0), L(2,696,0), L(2,716,0), L(2,736,0), L(2,756,0), L(2,776,0), L(2,796,0),
    L(2,816,0), L(2,836,0), L(2,856,0), L(2,876,0), L(2,896,0), L(2,916,0), L(2,936,0), L(2,956,0),
    L(2,976,0), L(2,996,0), L(2,1016,0), L(2,1036,0), L(2,1056,0), L(2,1076,0), L(2,1096,0),
    L(2,1116,0), L(2,1136,0), L(2,1156,0), L(2,1176,0),
    L(3,25,0), L(3,45,0), L(3,65,0), L(3,85,0), L(3,105,0), L(3,125,0), L(3,145,0), L(3,165,0),
    L(3,185,0), L(3,205,0), L(3,225,0), L(3,245,0), L(3,265,0), L(3,285,0), L(3,305,0), L(3,325,0),
    L(3,345,0), L(3,365,0), L(3,385,0), L(3,405,0), L(3,425,0), L(3,445,0), L(3,465,0), L(3,485,0),
    L(3,505,0), L(3,525,0), L(3,545,0), L(3,565,0), L(3,585,0), L(3,605,0), L(3,625,0), L(3,645,0),
    L(3,665,0), L(3,685,0), L(3,705,0), L(3,725,0), L(3,745,0), L(3,765,0), L(3,785,0), L(3,805,0),
    L(3,825,0), L(3,845,0), L(3,865,0), L(3,885,0), L(3,905,0), L(3,925,0), L(3,945,0), L(3,965,0),
    L(3,985,0), L(3,1005,0), L(3,1025,0), L(3,1045,0), L(3,1065,0), L(3,1085,0), L(3,1105,0),
    L(3,1125,0), L(3,1145,0), L(3,1165,0), L(3,1185,0)
]);

// Level 43: Swing Symphony
LEVELS[43] = createLevel(43, [
    L(14,10,2), L(10,14,2), L(1,18,0), L(1,18,4), L(1,22,2), L(1,26,0), L(1,26,4), L(1,30,2),
    L(1,34,0), L(1,34,4), L(1,38,2), L(1,42,0), L(1,42,4), L(1,46,2), L(1,50,0), L(1,50,4),
    L(1,54,2), L(1,58,0), L(1,58,4), L(1,62,2), L(1,66,0), L(1,66,4), L(1,70,2), L(1,74,0),
    L(1,74,4), L(1,78,2), L(1,82,0), L(1,82,4), L(1,86,2), L(1,90,0), L(1,90,4), L(1,94,2),
    L(1,98,0), L(1,98,4), L(1,102,2), L(1,106,0), L(1,106,4), L(1,110,2), L(1,114,0), L(1,114,4),
    L(1,118,2), L(1,122,0), L(1,122,4), L(1,126,2), L(1,130,0), L(1,130,4), L(1,134,2), L(1,138,0),
    L(1,138,4), L(1,142,2), L(1,146,0), L(1,146,4), L(1,150,2), L(1,154,0), L(1,154,4), L(1,158,2),
    L(1,162,0), L(1,162,4), L(1,166,2), L(1,170,0), L(1,170,4), L(1,174,2), L(1,178,0), L(1,178,4),
    L(1,182,2), L(1,186,0), L(1,186,4), L(1,190,2), L(1,194,0), L(1,194,4), L(1,198,2), L(1,202,0),
    L(1,202,4), L(1,206,2), L(1,210,0), L(1,210,4), L(1,214,2), L(1,218,0), L(1,218,4), L(1,222,2),
    L(1,226,0), L(1,226,4), L(1,230,2), L(1,234,0), L(1,234,4), L(1,238,2), L(1,242,0), L(1,242,4),
    L(1,246,2), L(1,250,0), L(1,250,4), L(1,254,2), L(1,258,0), L(1,258,4), L(1,262,2), L(1,266,0),
    L(1,266,4), L(1,270,2), L(1,274,0), L(1,274,4), L(1,278,2), L(1,282,0), L(1,282,4), L(1,286,2),
    L(1,290,0), L(1,290,4), L(1,294,2), L(1,298,0), L(1,298,4), L(1,302,2), L(1,306,0), L(1,306,4),
    L(1,310,2), L(1,314,0), L(1,314,4), L(1,318,2), L(1,322,0), L(1,322,4), L(1,326,2), L(1,330,0),
    L(1,330,4), L(1,334,2), L(1,338,0), L(1,338,4), L(1,342,2), L(1,346,0), L(1,346,4), L(1,350,2),
    L(1,354,0), L(1,354,4), L(1,358,2), L(1,362,0), L(1,362,4), L(1,366,2), L(1,370,0), L(1,370,4),
    L(1,374,2), L(1,378,0), L(1,378,4), L(1,382,2), L(1,386,0), L(1,386,4), L(1,390,2), L(1,394,0),
    L(1,394,4), L(1,398,2), L(1,402,0), L(1,402,4), L(1,406,2), L(1,410,0), L(1,410,4), L(1,414,2),
    L(1,418,0), L(1,418,4), L(1,422,2), L(1,426,0), L(1,426,4), L(1,430,2), L(1,434,0), L(1,434,4),
    L(1,438,2), L(1,442,0), L(1,442,4), L(1,446,2), L(1,450,0), L(1,450,4), L(1,454,2), L(1,458,0),
    L(1,458,4), L(1,462,2), L(1,466,0), L(1,466,4), L(1,470,2), L(1,474,0), L(1,474,4), L(1,478,2),
    L(1,482,0), L(1,482,4), L(1,486,2), L(1,490,0), L(1,490,4), L(1,494,2), L(1,498,0), L(1,498,4),
    L(1,502,2), L(1,506,0), L(1,506,4), L(1,510,2), L(1,514,0), L(1,514,4), L(1,518,2), L(1,522,0),
    L(1,522,4), L(1,526,2), L(1,530,0), L(1,530,4), L(1,534,2), L(1,538,0), L(1,538,4), L(1,542,2),
    L(1,546,0), L(1,546,4), L(1,550,2), L(1,554,0), L(1,554,4), L(1,558,2), L(1,562,0), L(1,562,4),
    L(1,566,2), L(1,570,0), L(1,570,4), L(1,574,2), L(1,578,0), L(1,578,4), L(1,582,2), L(1,586,0),
    L(1,586,4), L(1,590,2), L(1,594,0), L(1,594,4), L(1,598,2), L(1,602,0), L(1,602,4), L(1,606,2),
    L(1,610,0), L(1,610,4), L(1,614,2), L(1,618,0), L(1,618,4), L(1,622,2), L(1,626,0), L(1,626,4),
    L(1,630,2), L(1,634,0), L(1,634,4), L(1,638,2), L(1,642,0), L(1,642,4), L(1,646,2), L(1,650,0),
    L(1,650,4), L(1,654,2), L(1,658,0), L(1,658,4), L(1,662,2), L(1,666,0), L(1,666,4), L(1,670,2),
    L(1,674,0), L(1,674,4), L(1,678,2), L(1,682,0), L(1,682,4), L(1,686,2), L(1,690,0), L(1,690,4),
    L(1,694,2), L(1,698,0), L(1,698,4), L(1,702,2), L(1,706,0), L(1,706,4), L(1,710,2), L(1,714,0),
    L(1,714,4), L(1,718,2), L(1,722,0), L(1,722,4), L(1,726,2), L(1,730,0), L(1,730,4), L(1,734,2),
    L(1,738,0), L(1,738,4), L(1,742,2), L(1,746,0), L(1,746,4), L(1,750,2), L(1,754,0), L(1,754,4),
    L(1,758,2), L(1,762,0), L(1,762,4), L(1,766,2), L(1,770,0), L(1,770,4), L(1,774,2), L(1,778,0),
    L(1,778,4), L(1,782,2), L(1,786,0), L(1,786,4), L(1,790,2), L(1,794,0), L(1,794,4), L(1,798,2),
    L(2,20,2), L(2,40,2), L(2,60,2), L(2,80,2), L(2,100,2), L(2,120,2), L(2,140,2), L(2,160,2),
    L(2,180,2), L(2,200,2), L(2,220,2), L(2,240,2), L(2,260,2), L(2,280,2), L(2,300,2), L(2,320,2),
    L(2,340,2), L(2,360,2), L(2,380,2), L(2,400,2), L(2,420,2), L(2,440,2), L(2,460,2), L(2,480,2),
    L(2,500,2), L(2,520,2), L(2,540,2), L(2,560,2), L(2,580,2), L(2,600,2), L(2,620,2), L(2,640,2),
    L(2,660,2), L(2,680,2), L(2,700,2), L(2,720,2), L(2,740,2), L(2,760,2), L(2,780,2), L(2,800,2),
    L(3,25,2), L(3,45,2), L(3,65,2), L(3,85,2), L(3,105,2), L(3,125,2), L(3,145,2), L(3,165,2),
    L(3,185,2), L(3,205,2), L(3,225,2), L(3,245,2), L(3,265,2), L(3,285,2), L(3,305,2), L(3,325,2),
    L(3,345,2), L(3,365,2), L(3,385,2), L(3,405,2), L(3,425,2), L(3,445,2), L(3,465,2), L(3,485,2),
    L(3,505,2), L(3,525,2), L(3,545,2), L(3,565,2), L(3,585,2), L(3,605,2), L(3,625,2), L(3,645,2),
    L(3,665,2), L(3,685,2), L(3,705,2), L(3,725,2), L(3,745,2), L(3,765,2), L(3,785,2), L(3,805,2)
]);

// Level 44: Checkpoint Marathon
LEVELS[44] = createLevel(44, [
    L(13,10,2), L(1,14,0), L(1,18,0), L(1,22,0), L(1,26,0), L(1,30,0), L(1,34,0), L(1,38,0),
    L(13,42,2), L(1,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(1,62,0), L(1,66,0), L(1,70,0),
    L(13,74,2), L(1,78,0), L(1,82,0), L(1,86,0), L(1,90,0), L(1,94,0), L(1,98,0), L(1,102,0),
    L(13,106,2), L(1,110,0), L(1,114,0), L(1,118,0), L(1,122,0), L(1,126,0), L(1,130,0), L(1,134,0),
    L(13,138,2), L(1,142,0), L(1,146,0), L(1,150,0), L(1,154,0), L(1,158,0), L(1,162,0), L(1,166,0),
    L(13,170,2), L(1,174,0), L(1,178,0), L(1,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(1,198,0),
    L(13,202,2), L(1,206,0), L(1,210,0), L(1,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(1,230,0),
    L(13,234,2), L(1,238,0), L(1,242,0), L(1,246,0), L(1,250,0), L(1,254,0), L(1,258,0), L(1,262,0),
    L(13,266,2), L(1,270,0), L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0),
    L(13,298,2), L(1,302,0), L(1,306,0), L(1,310,0), L(1,314,0), L(1,318,0), L(1,322,0), L(1,326,0),
    L(13,330,2), L(1,334,0), L(1,338,0), L(1,342,0), L(1,346,0), L(1,350,0), L(1,354,0), L(1,358,0),
    L(13,362,2), L(1,366,0), L(1,370,0), L(1,374,0), L(1,378,0), L(1,382,0), L(1,386,0), L(1,390,0),
    L(13,394,2), L(1,398,0), L(1,402,0), L(1,406,0), L(1,410,0), L(1,414,0), L(1,418,0), L(1,422,0),
    L(13,426,2), L(1,430,0), L(1,434,0), L(1,438,0), L(1,442,0), L(1,446,0), L(1,450,0), L(1,454,0),
    L(13,458,2), L(1,462,0), L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0),
    L(13,490,2), L(1,494,0), L(1,498,0), L(1,502,0), L(1,506,0), L(1,510,0), L(1,514,0), L(1,518,0),
    L(13,522,2), L(1,526,0), L(1,530,0), L(1,534,0), L(1,538,0), L(1,542,0), L(1,546,0), L(1,550,0),
    L(13,554,2), L(1,558,0), L(1,562,0), L(1,566,0), L(1,570,0), L(1,574,0), L(1,578,0), L(1,582,0),
    L(13,586,2), L(1,590,0), L(1,594,0), L(1,598,0), L(1,602,0), L(1,606,0), L(1,610,0), L(1,614,0),
    L(13,618,2), L(1,622,0), L(1,626,0), L(1,630,0), L(1,634,0), L(1,638,0), L(1,642,0), L(1,646,0),
    L(13,650,2), L(1,654,0), L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0),
    L(13,682,2), L(1,686,0), L(1,690,0), L(1,694,0), L(1,698,0), L(1,702,0), L(1,706,0), L(1,710,0),
    L(13,714,2), L(1,718,0), L(1,722,0), L(1,726,0), L(1,730,0), L(1,734,0), L(1,738,0), L(1,742,0),
    L(13,746,2), L(1,750,0), L(1,754,0), L(1,758,0), L(1,762,0), L(1,766,0), L(1,770,0), L(1,774,0),
    L(13,778,2), L(1,782,0), L(1,786,0), L(1,790,0), L(1,794,0), L(1,798,0), L(1,802,0), L(1,806,0),
    L(13,810,2), L(1,814,0), L(1,818,0), L(1,822,0), L(1,826,0), L(1,830,0), L(1,834,0), L(1,838,0),
    L(13,842,2), L(1,846,0), L(1,850,0), L(1,854,0), L(1,858,0), L(1,862,0), L(1,866,0), L(1,870,0),
    L(13,874,2), L(1,878,0), L(1,882,0), L(1,886,0), L(1,890,0), L(1,894,0), L(1,898,0), L(1,902,0),
    L(13,906,2), L(1,910,0), L(1,914,0), L(1,918,0), L(1,922,0), L(1,926,0), L(1,930,0), L(1,934,0),
    L(13,938,2), L(1,942,0), L(1,946,0), L(1,950,0), L(1,954,0), L(1,958,0), L(1,962,0), L(1,966,0),
    L(13,970,2), L(1,974,0), L(1,978,0), L(1,982,0), L(1,986,0), L(1,990,0), L(1,994,0), L(1,998,0),
    L(13,1002,2), L(1,1006,0), L(1,1010,0), L(1,1014,0), L(1,1018,0), L(1,1022,0), L(1,1026,0),
    L(2,20,0), L(2,40,0), L(2,60,0), L(2,80,0), L(2,100,0), L(2,120,0), L(2,140,0), L(2,160,0),
    L(2,180,0), L(2,200,0), L(2,220,0), L(2,240,0), L(2,260,0), L(2,280,0), L(2,300,0), L(2,320,0),
    L(2,340,0), L(2,360,0), L(2,380,0), L(2,400,0), L(2,420,0), L(2,440,0), L(2,460,0), L(2,480,0),
    L(2,500,0), L(2,520,0), L(2,540,0), L(2,560,0), L(2,580,0), L(2,600,0), L(2,620,0), L(2,640,0),
    L(2,660,0), L(2,680,0), L(2,700,0), L(2,720,0), L(2,740,0), L(2,760,0), L(2,780,0), L(2,800,0),
    L(2,820,0), L(2,840,0), L(2,860,0), L(2,880,0), L(2,900,0), L(2,920,0), L(2,940,0), L(2,960,0),
    L(2,980,0), L(2,1000,0), L(2,1020,0), L(2,1040,0),
    L(3,30,0), L(3,50,0), L(3,70,0), L(3,90,0), L(3,110,0), L(3,130,0), L(3,150,0), L(3,170,0),
    L(3,190,0), L(3,210,0), L(3,230,0), L(3,250,0), L(3,270,0), L(3,290,0), L(3,310,0), L(3,330,0),
    L(3,350,0), L(3,370,0), L(3,390,0), L(3,410,0), L(3,430,0), L(3,450,0), L(3,470,0), L(3,490,0),
    L(3,510,0), L(3,530,0), L(3,550,0), L(3,570,0), L(3,590,0), L(3,610,0), L(3,630,0), L(3,650,0),
    L(3,670,0), L(3,690,0), L(3,710,0), L(3,730,0), L(3,750,0), L(3,770,0), L(3,790,0), L(3,810,0),
    L(3,830,0), L(3,850,0), L(3,870,0), L(3,890,0), L(3,910,0), L(3,930,0), L(3,950,0), L(3,970,0),
    L(3,990,0), L(3,1010,0), L(3,1030,0)
]);

// Level 45: Mega Dash Challenge
LEVELS[45] = createLevel(45, [
    L(15,10,2), L(1,14,0), L(15,18,2), L(1,22,0), L(15,26,2), L(1,30,0), L(15,34,2), L(1,38,0),
    L(15,42,2), L(1,46,0), L(15,50,2), L(1,54,0), L(15,58,2), L(1,62,0), L(15,66,2), L(1,70,0),
    L(15,74,2), L(1,78,0), L(15,82,2), L(1,86,0), L(15,90,2), L(1,94,0), L(15,98,2), L(1,102,0),
    L(15,106,2), L(1,110,0), L(15,114,2), L(1,118,0), L(15,122,2), L(1,126,0), L(15,130,2), L(1,134,0),
    L(15,138,2), L(1,142,0), L(15,146,2), L(1,150,0), L(15,154,2), L(1,158,0), L(15,162,2), L(1,166,0),
    L(15,170,2), L(1,174,0), L(15,178,2), L(1,182,0), L(15,186,2), L(1,190,0), L(15,194,2), L(1,198,0),
    L(15,202,2), L(1,206,0), L(15,210,2), L(1,214,0), L(15,218,2), L(1,222,0), L(15,226,2), L(1,230,0),
    L(15,234,2), L(1,238,0), L(15,242,2), L(1,246,0), L(15,250,2), L(1,254,0), L(15,258,2), L(1,262,0),
    L(15,266,2), L(1,270,0), L(15,274,2), L(1,278,0), L(15,282,2), L(1,286,0), L(15,290,2), L(1,294,0),
    L(15,298,2), L(1,302,0), L(15,306,2), L(1,310,0), L(15,314,2), L(1,318,0), L(15,322,2), L(1,326,0),
    L(15,330,2), L(1,334,0), L(15,338,2), L(1,342,0), L(15,346,2), L(1,350,0), L(15,354,2), L(1,358,0),
    L(15,362,2), L(1,366,0), L(15,370,2), L(1,374,0), L(15,378,2), L(1,382,0), L(15,386,2), L(1,390,0),
    L(15,394,2), L(1,398,0), L(15,402,2), L(1,406,0), L(15,410,2), L(1,414,0), L(15,418,2), L(1,422,0),
    L(15,426,2), L(1,430,0), L(15,434,2), L(1,438,0), L(15,442,2), L(1,446,0), L(15,450,2), L(1,454,0),
    L(15,458,2), L(1,462,0), L(15,466,2), L(1,470,0), L(15,474,2), L(1,478,0), L(15,482,2), L(1,486,0),
    L(15,490,2), L(1,494,0), L(15,498,2), L(1,502,0), L(15,506,2), L(1,510,0), L(15,514,2), L(1,518,0),
    L(15,522,2), L(1,526,0), L(15,530,2), L(1,534,0), L(15,538,2), L(1,542,0), L(15,546,2), L(1,550,0),
    L(15,554,2), L(1,558,0), L(15,562,2), L(1,566,0), L(15,570,2), L(1,574,0), L(15,578,2), L(1,582,0),
    L(15,586,2), L(1,590,0), L(15,594,2), L(1,598,0), L(15,602,2), L(1,606,0), L(15,610,2), L(1,614,0),
    L(15,618,2), L(1,622,0), L(15,626,2), L(1,630,0), L(15,634,2), L(1,638,0), L(15,642,2), L(1,646,0),
    L(15,650,2), L(1,654,0), L(15,658,2), L(1,662,0), L(15,666,2), L(1,670,0), L(15,674,2), L(1,678,0),
    L(15,682,2), L(1,686,0), L(15,690,2), L(1,694,0), L(15,698,2), L(1,702,0), L(15,706,2), L(1,710,0),
    L(15,714,2), L(1,718,0), L(15,722,2), L(1,726,0), L(15,730,2), L(1,734,0), L(15,738,2), L(1,742,0),
    L(15,746,2), L(1,750,0), L(15,754,2), L(1,758,0), L(15,762,2), L(1,766,0), L(15,770,2), L(1,774,0),
    L(15,778,2), L(1,782,0), L(15,786,2), L(1,790,0), L(15,794,2), L(1,798,0), L(15,802,2), L(1,806,0),
    L(15,810,2), L(1,814,0), L(15,818,2), L(1,822,0), L(15,826,2), L(1,830,0), L(15,834,2), L(1,838,0),
    L(15,842,2), L(1,846,0), L(15,850,2), L(1,854,0), L(15,858,2), L(1,862,0), L(15,866,2), L(1,870,0),
    L(15,874,2), L(1,878,0), L(15,882,2), L(1,886,0), L(15,890,2), L(1,894,0), L(15,898,2), L(1,902,0),
    L(15,906,2), L(1,910,0), L(15,914,2), L(1,918,0), L(15,922,2), L(1,926,0), L(15,930,2), L(1,934,0),
    L(15,938,2), L(1,942,0), L(15,946,2), L(1,950,0), L(15,954,2), L(1,958,0), L(15,962,2), L(1,966,0),
    L(15,970,2), L(1,974,0), L(15,978,2), L(1,982,0), L(15,986,2), L(1,990,0), L(15,994,2), L(1,998,0),
    L(15,1002,2), L(1,1006,0), L(15,1010,2), L(1,1014,0), L(15,1018,2), L(1,1022,0), L(15,1026,2),
    L(2,20,0), L(2,40,0), L(2,60,0), L(2,80,0), L(2,100,0), L(2,120,0), L(2,140,0), L(2,160,0),
    L(2,180,0), L(2,200,0), L(2,220,0), L(2,240,0), L(2,260,0), L(2,280,0), L(2,300,0), L(2,320,0),
    L(2,340,0), L(2,360,0), L(2,380,0), L(2,400,0), L(2,420,0), L(2,440,0), L(2,460,0), L(2,480,0),
    L(2,500,0), L(2,520,0), L(2,540,0), L(2,560,0), L(2,580,0), L(2,600,0), L(2,620,0), L(2,640,0),
    L(2,660,0), L(2,680,0), L(2,700,0), L(2,720,0), L(2,740,0), L(2,760,0), L(2,780,0), L(2,800,0),
    L(2,820,0), L(2,840,0), L(2,860,0), L(2,880,0), L(2,900,0), L(2,920,0), L(2,940,0), L(2,960,0),
    L(2,980,0), L(2,1000,0), L(2,1020,0), L(2,1040,0),
    L(3,25,0), L(3,45,0), L(3,65,0), L(3,85,0), L(3,105,0), L(3,125,0), L(3,145,0), L(3,165,0),
    L(3,185,0), L(3,205,0), L(3,225,0), L(3,245,0), L(3,265,0), L(3,285,0), L(3,305,0), L(3,325,0),
    L(3,345,0), L(3,365,0), L(3,385,0), L(3,405,0), L(3,425,0), L(3,445,0), L(3,465,0), L(3,485,0),
    L(3,505,0), L(3,525,0), L(3,545,0), L(3,565,0), L(3,585,0), L(3,605,0), L(3,625,0), L(3,645,0),
    L(3,665,0), L(3,685,0), L(3,705,0), L(3,725,0), L(3,745,0), L(3,765,0), L(3,785,0), L(3,805,0),
    L(3,825,0), L(3,845,0), L(3,865,0), L(3,885,0), L(3,905,0), L(3,925,0), L(3,945,0), L(3,965,0),
    L(3,985,0), L(3,1005,0), L(3,1025,0), L(3,1045,0)
]);

// Level 46: Moving Platform Extravaganza
LEVELS[46] = createLevel(46, [
    L(20,10,2), L(20,14,4), L(20,18,2), L(20,22,4), L(20,26,2), L(20,30,4), L(20,34,2), L(20,38,4),
    L(1,42,0), L(1,46,0), L(1,50,0), L(1,54,0), L(1,58,0), L(1,62,0), L(1,66,0), L(1,70,0),
    L(20,74,2), L(20,78,4), L(20,82,2), L(20,86,4), L(20,90,2), L(20,94,4), L(20,98,2), L(20,102,4),
    L(1,106,0), L(1,110,0), L(1,114,0), L(1,118,0), L(1,122,0), L(1,126,0), L(1,130,0), L(1,134,0),
    L(20,138,2), L(20,142,4), L(20,146,2), L(20,150,4), L(20,154,2), L(20,158,4), L(20,162,2), L(20,166,4),
    L(1,170,0), L(1,174,0), L(1,178,0), L(1,182,0), L(1,186,0), L(1,190,0), L(1,194,0), L(1,198,0),
    L(20,202,2), L(20,206,4), L(20,210,2), L(20,214,4), L(20,218,2), L(20,222,4), L(20,226,2), L(20,230,4),
    L(1,234,0), L(1,238,0), L(1,242,0), L(1,246,0), L(1,250,0), L(1,254,0), L(1,258,0), L(1,262,0),
    L(20,266,2), L(20,270,4), L(20,274,2), L(20,278,4), L(20,282,2), L(20,286,4), L(20,290,2), L(20,294,4),
    L(1,298,0), L(1,302,0), L(1,306,0), L(1,310,0), L(1,314,0), L(1,318,0), L(1,322,0), L(1,326,0),
    L(20,330,2), L(20,334,4), L(20,338,2), L(20,342,4), L(20,346,2), L(20,350,4), L(20,354,2), L(20,358,4),
    L(1,362,0), L(1,366,0), L(1,370,0), L(1,374,0), L(1,378,0), L(1,382,0), L(1,386,0), L(1,390,0),
    L(20,394,2), L(20,398,4), L(20,402,2), L(20,406,4), L(20,410,2), L(20,414,4), L(20,418,2), L(20,422,4),
    L(1,426,0), L(1,430,0), L(1,434,0), L(1,438,0), L(1,442,0), L(1,446,0), L(1,450,0), L(1,454,0),
    L(20,458,2), L(20,462,4), L(20,466,2), L(20,470,4), L(20,474,2), L(20,478,4), L(20,482,2), L(20,486,4),
    L(1,490,0), L(1,494,0), L(1,498,0), L(1,502,0), L(1,506,0), L(1,510,0), L(1,514,0), L(1,518,0),
    L(20,522,2), L(20,526,4), L(20,530,2), L(20,534,4), L(20,538,2), L(20,542,4), L(20,546,2), L(20,550,4),
    L(1,554,0), L(1,558,0), L(1,562,0), L(1,566,0), L(1,570,0), L(1,574,0), L(1,578,0), L(1,582,0),
    L(20,586,2), L(20,590,4), L(20,594,2), L(20,598,4), L(20,602,2), L(20,606,4), L(20,610,2), L(20,614,4),
    L(1,618,0), L(1,622,0), L(1,626,0), L(1,630,0), L(1,634,0), L(1,638,0), L(1,642,0), L(1,646,0),
    L(20,650,2), L(20,654,4), L(20,658,2), L(20,662,4), L(20,666,2), L(20,670,4), L(20,674,2), L(20,678,4),
    L(1,682,0), L(1,686,0), L(1,690,0), L(1,694,0), L(1,698,0), L(1,702,0), L(1,706,0), L(1,710,0),
    L(20,714,2), L(20,718,4), L(20,722,2), L(20,726,4), L(20,730,2), L(20,734,4), L(20,738,2), L(20,742,4),
    L(1,746,0), L(1,750,0), L(1,754,0), L(1,758,0), L(1,762,0), L(1,766,0), L(1,770,0), L(1,774,0),
    L(20,778,2), L(20,782,4), L(20,786,2), L(20,790,4), L(20,794,2), L(20,798,4), L(20,802,2), L(20,806,4),
    L(1,810,0), L(1,814,0), L(1,818,0), L(1,822,0), L(1,826,0), L(1,830,0), L(1,834,0), L(1,838,0),
    L(20,842,2), L(20,846,4), L(20,850,2), L(20,854,4), L(20,858,2), L(20,862,4), L(20,866,2), L(20,870,4),
    L(1,874,0), L(1,878,0), L(1,882,0), L(1,886,0), L(1,890,0), L(1,894,0), L(1,898,0), L(1,902,0),
    L(20,906,2), L(20,910,4), L(20,914,2), L(20,918,4), L(20,922,2), L(20,926,4), L(20,930,2), L(20,934,4),
    L(1,938,0), L(1,942,0), L(1,946,0), L(1,950,0), L(1,954,0), L(1,958,0), L(1,962,0), L(1,966,0),
    L(20,970,2), L(20,974,4), L(20,978,2), L(20,982,4), L(20,986,2), L(20,990,4), L(20,994,2), L(20,998,4),
    L(1,1002,0), L(1,1006,0), L(1,1010,0), L(1,1014,0), L(1,1018,0), L(1,1022,0), L(1,1026,0),
    L(2,44,0), L(2,84,0), L(2,124,0), L(2,164,0), L(2,204,0), L(2,244,0), L(2,284,0), L(2,324,0),
    L(2,364,0), L(2,404,0), L(2,444,0), L(2,484,0), L(2,524,0), L(2,564,0), L(2,604,0), L(2,644,0),
    L(2,684,0), L(2,724,0), L(2,764,0), L(2,804,0), L(2,844,0), L(2,884,0), L(2,924,0), L(2,964,0),
    L(2,1004,0), L(2,1044,0),
    L(3,50,0), L(3,90,0), L(3,130,0), L(3,170,0), L(3,210,0), L(3,250,0), L(3,290,0), L(3,330,0),
    L(3,370,0), L(3,410,0), L(3,450,0), L(3,490,0), L(3,530,0), L(3,570,0), L(3,610,0), L(3,650,0),
    L(3,690,0), L(3,730,0), L(3,770,0), L(3,810,0), L(3,850,0), L(3,890,0), L(3,930,0), L(3,970,0),
    L(3,1010,0), L(3,1050,0)
]);

// Level 47: Spike Hell
LEVELS[47] = createLevel(47, [
    L(1,10,0), L(1,14,0), L(1,18,0), L(1,22,0), L(1,26,0), L(1,30,0), L(1,34,0), L(1,38,0),
    L(2,42,0), L(2,46,0), L(2,50,0), L(2,54,0), L(2,58,0), L(2,62,0), L(2,66,0), L(2,70,0),
    L(1,74,0), L(1,78,0), L(1,82,0), L(1,86,0), L(1,90,0), L(1,94,0), L(1,98,0), L(1,102,0),
    L(2,106,0), L(2,110,0), L(2,114,0), L(2,118,0), L(2,122,0), L(2,126,0), L(2,130,0), L(2,134,0),
    L(1,138,0), L(1,142,0), L(1,146,0), L(1,150,0), L(1,154,0), L(1,158,0), L(1,162,0), L(1,166,0),
    L(2,170,0), L(2,174,0), L(2,178,0), L(2,182,0), L(2,186,0), L(2,190,0), L(2,194,0), L(2,198,0),
    L(1,202,0), L(1,206,0), L(1,210,0), L(1,214,0), L(1,218,0), L(1,222,0), L(1,226,0), L(1,230,0),
    L(2,234,0), L(2,238,0), L(2,242,0), L(2,246,0), L(2,250,0), L(2,254,0), L(2,258,0), L(2,262,0),
    L(1,266,0), L(1,270,0), L(1,274,0), L(1,278,0), L(1,282,0), L(1,286,0), L(1,290,0), L(1,294,0),
    L(2,298,0), L(2,302,0), L(2,306,0), L(2,310,0), L(2,314,0), L(2,318,0), L(2,322,0), L(2,326,0),
    L(1,330,0), L(1,334,0), L(1,338,0), L(1,342,0), L(1,346,0), L(1,350,0), L(1,354,0), L(1,358,0),
    L(2,362,0), L(2,366,0), L(2,370,0), L(2,374,0), L(2,378,0), L(2,382,0), L(2,386,0), L(2,390,0),
    L(1,394,0), L(1,398,0), L(1,402,0), L(1,406,0), L(1,410,0), L(1,414,0), L(1,418,0), L(1,422,0),
    L(2,426,0), L(2,430,0), L(2,434,0), L(2,438,0), L(2,442,0), L(2,446,0), L(2,450,0), L(2,454,0),
    L(1,458,0), L(1,462,0), L(1,466,0), L(1,470,0), L(1,474,0), L(1,478,0), L(1,482,0), L(1,486,0),
    L(2,490,0), L(2,494,0), L(2,498,0), L(2,502,0), L(2,506,0), L(2,510,0), L(2,514,0), L(2,518,0),
    L(1,522,0), L(1,526,0), L(1,530,0), L(1,534,0), L(1,538,0), L(1,542,0), L(1,546,0), L(1,550,0),
    L(2,554,0), L(2,558,0), L(2,562,0), L(2,566,0), L(2,570,0), L(2,574,0), L(2,578,0), L(2,582,0),
    L(1,586,0), L(1,590,0), L(1,594,0), L(1,598,0), L(1,602,0), L(1,606,0), L(1,610,0), L(1,614,0),
    L(2,618,0), L(2,622,0), L(2,626,0), L(2,630,0), L(2,634,0), L(2,638,0), L(2,642,0), L(2,646,0),
    L(1,650,0), L(1,654,0), L(1,658,0), L(1,662,0), L(1,666,0), L(1,670,0), L(1,674,0), L(1,678,0),
    L(2,682,0), L(2,686,0), L(2,690,0), L(2,694,0), L(2,698,0), L(2,702,0), L(2,706,0), L(2,710,0),
    L(1,714,0), L(1,718,0), L(1,722,0), L(1,726,0), L(1,730,0), L(1,734,0), L(1,738,0), L(1,742,0),
    L(2,746,0), L(2,750,0), L(2,754,0), L(2,758,0), L(2,762,0), L(2,766,0), L(2,770,0), L(2,774,0),
    L(1,778,0), L(1,782,0), L(1,786,0), L(1,790,0), L(1,794,0), L(1,798,0), L(1,802,0), L(1,806,0),
    L(2,810,0), L(2,814,0), L(2,818,0), L(2,822,0), L(2,826,0), L(2,830,0), L(2,834,0), L(2,838,0),
    L(1,842,0), L(1,846,0), L(1,850,0), L(1,854,0), L(1,858,0), L(1,862,0), L(1,866,0), L(1,870,0),
    L(2,874,0), L(2,878,0), L(2,882,0), L(2,886,0), L(2,890,0), L(2,894,0), L(2,898,0), L(2,902,0),
    L(1,906,0), L(1,910,0), L(1,914,0), L(1,918,0), L(1,922,0), L(1,926,0), L(1,930,0), L(1,934,0),
    L(2,938,0), L(2,942,0), L(2,946,0), L(2,950,0), L(2,954,0), L(2,958,0), L(2,962,0), L(2,966,0),
    L(1,970,0), L(1,974,0), L(1,978,0), L(1,982,0), L(1,986,0), L(1,990,0), L(1,994,0), L(1,998,0),
    L(2,1002,0), L(2,1006,0), L(2,1010,0), L(2,1014,0), L(2,1018,0), L(2,1022,0), L(2,1026,0),
    L(7,20,0), L(7,60,0), L(7,100,0), L(7,140,0), L(7,180,0), L(7,220,0), L(7,260,0), L(7,300,0),
    L(7,340,0), L(7,380,0), L(7,420,0), L(7,460,0), L(7,500,0), L(7,540,0), L(7,580,0), L(7,620,0),
    L(7,660,0), L(7,700,0), L(7,740,0), L(7,780,0), L(7,820,0), L(7,860,0), L(7,900,0), L(7,940,0),
    L(7,980,0), L(7,1020,0),
    L(3,30,0), L(3,70,0), L(3,110,0), L(3,150,0), L(3,190,0), L(3,230,0), L(3,270,0), L(3,310,0),
    L(3,350,0), L(3,390,0), L(3,430,0), L(3,470,0), L(3,510,0), L(3,550,0), L(3,590,0), L(3,630,0),
    L(3,670,0), L(3,710,0), L(3,750,0), L(3,790,0), L(3,830,0), L(3,870,0), L(3,910,0), L(3,950,0),
    L(3,990,0), L(3,1030,0)
]);

// Level 48: Ultimate Finale
LEVELS[48] = createLevel(48, [
    L(4,10,2), L(15,20,2), L(11,30,2), L(5,40,2), L(12,50,0), L(14,60,2), L(16,70,2), L(9,80,2),
    L(10,90,2), L(20,100,2), L(13,110,2), L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0), L(1,55,0),
    L(1,65,0), L(1,75,0), L(1,85,0), L(1,95,0), L(1,105,0), L(1,115,0), L(1,125,0), L(1,135,0),
    L(1,145,0), L(1,155,0), L(1,165,0), L(1,175,0), L(1,185,0), L(1,195,0), L(1,205,0), L(1,215,0),
    L(1,225,0), L(1,235,0), L(1,245,0), L(1,255,0), L(1,265,0), L(1,275,0), L(1,285,0), L(1,295,0),
    L(1,305,0), L(1,315,0), L(1,325,0), L(1,335,0), L(1,345,0), L(1,355,0), L(1,365,0), L(1,375,0),
    L(1,385,0), L(1,395,0), L(1,405,0), L(1,415,0), L(1,425,0), L(1,435,0), L(1,445,0), L(1,455,0),
    L(1,465,0), L(1,475,0), L(1,485,0), L(1,495,0), L(1,505,0), L(1,515,0), L(1,525,0), L(1,535,0),
    L(1,545,0), L(1,555,0), L(1,565,0), L(1,575,0), L(1,585,0), L(1,595,0), L(1,605,0), L(1,615,0),
    L(1,625,0), L(1,635,0), L(1,645,0), L(1,655,0), L(1,665,0), L(1,675,0), L(1,685,0), L(1,695,0),
    L(1,705,0), L(1,715,0), L(1,725,0), L(1,735,0), L(1,745,0), L(1,755,0), L(1,765,0), L(1,775,0),
    L(1,785,0), L(1,795,0), L(1,805,0), L(1,815,0), L(1,825,0), L(1,835,0), L(1,845,0), L(1,855,0),
    L(1,865,0), L(1,875,0), L(1,885,0), L(1,895,0), L(1,905,0), L(1,915,0), L(1,925,0), L(1,935,0),
    L(1,945,0), L(1,955,0), L(1,965,0), L(1,975,0), L(1,985,0), L(1,995,0), L(1,1005,0), L(1,1015,0),
    L(1,1025,0), L(1,1035,0), L(1,1045,0), L(1,1055,0), L(1,1065,0), L(1,1075,0), L(1,1085,0),
    L(1,1095,0), L(1,1105,0), L(1,1115,0), L(1,1125,0), L(1,1135,0), L(1,1145,0), L(1,1155,0),
    L(1,1165,0), L(1,1175,0), L(1,1185,0), L(1,1195,0), L(1,1205,0), L(1,1215,0), L(1,1225,0),
    L(1,1235,0), L(1,1245,0), L(1,1255,0), L(1,1265,0), L(1,1275,0), L(1,1285,0), L(1,1295,0),
    L(1,1305,0), L(1,1315,0), L(1,1325,0), L(1,1335,0), L(1,1345,0), L(1,1355,0), L(1,1365,0),
    L(1,1375,0), L(1,1385,0), L(1,1395,0), L(1,1405,0), L(1,1415,0), L(1,1425,0), L(1,1435,0),
    L(1,1445,0), L(1,1455,0), L(1,1465,0), L(1,1475,0), L(1,1485,0), L(1,1495,0), L(1,1505,0),
    L(2,20,0), L(2,40,0), L(2,60,0), L(2,80,0), L(2,100,0), L(2,120,0), L(2,140,0), L(2,160,0),
    L(2,180,0), L(2,200,0), L(2,220,0), L(2,240,0), L(2,260,0), L(2,280,0), L(2,300,0), L(2,320,0),
    L(2,340,0), L(2,360,0), L(2,380,0), L(2,400,0), L(2,420,0), L(2,440,0), L(2,460,0), L(2,480,0),
    L(2,500,0), L(2,520,0), L(2,540,0), L(2,560,0), L(2,580,0), L(2,600,0), L(2,620,0), L(2,640,0),
    L(2,660,0), L(2,680,0), L(2,700,0), L(2,720,0), L(2,740,0), L(2,760,0), L(2,780,0), L(2,800,0),
    L(2,820,0), L(2,840,0), L(2,860,0), L(2,880,0), L(2,900,0), L(2,920,0), L(2,940,0), L(2,960,0),
    L(2,980,0), L(2,1000,0), L(2,1020,0), L(2,1040,0), L(2,1060,0), L(2,1080,0), L(2,1100,0),
    L(2,1120,0), L(2,1140,0), L(2,1160,0), L(2,1180,0), L(2,1200,0), L(2,1220,0), L(2,1240,0),
    L(2,1260,0), L(2,1280,0), L(2,1300,0), L(2,1320,0), L(2,1340,0), L(2,1360,0), L(2,1380,0),
    L(2,1400,0), L(2,1420,0), L(2,1440,0), L(2,1460,0), L(2,1480,0), L(2,1500,0),
    L(7,30,0), L(7,70,0), L(7,110,0), L(7,150,0), L(7,190,0), L(7,230,0), L(7,270,0), L(7,310,0),
    L(7,350,0), L(7,390,0), L(7,430,0), L(7,470,0), L(7,510,0), L(7,550,0), L(7,590,0), L(7,630,0),
    L(7,670,0), L(7,710,0), L(7,750,0), L(7,790,0), L(7,830,0), L(7,870,0), L(7,910,0), L(7,950,0),
    L(7,990,0), L(7,1030,0), L(7,1070,0), L(7,1110,0), L(7,1150,0), L(7,1190,0), L(7,1230,0),
    L(7,1270,0), L(7,1310,0), L(7,1350,0), L(7,1390,0), L(7,1430,0), L(7,1470,0),
    L(3,50,0), L(3,90,0), L(3,130,0), L(3,170,0), L(3,210,0), L(3,250,0), L(3,290,0), L(3,330,0),
    L(3,370,0), L(3,410,0), L(3,450,0), L(3,490,0), L(3,530,0), L(3,570,0), L(3,610,0), L(3,650,0),
    L(3,690,0), L(3,730,0), L(3,770,0), L(3,810,0), L(3,850,0), L(3,890,0), L(3,930,0), L(3,970,0),
    L(3,1010,0), L(3,1050,0), L(3,1090,0), L(3,1130,0), L(3,1170,0), L(3,1210,0), L(3,1250,0),
    L(3,1290,0), L(3,1330,0), L(3,1370,0), L(3,1410,0), L(3,1450,0), L(3,1490,0)
]);

// Level 50: Ultimate Final Challenge
LEVELS[49] = createLevel(49, [
    L(4,10,2), L(15,20,2), L(11,30,2), L(5,40,2), L(12,50,0), L(14,60,2), L(16,70,2), L(9,80,2),
    L(10,90,2), L(20,100,2), L(7,110,0), L(13,120,2), L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0),
    L(1,55,0), L(1,65,0), L(1,75,0), L(1,85,0), L(1,95,0), L(1,105,0), L(1,115,0), L(1,125,0),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0),
    L(3,18,0), L(3,38,0), L(3,58,0), L(3,78,0), L(3,98,0), L(3,118,0), L(3,138,0)
]);

// Level 49: Ultimate Final Challenge
LEVELS[49] = createLevel(49, [
    L(4,10,2), L(15,20,2), L(11,30,2), L(5,40,2), L(12,50,0), L(14,60,2), L(16,70,2), L(9,80,2),
    L(10,90,2), L(20,100,2), L(7,110,0), L(13,120,2), L(1,15,0), L(1,25,0), L(1,35,0), L(1,45,0),
    L(1,55,0), L(1,65,0), L(1,75,0), L(1,85,0), L(1,95,0), L(1,105,0), L(1,115,0), L(1,125,0),
    L(2,12,0), L(2,22,0), L(2,32,0), L(2,42,0), L(2,52,0), L(2,62,0), L(2,72,0), L(2,82,0),
    L(2,92,0), L(2,102,0), L(2,112,0), L(2,122,0),
    L(3,18,0), L(3,38,0), L(3,58,0), L(3,78,0), L(3,98,0), L(3,118,0), L(3,138,0)
]);

// --- ADVANCED CONTROLLER SUPPORT ---
const Controller = {
    connected: false,
    gamepad: null,
    buttons: {},
    axes: {},
    deadzone: 0.08, // Lower default deadzone
    sensitivity: 0.3, // Lower default sensitivity
    buttonStates: {},
    lastButtonStates: {},
    navigationIndex: 0,
    navigationItems: [],
    editorMode: false,
    crosshairX: 0,
    crosshairY: 0,
    crosshairSpeed: 5,
    currentEditorTool: 0,
    
    init: function() {
        if (!settings.controls.controller) return;
        
        window.addEventListener("gamepadconnected", (e) => {
            console.log("üéÆ Gamepad connected:", e.gamepad.id);
            this.connected = true;
            this.gamepad = e.gamepad;
            document.getElementById('controller-status').style.display = 'block';
            
            // Vibrate if supported and enabled
            if (settings.gameplay.vibration && e.gamepad.vibrationActuator) {
                e.gamepad.vibrationActuator.playEffect("dual-rumble", {
                    startDelay: 0,
                    duration: 300,
                    weakMagnitude: 1.0,
                    strongMagnitude: 0.8
                });
            }
            
            this.showConnectedMessage();
        });
        
        window.addEventListener("gamepaddisconnected", (e) => {
            console.log("üéÆ Gamepad disconnected:", e.gamepad.id);
            this.connected = false;
            this.gamepad = null;
            document.getElementById('controller-status').style.display = 'none';
        });
        
        // Check for existing gamepads
        this.scanGamepads();
        
        // Initialize crosshair position
        this.crosshairX = window.innerWidth / 2;
        this.crosshairY = window.innerHeight / 2;
        
        // Update button states
        setInterval(() => this.updateButtonStates(), 16);
    },
    
    showConnectedMessage: function() {
        Game.showTutorialMessage('üéÆ Controller Connected! Use A to jump, Y to retry', 3000);
    },
    
    scanGamepads: function() {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        for (const gamepad of gamepads) {
            if (gamepad) {
                this.connected = true;
                this.gamepad = gamepad;
                document.getElementById('controller-status').style.display = 'block';
                break;
            }
        }
    },
    
    update: function() {
        if (!this.connected || !settings.controls.controller) return;
        
        this.scanGamepads();
        if (!this.gamepad) return;
        
        // Update buttons
        this.gamepad.buttons.forEach((button, index) => {
            this.buttons[index] = button.pressed;
        });
        
        // Update axes with deadzone and sensitivity
        this.gamepad.axes.forEach((axis, index) => {
            const value = axis;
            if (Math.abs(value) > this.deadzone) {
                // Apply sensitivity curve
                const sign = Math.sign(value);
                const absValue = Math.abs(value);
                const curvedValue = Math.pow(absValue, 1.5) * sign; // Exponential curve for finer control
                this.axes[index] = curvedValue * this.sensitivity;
            } else {
                this.axes[index] = 0;
            }
        });
        
        // Handle controller inputs based on game state
        if (this.editorMode && Game.state === 'editor') {
            this.handleEditorInput();
        } else if (Game.state === 'menu') {
            this.handleMenuInput();
        } else if (Game.state === 'game') {
            this.handleGameInput();
        }
        
        // Update crosshair in editor mode
        if (this.editorMode) {
            this.updateCrosshair();
        }
    },
    
    updateButtonStates: function() {
        this.lastButtonStates = { ...this.buttonStates };
        
        // Copy current button states
        for (let i = 0; i < 17; i++) {
            this.buttonStates[i] = this.buttons[i] || false;
        }
    },
    
    isButtonPressed: function(buttonIndex) {
        return this.buttonStates[buttonIndex] && !this.lastButtonStates[buttonIndex];
    },
    
    isButtonHeld: function(buttonIndex) {
        return this.buttonStates[buttonIndex];
    },
    
    isButtonReleased: function(buttonIndex) {
        return !this.buttonStates[buttonIndex] && this.lastButtonStates[buttonIndex];
    },
    
    handleMenuInput: function() {
        // Get all focusable elements
        this.navigationItems = Array.from(document.querySelectorAll('.ui-layer.visible button, .ui-layer.visible .lvl-btn.unlocked, .ui-layer.visible .costume-item, .ui-layer.visible .save-slot, .ui-layer.visible .sound-item, .ui-layer.visible .game-mode-item'));
        
        if (this.navigationItems.length === 0) return;
        
        // Handle D-pad/Stick navigation
        if (this.isButtonPressed(12) || this.axes[1] < -0.5) { // Up
            this.navigate(-1);
        }
        if (this.isButtonPressed(13) || this.axes[1] > 0.5) { // Down
            this.navigate(1);
        }
        if (this.isButtonPressed(14) || this.axes[0] < -0.5) { // Left
            this.navigate(-1, true);
        }
        if (this.isButtonPressed(15) || this.axes[0] > 0.5) { // Right
            this.navigate(1, true);
        }
        
        // Handle button presses
        if (this.isButtonPressed(0)) { // A button - select
            this.selectCurrentItem();
        }
        if (this.isButtonPressed(1)) { // B button - back
            this.goBack();
        }
        if (this.isButtonPressed(8) || this.isButtonPressed(9)) { // Select/Start - menu/home
            UI.home();
        }
    },
    
    handleGameInput: function() {
        // A button for jump (with hold functionality)
        if (this.isButtonPressed(0) || (this.isButtonHeld(0) && Math.random() < 0.1)) {
            // 10% chance per frame to trigger jump while holding
            if (!Input.held) {
                action();
            }
            Input.held = true;
        } else if (this.isButtonReleased(0)) {
            if (Input.held && !Input.mousePressed) {
                release();
            }
        }
        
        // B button for dash/special action
        if (this.isButtonPressed(1)) {
            if (Player.mode === 'cube') {
                Player.dash();
            }
        }
        
        // Y button for retry
        if (this.isButtonPressed(3)) {
            Game.retry();
        }
        
        // Start button for pause menu
        if (this.isButtonPressed(9)) {
            UI.show('menu-pause');
        }
        
        // Home/Back button to return to menu
        if (this.isButtonPressed(8)) {
            UI.home();
        }
    },
    
    handleEditorInput: function() {
        // Move crosshair with left stick or D-pad
        this.crosshairX += this.axes[0] * this.crosshairSpeed * 10;
        this.crosshairY += this.axes[1] * this.crosshairSpeed * 10;
        
        // Clamp crosshair to screen
        this.crosshairX = Math.max(0, Math.min(window.innerWidth, this.crosshairX));
        this.crosshairY = Math.max(0, Math.min(window.innerHeight, this.crosshairY));
        
        // D-pad for tool selection
        if (this.isButtonPressed(12)) { // Up
            this.currentEditorTool = Math.max(0, this.currentEditorTool - 1);
            this.updateEditorToolSelection();
        }
        if (this.isButtonPressed(13)) { // Down
            this.currentEditorTool = Math.min(LevelEditor.tools.length - 1, this.currentEditorTool + 1);
            this.updateEditorToolSelection();
        }
        if (this.isButtonPressed(14)) { // Left
            this.currentEditorTool = Math.max(0, this.currentEditorTool - 5);
            this.updateEditorToolSelection();
        }
        if (this.isButtonPressed(15)) { // Right
            this.currentEditorTool = Math.min(LevelEditor.tools.length - 1, this.currentEditorTool + 5);
            this.updateEditorToolSelection();
        }
        
        // ZR/R2 for place block
        if (this.isButtonHeld(7) || this.axes[2] > 0.5) {
            LevelEditor.placeAtCrosshair(this.crosshairX, this.crosshairY);
        }
        
        // ZL/L2 for delete block
        if (this.isButtonHeld(6) || this.axes[5] > 0.5) {
            LevelEditor.deleteAtCrosshair(this.crosshairX, this.crosshairY);
        }
        
        // X button to test level
        if (this.isButtonPressed(2)) {
            LevelEditor.testLevel();
        }
        
        // Y button to save level
        if (this.isButtonPressed(3)) {
            LevelEditor.save();
        }
        
        // Start button to exit editor
        if (this.isButtonPressed(9)) {
            LevelEditor.exit();
        }
        
        // Update button visual feedback
        this.updateControllerButtonDisplay();
    },
    
    updateEditorToolSelection: function() {
        const toolButtons = document.querySelectorAll('.editor-tool-btn');
        toolButtons.forEach((btn, index) => {
            if (index === this.currentEditorTool) {
                btn.classList.add('active');
                btn.focus();
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Update current tool
        if (LevelEditor.tools[this.currentEditorTool]) {
            LevelEditor.currentTool = LevelEditor.tools[this.currentEditorTool].id;
        }
    },
    
    navigate: function(direction, horizontal = false) {
        if (this.navigationItems.length === 0) return;
        
        // Find current focused element
        let currentIndex = 0;
        const focused = document.activeElement;
        this.navigationItems.forEach((item, index) => {
            if (item === focused) {
                currentIndex = index;
            }
        });
        
        // Calculate new index based on grid (for level grid, shop grid, etc.)
        let newIndex = currentIndex;
        
        if (horizontal) {
            // For grid layouts, calculate based on columns
            const container = this.navigationItems[0].closest('#lvl-grid, #shop-content, #sound-library-content');
            if (container) {
                const itemsPerRow = container.id === 'lvl-grid' ? 5 : 
                                  container.id === 'shop-content' ? 3 : 4;
                newIndex = currentIndex + (direction * 1);
                
                // Handle row wrapping
                const row = Math.floor(currentIndex / itemsPerRow);
                const newRow = Math.floor(newIndex / itemsPerRow);
                if (newRow !== row) {
                    newIndex = currentIndex; // Don't change rows horizontally
                }
            } else {
                newIndex = currentIndex + direction;
            }
        } else {
            newIndex = currentIndex + direction;
        }
        
        // Wrap around
        if (newIndex < 0) newIndex = this.navigationItems.length - 1;
        if (newIndex >= this.navigationItems.length) newIndex = 0;
        
        // Focus the new element
        this.navigationItems[newIndex].focus();
        this.navigationItems[newIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Visual feedback
        this.navigationItems[newIndex].style.transform = 'scale(1.05)';
        setTimeout(() => {
            this.navigationItems[newIndex].style.transform = '';
        }, 200);
    },
    
    selectCurrentItem: function() {
        const focused = document.activeElement;
        if (focused) {
            focused.click();
            
            // Visual feedback
            focused.style.transform = 'scale(0.95)';
            setTimeout(() => {
                focused.style.transform = '';
            }, 100);
        }
    },
    
    goBack: function() {
        const currentMenu = document.querySelector('.ui-layer.visible');
        if (currentMenu && currentMenu.id !== 'menu-main') {
            if (currentMenu.id === 'menu-levels' || 
                currentMenu.id === 'menu-shop' || 
                currentMenu.id === 'menu-settings' ||
                currentMenu.id === 'menu-whatsnew' ||
                currentMenu.id === 'menu-achievements' ||
                currentMenu.id === 'menu-savesystem' ||
                currentMenu.id === 'menu-leaderboard' ||
                currentMenu.id === 'menu-soundlibrary' ||
                currentMenu.id === 'menu-gamemodes' ||
                currentMenu.id === 'menu-controllerlayout') {
                UI.home();
            }
        }
    },
    
    updateCrosshair: function() {
        const crosshair = document.getElementById('editor-crosshair');
        if (crosshair) {
            crosshair.style.left = this.crosshairX + 'px';
            crosshair.style.top = this.crosshairY + 'px';
        }
    },
    
    updateControllerButtonDisplay: function() {
        // Update visual feedback for controller buttons
        const buttons = ['a', 'b', 'x', 'y', 'lb', 'rb', 'lt', 'rt'];
        
        buttons.forEach(button => {
            const el = document.getElementById(`controller-button-${button}`);
            if (el) {
                const buttonIndex = {
                    'a': 0, 'b': 1, 'x': 2, 'y': 3,
                    'lb': 4, 'rb': 5, 'lt': 6, 'rt': 7
                }[button];
                
                if (this.isButtonHeld(buttonIndex)) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            }
        });
    },
    
    setDeadzone: function(value) {
        this.deadzone = value / 100;
    },
    
    setSensitivity: function(value) {
        this.sensitivity = value / 100;
    },
    
    enableEditorMode: function() {
        this.editorMode = true;
        const crosshair = document.getElementById('editor-crosshair');
        if (crosshair) {
            crosshair.style.display = 'block';
        }
        
        // Set initial crosshair position to center
        this.crosshairX = window.innerWidth / 2;
        this.crosshairY = window.innerHeight / 2;
        this.updateCrosshair();
        
        Game.showTutorialMessage('Editor Mode: Use controller to edit!', 3000);
    },
    
    disableEditorMode: function() {
        this.editorMode = false;
        const crosshair = document.getElementById('editor-crosshair');
        if (crosshair) {
            crosshair.style.display = 'none';
        }
    }
};

// --- IMPROVED GAME ENGINE ---
const Game = {
    canvas: document.getElementById('gameCanvas'),
    ctx: document.getElementById('gameCanvas').getContext('2d'),
    state: 'menu', 
    level: [], 
    att: 1, 
    camX: 0, 
    floorY: 0,
    shake: 0,
    currLvlIdx: 0,
    pauseBtn: document.getElementById('pause-main-btn'),
    bgHue: 200, 
    bgSat: 100,  
    isMobile: window.innerWidth <= 768, 
    goalX: 100000, 
    startPos: { x: CFG.START_X * CFG.tile, y: 0, g: CFG.g, mode: 'cube', scale: CFG.MACRO_SCALE },
    currentCheckpoint: null,
    timeScale: 1.0, 
    dashActive: false,
    slowTimer: null,
    lastFrameTime: 0,
    deltaTime: 0,
    fps: 0,
    frameCount: 0,
    lastFpsUpdate: 0,
    performanceMode: 'high',
    currentQuality: 'high',
    ipadMode: false,
    levelRatings: JSON.parse(localStorage.getItem('nd_level_ratings') || '{}'),

    init: function() {
        this.setupLoading();
        this.loadSettings();
        this.applyGraphicsSettings();
        this.applyiPadMode();
        
        this.resize();
        window.onresize = ()=>this.resize();
        document.getElementById('unlock-count').innerText = unlocked;
        document.getElementById('unlock-count').parentElement.innerHTML = `Levels unlocked: <span id="unlock-count">${unlocked}</span>/${CFG.TOTAL_LEVELS}`;
        Player.loadColors();
        this.updateCoinDisplay();
        
        // Initialize all systems
        setTimeout(() => AUDIO.init(), 500);
        Controller.init();
        Achievements.init();
        SaveSystem.init();
        Leaderboard.init();
        TimeTrial.init();
        SoundLibrary.init();
        GameModes.init();
        
        this.checkMobileControls();
        this.loop(0);
        
        // Setup event listeners
        document.getElementById('shop-back-btn').onclick = UI.home;
        document.querySelector('#menu-pause button.pink').onclick = UI.home;
        
        // Initialize level editor
        LevelEditor.init();
        
        // Setup slider event listeners
        this.setupSliderEvents();
        
        // Setup rating system
        this.setupRatingSystem();
        
        // Hide loading screen
        setTimeout(() => {
            document.getElementById('loading-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading-screen').style.display = 'none';
            }, 500);
        }, 1000);
    },

    setupSliderEvents: function() {
        // Volume slider
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValue = document.getElementById('volume-value');
        volumeSlider.addEventListener('input', (e) => {
            volumeValue.textContent = e.target.value + '%';
        });
        
        // Music volume slider
        const musicSlider = document.getElementById('music-volume-slider');
        const musicValue = document.getElementById('music-volume-value');
        musicSlider.addEventListener('input', (e) => {
            musicValue.textContent = e.target.value + '%';
        });
        
        // Sensitivity slider
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        const sensitivityValue = document.getElementById('sensitivity-value');
        sensitivitySlider.addEventListener('input', (e) => {
            const sensitivityText = ['Low', 'Medium', 'High'];
            sensitivityValue.textContent = sensitivityText[e.target.value - 1];
        });
        
        // Deadzone slider
        const deadzoneSlider = document.getElementById('deadzone-slider');
        const deadzoneValue = document.getElementById('deadzone-value');
        deadzoneSlider.addEventListener('input', (e) => {
            deadzoneValue.textContent = e.target.value + '%';
            Controller.setDeadzone(e.target.value);
        });
        
        // Controller sensitivity slider
        const controllerSensitivitySlider = document.getElementById('controller-sensitivity-slider');
        const controllerSensitivityValue = document.getElementById('controller-sensitivity-value');
        controllerSensitivitySlider.addEventListener('input', (e) => {
            const value = e.target.value / 100;
            controllerSensitivityValue.textContent = value.toFixed(2);
            Controller.setSensitivity(e.target.value);
        });
        
        // UI Scale slider
        const uiScaleSlider = document.getElementById('ui-scale-slider');
        const uiScaleValue = document.getElementById('ui-scale-value');
        uiScaleSlider.addEventListener('input', (e) => {
            uiScaleValue.textContent = e.target.value + '%';
            this.applyUIScale(e.target.value);
        });
    },

    setupRatingSystem: function() {
        const stars = document.querySelectorAll('.rating-star');
        stars.forEach(star => {
            star.addEventListener('click', (e) => {
                const value = parseInt(e.target.dataset.value);
                this.rateCurrentLevel(value);
            });
        });
    },

    rateCurrentLevel: function(rating) {
        if (this.currLvlIdx >= 0) {
            this.levelRatings[this.currLvlIdx] = {
                rating: rating,
                timestamp: Date.now()
            };
            localStorage.setItem('nd_level_ratings', JSON.stringify(this.levelRatings));
            
            // Update display
            this.updateLevelRatingDisplay();
            
            // Show confirmation
            Game.showTutorialMessage(`Rated Level ${this.currLvlIdx + 1}: ${rating}‚òÖ`, 2000);
            
            // Achievement check
            const ratedLevels = Object.keys(this.levelRatings).length;
            if (ratedLevels >= 5) {
                Achievements.unlock('rating_giver');
            }
        }
    },

    updateLevelRatingDisplay: function() {
        const ratingContainer = document.getElementById('level-rating');
        const averageEl = document.getElementById('level-rating-average');
        
        if (this.currLvlIdx >= 0) {
            ratingContainer.style.display = 'block';
            
            const rating = this.levelRatings[this.currLvlIdx];
            if (rating) {
                // Highlight stars
                const stars = document.querySelectorAll('.rating-star');
                stars.forEach(star => {
                    const value = parseInt(star.dataset.value);
                    if (value <= rating.rating) {
                        star.classList.add('active');
                    } else {
                        star.classList.remove('active');
                    }
                });
                
                averageEl.textContent = `Your rating: ${rating.rating}‚òÖ`;
            } else {
                // Reset stars
                const stars = document.querySelectorAll('.rating-star');
                stars.forEach(star => {
                    star.classList.remove('active');
                });
                averageEl.textContent = 'Rate this level';
            }
        } else {
            ratingContainer.style.display = 'none';
        }
    },

    setupLoading: function() {
        const loadingText = document.getElementById('loading-text');
        const texts = [
            "Optimizing for your device...",
            "Loading neon effects...",
            "Preparing levels...",
            "Initializing audio...",
            "Scanning for controllers...",
            "Loading achievements...",
            "Setting up save system...",
            "Almost ready..."
        ];
        
        let textIndex = 0;
        setInterval(() => {
            loadingText.textContent = texts[textIndex];
            textIndex = (textIndex + 1) % texts.length;
        }, 800);
    },

    loadSettings: function() {
        // Update UI with saved settings
        document.getElementById('quality-select').value = settings.graphics.quality;
        document.getElementById('particles-toggle').checked = settings.graphics.particles;
        document.getElementById('screenshake-toggle').checked = settings.graphics.screenshake;
        document.getElementById('ipad-mode-toggle').checked = settings.graphics.ipadMode;
        
        document.getElementById('volume-slider').value = settings.audio.volume;
        document.getElementById('volume-value').textContent = settings.audio.volume + '%';
        document.getElementById('music-volume-slider').value = settings.audio.musicVolume;
        document.getElementById('music-volume-value').textContent = settings.audio.musicVolume + '%';
        document.getElementById('sfx-toggle').checked = settings.audio.sfx;
        document.getElementById('music-toggle').checked = settings.audio.music;
        document.getElementById('sound-pack-select').value = settings.audio.soundPack || 'default';
        
        document.getElementById('mobile-opt-toggle').checked = settings.gameplay.mobileOpt;
        document.getElementById('fps-toggle').checked = settings.gameplay.showFPS;
        document.getElementById('vibration-toggle').checked = settings.gameplay.vibration;
        document.getElementById('auto-retry-toggle').checked = settings.gameplay.autoRetry;
        document.getElementById('time-trial-toggle').checked = settings.gameplay.timeTrial;
        
        document.getElementById('sensitivity-slider').value = settings.controls.sensitivity;
        const sensitivityText = ['Low', 'Medium', 'High'];
        document.getElementById('sensitivity-value').textContent = sensitivityText[settings.controls.sensitivity - 1];
        
        document.getElementById('controller-toggle').checked = settings.controls.controller;
        document.getElementById('deadzone-slider').value = settings.controls.deadzone;
        document.getElementById('deadzone-value').textContent = settings.controls.deadzone + '%';
        document.getElementById('controller-sensitivity-slider').value = Math.round((settings.controls.controllerSensitivity || 0.3) * 100);
        document.getElementById('controller-sensitivity-value').textContent = (settings.controls.controllerSensitivity || 0.3).toFixed(2);
        
        document.getElementById('ui-scale-slider').value = settings.display.uiScale;
        document.getElementById('ui-scale-value').textContent = settings.display.uiScale + '%';
        document.getElementById('timer-toggle').checked = settings.display.showTimer;
        document.getElementById('colorblind-toggle').checked = settings.display.colorblind;
        document.getElementById('high-contrast-toggle').checked = settings.display.highContrast;
        document.getElementById('large-text-toggle').checked = settings.display.largeText;
        document.getElementById('reduced-motion-toggle').checked = settings.display.reducedMotion;
        document.getElementById('button-borders-toggle').checked = settings.display.buttonBorders;
        
        this.currentQuality = settings.graphics.quality;
        this.ipadMode = settings.graphics.ipadMode;
        this.updatePerformanceIndicator();
        this.applyiPadMode();
        this.applyAccessibilitySettings();
        this.applyButtonBorders();
    },

    applyGraphicsSettings: function() {
        this.currentQuality = settings.graphics.quality;
        this.updatePerformanceIndicator();
        
        if (settings.graphics.quality === 'low') {
            this.ctx.imageSmoothingEnabled = false;
        } else {
            this.ctx.imageSmoothingEnabled = true;
        }
    },

    applyiPadMode: function() {
        const indicator = document.getElementById('ipad-mode-indicator');
        if (this.ipadMode) {
            indicator.style.display = 'block';
            // Reduce background processes in iPad mode
            if (typeof requestIdleCallback !== 'undefined') {
                // Use idle callbacks for non-critical tasks
            }
            // Reduce particle count
            Effects.maxParticles = 50;
            // Disable some visual effects for performance
            if (this.ctx) {
                this.ctx.imageSmoothingEnabled = false;
            }
        } else {
            indicator.style.display = 'none';
            Effects.maxParticles = settings.graphics.quality === 'low' ? 50 : 
                                  settings.graphics.quality === 'medium' ? 100 : 200;
        }
    },

    applyAccessibilitySettings: function() {
        // High contrast mode
        if (settings.display.highContrast) {
            document.body.classList.add('accessibility-high-contrast');
        } else {
            document.body.classList.remove('accessibility-high-contrast');
        }
        
        // Large text mode
        if (settings.display.largeText) {
            document.body.classList.add('accessibility-large-text');
        } else {
            document.body.classList.remove('accessibility-large-text');
        }
        
        // Reduced motion
        if (settings.display.reducedMotion) {
            // Disable animations
            document.querySelectorAll('*').forEach(el => {
                const style = window.getComputedStyle(el);
                if (style.animationDuration !== '0s') {
                    el.style.animationDuration = '0s';
                }
                if (style.transitionDuration !== '0s') {
                    el.style.transitionDuration = '0s';
                }
            });
        }
    },

    applyButtonBorders: function() {
        if (settings.display.buttonBorders) {
            document.documentElement.style.setProperty('--black-outline', '2px solid #000');
        } else {
            document.documentElement.style.setProperty('--black-outline', 'none');
        }
    },

    applyUIScale: function(scale) {
        document.documentElement.style.fontSize = `${scale}%`;
    },

    updatePerformanceIndicator: function() {
        const indicator = document.getElementById('performance-indicator');
        if (settings.gameplay.showFPS) {
            indicator.style.display = 'block';
            indicator.textContent = `Performance: ${this.currentQuality.charAt(0).toUpperCase() + this.currentQuality.slice(1)} | FPS: ${Math.round(this.fps)}`;
            if (this.ipadMode) {
                indicator.textContent += ' | üì± iPad Mode';
            }
        } else {
            indicator.style.display = 'none';
        }
    },

    updateCoinDisplay: function() {
        document.getElementById('coin-count-val').innerText = totalCoins;
        if(document.getElementById('menu-coins')) document.getElementById('menu-coins').innerText = totalCoins;
        if(document.getElementById('shop-coins')) document.getElementById('shop-coins').innerText = totalCoins;
        localStorage.setItem('nd_coins', totalCoins);
    },

    resize: function() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.floorY = this.canvas.height - 150;
        this.isMobile = window.innerWidth <= 768;
        this.checkMobileControls();
    },

    checkMobileControls: function() {
        if (this.isMobile && this.state === 'game' && settings.gameplay.mobileOpt) {
            document.getElementById('game-container').classList.add('show-mobile');
        } else {
            document.getElementById('game-container').classList.remove('show-mobile');
        }
    },

    loadLevel: function(idx) {
        if(idx < 0 || idx >= LEVELS.length) return;
        this.currLvlIdx = idx;
        
        const themeIdx = idx % THEMES.length; 
        const theme = THEMES[themeIdx];
        this.bgHue = theme[1];
        this.bgSat = theme[2];
        
        this.level = JSON.parse(JSON.stringify(LEVELS[idx])); 
        this.currentCheckpoint = null;
        this.startPos = { x: CFG.START_X * CFG.tile, y: 0, g: CFG.g, mode: 'cube', scale: CFG.MACRO_SCALE };
        this.timeScale = 1.0;
        this.clearSlowTimer(); 
        
        // Clear all particles on level load
        Effects.clearAllParticles();
        
        // Update level rating display
        this.updateLevelRatingDisplay();
        
        this.start(theme[0]); 
    },

    start: function(bgmFreq) {
        this.state = 'game';
        Player.reset();
        this.camX = 0;
        this.att = 1; 
        document.getElementById('att').innerText = this.att;
        UI.hide();
        document.getElementById('hud').style.display = 'block';
        if (settings.audio.music) AUDIO.startBGM(bgmFreq);
        this.checkMobileControls(); 
        
        const goalObject = this.level.find(o => o.t === 99);
        this.goalX = goalObject ? goalObject.x * CFG.tile : 100000;

        // Start time trial if enabled
        if (settings.gameplay.timeTrial) {
            TimeTrial.start();
        }
        
        // Achievement: First jump
        if(this.currLvlIdx === 0 && !tutorialDone) { 
            this.showTutorialMessage("Hold JUMP for continuous jumps!", 5000);
            tutorialDone = true;
            localStorage.setItem('nd_tutorial_done', 'true');
        }
    },

    showTutorialMessage: function(message, duration) {
        const msgEl = document.getElementById('tutorial-msg');
        msgEl.innerText = message;
        msgEl.style.display = 'block';
        if (duration) {
            setTimeout(() => {
                if(msgEl.innerText === message) msgEl.style.display = 'none';
            }, duration);
        }
    },

    retry: function(e) { 
        if(e) e.preventDefault(); 
        if (this.state === 'game' || this.state === 'dead' || this.state === 'win') {
            this.state = 'game';
            
            Player.reset(this.currentCheckpoint); 

            this.att++;
            document.getElementById('att').innerText = this.att;
            UI.hide();
            document.getElementById('tutorial-msg').style.display = 'none';
            this.checkMobileControls(); 
            this.timeScale = 1.0;
            Game.dashActive = false;
            this.clearSlowTimer();
            
            // Clear all particles on retry
            Effects.clearAllParticles();
            
            if (LevelEditor.isActive && Game.exitToEditor) {
                try {
                    this.level = JSON.parse(JSON.stringify(Game.originalEditorState));
                } catch (error) {
                    console.error("Failed to reload editor level on retry:", error);
                    this.level = [
                        {t: 1, x: 10, y: 0}, {t: 1, x: 14, y: 0}, {t: 1, x: 18, y: 0},
                        {t: 99, x: 50, y: 0}
                    ];
                }
            } else if(!this.currentCheckpoint) {
                try {
                    this.level = JSON.parse(JSON.stringify(LEVELS[this.currLvlIdx]));
                } catch (error) {
                    console.error("Failed to reload level on retry:", error);
                    this.level = JSON.parse(JSON.stringify(LEVELS[0]));
                }
            } else {
                this.level = this.currentCheckpoint.levelState;
            }
            
            const goalObject = this.level.find(o => o.t === 99);
            this.goalX = goalObject ? goalObject.x * CFG.tile : 100000;
            
            // Reset time trial if active
            if (settings.gameplay.timeTrial) {
                TimeTrial.reset();
                TimeTrial.start();
            }
        }
    },

    setCheckpoint: function(x, y, g, mode, scale) {
        this.currentCheckpoint = {
            x: x, 
            y: y, 
            g: g, 
            mode: mode, 
            scale: scale,
            levelState: JSON.parse(JSON.stringify(this.level)) 
        };
        AUDIO.checkpoint();
        this.showTutorialMessage("Checkpoint Saved!", 2000);
    },

    win: function() {
        if (LevelEditor.isActive && Game.exitToEditor) {
            alert('Level test completed successfully! Returning to editor.');
            Game.exitToEditor();
            return;
        }
        if (this.state === 'game') {
            this.state = 'win';
            AUDIO.win();
            AUDIO.stopBGM();
            this.clearSlowTimer();
            
            // Stop time trial
            if (settings.gameplay.timeTrial) {
                TimeTrial.stop();
            }
            
            // Update unlocked levels
            if (this.currLvlIdx + 2 > unlocked) {
                unlocked = this.currLvlIdx + 2;
                localStorage.setItem('nd_level', unlocked);
                document.getElementById('unlock-count').innerText = unlocked;
            }
            
            // Submit to leaderboard
            Leaderboard.submitScore('Player', this.currLvlIdx, this.att, 'level');
            
            // Auto-save
            SaveSystem.autoSave();
            
            document.getElementById('pause-title').innerText = `LEVEL ${this.currLvlIdx + 1} COMPLETE!`;
            document.getElementById('pause-p').innerText = `Attempts: ${this.att}`;
            
            this.pauseBtn.innerText = `NEXT LEVEL ${this.currLvlIdx + 2}`;
            this.pauseBtn.classList.add('next');
            this.pauseBtn.onclick = () => {
                Transitions.show(() => {
                    if (this.currLvlIdx + 1 < LEVELS.length) {
                        Game.loadLevel(this.currLvlIdx + 1);
                    } else {
                        alert('Congratulations! You beat all current levels!');
                        UI.home();
                    }
                });
            };

            UI.show('menu-pause');
        }
    },

    crash: function() {
        if (this.state === 'game' || this.state === 'dash') {
            this.state = 'dead';
            if (settings.graphics.screenshake) {
                this.shake = 10;
                document.body.classList.add('screen-shake');
                setTimeout(() => document.body.classList.remove('screen-shake'), 500);
            }
            this.timeScale = 1.0;
            Game.dashActive = false;
            this.clearSlowTimer();
            
            AUDIO.die();
            AUDIO.stopBGM();
            
            let percentage = Math.floor(((Player.x - (this.currentCheckpoint ? this.currentCheckpoint.x : CFG.START_X * CFG.tile)) / (this.goalX - (this.currentCheckpoint ? this.currentCheckpoint.x : CFG.START_X * CFG.tile))) * 100);
            percentage = Math.max(0, Math.min(100, percentage));
            
            document.getElementById('pause-title').innerText = 'CRASHED!';
            document.getElementById('pause-p').innerText = `${percentage}%`;
            this.pauseBtn.innerText = 'RETRY (Y Button)';
            this.pauseBtn.classList.remove('next');
            this.pauseBtn.onclick = () => Game.retry();
            
            UI.show('menu-pause');
            
            // Auto-retry if enabled
            if (settings.gameplay.autoRetry) {
                setTimeout(() => {
                    if (this.state === 'dead') {
                        Game.retry();
                    }
                }, 2000);
            }
        }
    },
    
    applySlow: function() {
        if (this.slowTimer) {
            clearTimeout(this.slowTimer);
        }
        Game.timeScale = CFG.SLOW_FACTOR;
        Player.dx = CFG.spd * Game.timeScale;
        AUDIO.slow();
        Game.showTutorialMessage("SLOW MOTION!", 1500);

        this.slowTimer = setTimeout(() => {
            Game.timeScale = 1.0;
            Player.dx = CFG.spd * Game.timeScale;
            this.slowTimer = null;
        }, CFG.SLOW_DURATION);
    },

    clearSlowTimer: function() {
        if (this.slowTimer) {
            clearTimeout(this.slowTimer);
            this.slowTimer = null;
        }
        this.timeScale = 1.0;
    },

    loop: function(timestamp) {
        // Update controller
        Controller.update();
        
        // Update time trial
        if (TimeTrial.active) {
            TimeTrial.update();
        }
        
        // Calculate delta time
        if (!this.lastFrameTime) this.lastFrameTime = timestamp;
        this.deltaTime = Math.min((timestamp - this.lastFrameTime) / 16.67, 2.0);
        this.lastFrameTime = timestamp;
        
        // Calculate FPS
        this.frameCount++;
        if (timestamp - this.lastFpsUpdate >= 1000) {
            this.fps = (this.frameCount * 1000) / (timestamp - this.lastFpsUpdate);
            this.lastFpsUpdate = timestamp;
            this.frameCount = 0;
            this.updatePerformanceIndicator();
        }
        
        let ctx = this.ctx;
        
        // Clear canvas
        if (this.currentQuality === 'low' || this.ipadMode) {
            ctx.fillStyle = '#000011';
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        } else {
            let hue = this.bgHue;
            if (this.bgSat > 30) hue = (this.bgHue + (Player.x / 20) % 360) % 360; 
            
            const gradient = ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
            gradient.addColorStop(0, `hsl(${hue}, ${this.bgSat}%, 5%)`);
            gradient.addColorStop(1, `hsl(${(hue + 60) % 360}, ${this.bgSat}%, 8%)`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
        
        ctx.save();
        
        // Apply screen shake
        if(this.shake > 0) {
            const shakeAmount = this.shake * (settings.graphics.screenshake ? 1 : 0);
            ctx.translate((Math.random() - 0.5) * shakeAmount, (Math.random() - 0.5) * shakeAmount);
            this.shake *= 0.9;
            if (this.shake < 0.1) this.shake = 0;
        }
        
        if(Player.g < 0) {
            ctx.scale(1, -1);
            ctx.translate(0, -this.canvas.height); 
        }

        if(this.state === 'game') {
            Player.update(this.deltaTime);
            this.camX = Player.x - 300;
        } 
        else if (this.state === 'editor') {
            LevelEditor.updateCamera();
            this.camX = LevelEditor.editorCamX;
        }

        let targetY = Player.y * 0.6;
        let camY = (this.canvas.height - 150) - targetY; 
        
        // Draw grid lines (optimized)
        if (this.currentQuality !== 'low' && !this.ipadMode) {
            ctx.strokeStyle = `hsla(${this.bgHue}, 80%, 70%, 0.2)`;
            ctx.lineWidth = 2;
            ctx.shadowBlur = this.currentQuality === 'high' ? 10 : 5;
            ctx.shadowColor = `hsl(${this.bgHue}, 80%, 70%)`;
            let ox = -(this.camX % CFG.tile);
            const gridStep = this.currentQuality === 'low' ? CFG.tile * 2 : CFG.tile;
            for(let i = ox; i < this.canvas.width; i += gridStep) {
                ctx.beginPath(); 
                ctx.moveTo(i, 0); 
                ctx.lineTo(i, this.canvas.height); 
                ctx.stroke();
            }
            ctx.shadowBlur = 0;
        }
        
        // Floor with neon effect
        ctx.fillStyle = Player.mainColor;
        if (!this.ipadMode) {
            ctx.shadowBlur = this.currentQuality === 'high' ? 20 : 10;
            ctx.shadowColor = Player.mainColor;
        }
        ctx.fillRect(0, camY, this.canvas.width, 4); 
        ctx.shadowBlur = 0;
        ctx.fillStyle = this.currentQuality === 'high' ? '#111' : '#222';
        ctx.fillRect(0, camY + 4, this.canvas.width, 500);

        // Death zone boundaries
        const deathZoneTop = camY - CFG.FLYING_SPIKE_ZONE;
        const deathZoneBottom = camY + 4 + CFG.FLYING_SPIKE_ZONE;
        
        if (this.currentQuality === 'high' && !this.ipadMode) {
            ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.fillRect(0, deathZoneTop, this.canvas.width, 10);
            ctx.fillRect(0, deathZoneBottom, this.canvas.width, 10);
            
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, deathZoneTop);
            ctx.lineTo(this.canvas.width, deathZoneTop);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, deathZoneBottom);
            ctx.lineTo(this.canvas.width, deathZoneBottom);
            ctx.stroke();
        }

        // Draw level objects
        this.level.forEach(o => {
            let dx = o.x * CFG.tile - this.camX;
            let oy = -(o.y * CFG.tile); 
            let dy = camY + oy - CFG.tile; 

            // Culling
            if(dx < -CFG.tile * 2 || dx > this.canvas.width + CFG.tile * 2) return;

            if(o.t === 1) { // Block
                ctx.fillStyle = `hsl(${this.bgHue}, 80%, 60%)`;
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = `hsl(${this.bgHue}, 80%, 60%)`;
                }
                ctx.fillRect(dx, dy, CFG.tile, CFG.tile); 
                ctx.shadowBlur = 0;
                if (this.currentQuality !== 'low' && !this.ipadMode) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.9)'; 
                    ctx.lineWidth = 4; 
                    ctx.strokeRect(dx, dy, CFG.tile, CFG.tile); 
                }
                ctx.fillStyle = 'rgba(0,0,0,0.5)'; 
                ctx.fillRect(dx + 5, dy + 5, CFG.tile - 10, CFG.tile - 10); 
            } 
            else if (o.t === 2) { // Spike
                ctx.fillStyle = '#ff3333'; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#ff3333';
                }
                ctx.beginPath(); 
                if (o.y === 8) {
                    ctx.moveTo(dx + 10, dy); 
                    ctx.lineTo(dx + 25, dy + 45); 
                    ctx.lineTo(dx + 40, dy); 
                } else {
                    ctx.moveTo(dx + 10, dy + CFG.tile); 
                    ctx.lineTo(dx + 25, dy + 5); 
                    ctx.lineTo(dx + 40, dy + CFG.tile); 
                }
                ctx.fill(); 
                ctx.shadowBlur = 0;
                if (this.currentQuality !== 'low' && !this.ipadMode) {
                    ctx.strokeStyle = '#fff'; 
                    ctx.lineWidth = 2; 
                    ctx.stroke(); 
                }
            }
            else if (o.t === 3) { // Coin
                ctx.fillStyle = '#ffff00'; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = '#ffff00';
                }
                ctx.beginPath(); 
                ctx.arc(dx + 25, dy + 25, 12, 0, 7); 
                ctx.fill(); 
                ctx.shadowBlur = 0;
                if (this.currentQuality !== 'low' && !this.ipadMode) {
                    ctx.strokeStyle = '#ff00ff'; 
                    ctx.lineWidth = 4; 
                    ctx.beginPath(); 
                    ctx.arc(dx + 25, dy + 25, 20, 0, 7); 
                    ctx.stroke(); 
                }
            }
            else if (o.t === 7) { // Jump pad
                ctx.fillStyle = '#00ffff'; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00ffff';
                }
                ctx.fillRect(dx + 5, dy + 40, 40, 10); 
                ctx.shadowBlur = 0;
                if (this.currentQuality !== 'low' && !this.ipadMode) {
                    ctx.strokeStyle = '#fff'; 
                    ctx.lineWidth = 4; 
                    ctx.strokeRect(dx + 5, dy + 40, 40, 10); 
                }
            }
            else if (o.t === 20) { // Moving platform
                ctx.fillStyle = '#ff8800'; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#ff8800';
                }
                ctx.fillRect(dx, dy, CFG.tile, 15); 
                ctx.shadowBlur = 0;
                if (this.currentQuality !== 'low' && !this.ipadMode) {
                    ctx.strokeStyle = '#fff'; 
                    ctx.lineWidth = 2; 
                    ctx.strokeRect(dx, dy, CFG.tile, 15); 
                }
            }
            // Portal types
            else if ([4,5,6,11,12,14,15,16,9,10].includes(o.t)) {
                const portalColors = {
                    4: '#00ff00', 5: '#ffaa00', 6: '#ffffff', 11: '#ff0000',
                    12: '#00ff88', 14: '#ff00ff', 15: '#ff0000', 16: '#00ff00',
                    9: '#ff8800', 10: '#0088ff'
                };
                ctx.strokeStyle = portalColors[o.t];
                ctx.lineWidth = this.currentQuality === 'low' || this.ipadMode ? 4 : 6;
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 20;
                    ctx.shadowColor = portalColors[o.t];
                }
                ctx.strokeRect(dx, dy, 40, CFG.GRAVITY_BLOCK_HEIGHT);
                ctx.shadowBlur = 0;
            }
            else if (o.t === 13) { // Checkpoint
                ctx.fillStyle = 'rgba(0, 255, 0, 0.3)'; 
                ctx.fillRect(dx, -500, 10, 2000); 
                ctx.strokeStyle = 'rgba(0, 255, 0, 0.8)'; 
                ctx.lineWidth = 6; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00ff00';
                }
                ctx.beginPath(); 
                ctx.moveTo(dx, dy + CFG.tile - 5); 
                ctx.lineTo(dx + 10, dy + CFG.tile - 5); 
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
            else if (o.t === 99) { // Goal
                ctx.fillStyle = '#00ff00'; 
                ctx.globalAlpha = 0.4; 
                if (this.currentQuality === 'high' && !this.ipadMode) {
                    ctx.shadowBlur = 30;
                    ctx.shadowColor = '#00ff00';
                }
                ctx.fillRect(dx, -500, 100, 2000); 
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }
        });

        if(this.state !== 'dead') Player.draw(ctx, camY);

        // Update and draw particles (if enabled)
        if (settings.graphics.particles) {
            Effects.update();
            Effects.draw(ctx, camY);
        }

        if(this.state === 'game') {
            let endX = this.goalX;
            let startX = this.currentCheckpoint ? this.currentCheckpoint.x : CFG.START_X * CFG.tile;
            
            let p = Math.max(0, Math.min(100, ((Player.x - startX) / (endX - startX)) * 100));
            document.getElementById('prog').style.width = p + '%';
            document.getElementById('progress-percent').innerText = Math.round(p) + '%';
        }

        ctx.restore();
        
        // Use requestAnimationFrame
        requestAnimationFrame((t) => this.loop(t));
    }
};

// --- IMPROVED PLAYER PHYSICS ---
const Player = {
    x:0, y:0, w:40, h:40, 
    dx: CFG.spd, dy:0, 
    mode:'cube', angle:0, onGround:false,
    g: CFG.g,
    scale: CFG.MACRO_SCALE, 
    mainColor: '#00ffff',
    secondaryColor: '#ff0088',
    waveAngle: 0, 
    isSwinging: false, 
    swingBlock: null,
    lastJumpTime: 0,
    dashTargetX: 0,
    dashTime: 0,
    velocityX: 0,
    velocityY: 0,
    lastX: 0,
    lastY: 0,
    interpolationFactor: 0.2,

    loadColors: function() {
        const skin = SKINS[equippedSkinIndex];
        this.mainColor = skin.main;
        this.secondaryColor = skin.secondary;
        document.documentElement.style.setProperty('--player-main', this.mainColor);
        document.documentElement.style.setProperty('--player-sec', this.secondaryColor);
    },

    equipSkin: function(index) {
        equippedSkinIndex = index;
        localStorage.setItem('nd_equipped_skin', index);
        this.loadColors();
        UI.renderShop();
    },

    updateSize: function(newScale) {
        if(this.scale === newScale) return;
        let oldH = this.h;
        this.scale = newScale;
        this.w = 40 * this.scale;
        this.h = 40 * this.scale;
        
        if (this.g > 0) { this.y = this.y + (oldH - this.h); } 
        else { this.y = this.y - (oldH - this.h); }
        
        this.g = (CFG.g * newScale) * Math.sign(this.g);
    },

    reset: function(checkpoint) {
        if (checkpoint) {
            this.x = checkpoint.x; this.y = checkpoint.y; 
            this.g = checkpoint.g; this.scale = checkpoint.scale;
            this.mode = checkpoint.mode;
        } else {
            this.x = CFG.START_X * CFG.tile; this.y = 0; 
            this.g = CFG.g; this.scale = CFG.MACRO_SCALE;
            this.mode = 'cube';
        }
        
        this.dy = 0; this.angle = 0; 
        this.velocityX = CFG.spd;
        this.velocityY = 0;
        this.onGround = true;
        this.w = 40 * this.scale; this.h = 40 * this.scale;
        this.waveAngle = 0;
        this.isSwinging = false;
        this.swingBlock = null;
        this.dashTargetX = 0;
        this.dashTime = 0;
        Game.timeScale = 1.0;
        this.setMode(this.mode, true);
    },

    update: function(deltaTime) {
        if (this.x + this.w + this.dx > Game.goalX) { Game.win(); return; }

        const dt = deltaTime;
        const gravityFactor = this.scale * (this.g > 0 ? 1 : -1);
        const termScaled = CFG.term * this.scale;
        
        this.lastX = this.x;
        this.lastY = this.y;
        
        // Height limit death
        if (this.y > 0 || this.y - this.h < CFG.maxHeight) {
            Game.crash();
            return;
        }

        // DASH MECHANICS
        if (this.dashTime > 0) {
            this.dashTime -= dt;
            this.x += 25 * Game.timeScale * dt;
            this.dy = 0;
            
            // Create dash trail effect
            if (Math.random() < 0.3) {
                Effects.createDashTrail(this.x, this.y, this.mainColor);
            }
            
            if (this.dashTime <= 0) {
                this.dashTargetX = 0;
                Game.dashActive = false;
                this.dx = CFG.spd * Game.timeScale;
            }
        } else {
            this.dx = CFG.spd * Game.timeScale;
        }

        if(this.dashTime <= 0) { 
            if(this.mode === 'cube' || this.mode === 'robot') {
                this.dy += CFG.g * gravityFactor * Game.timeScale * dt;
                if(this.mode === 'cube') {
                    if(this.onGround) {
                        let r = Math.round(this.angle/(Math.PI/2))*(Math.PI/2);
                        this.angle += (r-this.angle) * 0.25 * dt; 
                        
                        if (Input.held) {
                            this.jump(true); 
                        }
                    } else {
                        this.angle += 0.18 * Math.sign(this.g) * Game.timeScale * dt;
                    }
                } else { 
                    this.angle += (0-this.angle) * 0.1 * dt;
                }
            } 
            else if (this.mode === 'ship' || this.mode === 'ufo') {
                if(Input.held) this.dy -= (this.mode === 'ship' ? 0.6 : 0.7) * gravityFactor * Game.timeScale * dt; 
                else this.dy += (this.mode === 'ship' ? 0.5 : CFG.g) * gravityFactor * Game.timeScale * dt; 
                this.angle = this.dy * 0.15;
            } 
            else if (this.mode === 'wave') {
                if(Input.held) this.waveAngle = 45 * Math.sign(this.g);
                else this.waveAngle = -45 * Math.sign(this.g);
                
                const waveSpeed = 8 * this.scale;
                const waveRad = this.waveAngle * (Math.PI / 180);
                this.dy = Math.sin(waveRad) * -waveSpeed * Game.timeScale * dt; 
                
                this.angle = waveRad * 1.5;
                this.dy += this.g * 0.0001; 
            }
            else if (this.mode === 'swing') {
                this.dy += CFG.g * gravityFactor * Game.timeScale * dt;
                this.angle += (0-this.angle) * 0.1 * dt; 
            }

            if (this.mode !== 'wave') {
                if(this.dy > termScaled) this.dy = termScaled;
                if(this.dy < -termScaled) this.dy = -termScaled;
            }
        }

        this.x += this.dx * dt;
        this.checkCol(true, dt);

        this.y += this.dy * dt;
        this.onGround = false;

        const floorHeight = 0;
        const ceilingHeight = CFG.maxHeight;

        // Height limit enforcement
        if(this.g > 0) { 
            if(this.y > floorHeight) { this.y = floorHeight; this.dy = 0; this.onGround = true; }
            if(this.y - this.h < ceilingHeight) { Game.crash(); return; }
        } else {
            if(this.y - this.h < ceilingHeight) { this.y = ceilingHeight + this.h; this.dy = 0; this.onGround = true; }
            if(this.y > floorHeight) { Game.crash(); return; }
        }

        this.checkCol(false, dt);
        
        // Update distance stat for achievements
        const distance = Math.sqrt(Math.pow(this.x - this.lastX, 2) + Math.pow(this.y - this.lastY, 2));
        Achievements.incrementStat('totalDistance', distance);
    },

    checkCol: function(isX, deltaTime) {
        let l = this.x, r = this.x + this.w, t = this.y - this.h, b = this.y;
        
        for (let i = Game.level.length - 1; i >= 0; i--) {
            const o = Game.level[i];
            
            if(Math.abs(o.x * CFG.tile - this.x) > 100) continue; 

            let ox = o.x * CFG.tile, oy = -(o.y * CFG.tile);
            let ol = ox, or = ox + CFG.tile, ot = oy - CFG.tile, ob = oy;

            if(r > ol && l < or && b > ot && t < ob) {
                
                if(o.t === 2) {
                    Game.crash();
                    Achievements.incrementStat('spikesDodged');
                }
                else if(o.t === 3) { 
                    totalCoins++; 
                    AUDIO.coin(); 
                    Game.updateCoinDisplay(); 
                    Game.level.splice(i, 1); 
                    
                    // Create coin collection effect
                    Effects.createCoinEffect(ox + 25, oy - 25);
                }
                else if(o.t === 7) { 
                    const hitFromAbove = this.g > 0 && Math.abs(b - ot) < 20;
                    const hitFromBelow = this.g < 0 && Math.abs(t - ob) < 20;
                    const hitFromSide = Math.abs(l - or) < 10 || Math.abs(r - ol) < 10;
                    
                    if (hitFromAbove || hitFromBelow || hitFromSide) {
                        this.dy = (-CFG.PAD_JUMP * this.scale) * Math.sign(this.g); 
                        this.onGround = false; 
                        AUDIO.pad();
                        Effects.createJumpPadEffect(ox + 25, oy - 25);
                    }
                }
                else if(o.t === 13) { 
                    Game.setCheckpoint(this.x, this.y, this.g, this.mode, this.scale); 
                    Game.level.splice(i, 1); 
                    Effects.createCheckpointEffect(ox + 5, oy - 25);
                }
                else if(o.t === 4) { this.setMode('ship'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#00ff00'); Achievements.incrementStat('portalsUsed'); } 
                else if(o.t === 5) { this.setMode('ufo'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#ffaa00'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 6) { this.setMode('cube'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#ffffff'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 11) { this.setMode('wave'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#ff0000'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 12) { this.setMode('robot'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#00ff88'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 14) { this.setMode('swing'); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#ff00ff'); Achievements.incrementStat('portalsUsed'); } 
                else if(o.t === 15) { 
                    this.setMode('cube'); 
                    this.dash(); 
                    Game.level.splice(i, 1); 
                    Effects.createPortalEffect(ox + 20, oy - 75, '#ff0000');
                    Achievements.incrementStat('portalsUsed');
                } 
                else if(o.t === 16) { 
                    Game.applySlow(); 
                    Game.level.splice(i, 1);
                    Effects.createPortalEffect(ox + 20, oy - 75, '#00ff00');
                    Achievements.incrementStat('portalsUsed');
                }
                else if(o.t === 9) { this.updateSize(CFG.MINI_SCALE); this.g = Math.abs(CFG.g * this.scale) * Math.sign(this.g); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#ff8800'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 10) { this.updateSize(CFG.MACRO_SCALE); this.g = Math.abs(CFG.g * this.scale) * Math.sign(this.g); Game.level.splice(i, 1); Effects.createPortalEffect(ox + 20, oy - 75, '#0088ff'); Achievements.incrementStat('portalsUsed'); }
                else if(o.t === 1) { 
                    if(this.mode === 'wave') Game.crash(); 
                    if(isX) { 
                        Game.crash(); 
                    }
                    else {
                        let prevB = b - this.dy * deltaTime; 
                        let prevT = t - this.dy * deltaTime; 
                        let hitGround = false;

                        if (this.g > 0 && this.dy > 0 && prevB <= ot + 5) { 
                            this.y = ot; 
                            this.dy = 0; 
                            hitGround = true; 
                        } 
                        else if (this.g < 0 && this.dy < 0 && prevT >= ob - 5) { 
                            this.y = ob + this.h; 
                            this.dy = 0; 
                            hitGround = true; 
                        } 
                        else if (this.g > 0 && this.dy < 0 && prevT >= ob - 5) { 
                            this.y = ob + this.h; 
                            this.dy = 0; 
                        } 
                        else if (this.g < 0 && this.dy > 0 && prevB <= ot + 5) { 
                            this.y = ot; 
                            this.dy = 0; 
                        }
                        
                        if(hitGround && (this.mode === 'cube' || this.mode === 'robot' || this.mode === 'swing')) this.onGround = true;
                        
                        if(this.mode === 'swing' && this.isSwinging) { 
                            this.isSwinging = true; 
                            this.swingBlock = o; 
                        }
                    }
                }
            }
        }
    },
    
    dash: function() {
        if (this.mode === 'cube' && this.dashTime === 0) {
            this.dashTime = 10;
            this.dy = 0; 
            Game.dashActive = true;
            AUDIO.dash();
            Game.showTutorialMessage("DASH!", 500);
            
            // Create dash effect
            Effects.createDashEffect(this.x, this.y, this.mainColor);
        }
    },

    jump: function(continuous=false) {
        const jumpForce = CFG.jmp * this.scale;
        
        if((this.mode === 'cube' && this.onGround) || (this.mode === 'robot' && this.onGround)) {
            this.dy = -jumpForce * (this.mode === 'robot' ? 1.5 : 1.0) * Math.sign(this.g);
            this.onGround = false;
            AUDIO.jump();
            
            // Create jump effect
            Effects.createJumpEffect(this.x, this.y, this.mainColor);
        } 
    },

    setMode: function(m, force = false) {
        if(this.mode === m && !force) return;
        this.mode = m; 
        
        this.g = Math.abs(CFG.g * this.scale) * Math.sign(this.g); 
        this.isSwinging = false;
        this.swingBlock = null;

        if (m === 'cube' || m === 'robot' || m === 'swing') {
            this.dy = 0;
            this.onGround = true;
        }
        
        AUDIO.pad();
        const msg = document.getElementById('msg');
        let scaleText = this.scale < 1 ? ' (MINI)' : (this.scale > 1 ? ' (MACRO)' : '');
        msg.innerText = m.toUpperCase() + scaleText; 
        msg.style.opacity = 1;
        setTimeout(()=>msg.style.opacity=0, 1000);
        
        // Create mode change effect
        Effects.createModeChangeEffect(this.x, this.y, this.mainColor);
        
        // Achievement tracking
        Achievements.incrementStat('modeChanges');
    },

    draw: function(ctx, camY) {
        ctx.save();
        let drawY = this.y + camY; 
        
        const playerCenterX = this.x - Game.camX + this.w/2;
        const playerCenterY = drawY - this.h/2;

        ctx.translate(playerCenterX, playerCenterY);
        ctx.rotate(this.angle);

        let displayMain = this.mainColor;
        
        ctx.fillStyle = displayMain;
        if (Game.currentQuality === 'high' && !Game.ipadMode) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = displayMain;
        }

        const halfW = this.w / 2;
        const halfH = this.h / 2;
        
        if (this.mode === 'wave') { 
            ctx.beginPath();
            ctx.moveTo(-halfW, halfH);
            ctx.lineTo(halfW, halfH);
            ctx.lineTo(halfW, -halfH);
            ctx.lineTo(-halfW, -halfH);
            ctx.closePath();
            ctx.fill();
            
            ctx.strokeStyle = this.secondaryColor;
            ctx.lineWidth = 4;
            ctx.stroke();

        } else {
            ctx.fillRect(-halfW, -halfH, this.w, this.h);
            
            ctx.fillStyle = this.secondaryColor; 
            ctx.fillRect(-halfW * 0.5, -halfH * 0.5, halfW, halfH); 
            ctx.fillStyle = '#fff'; 
            ctx.fillRect(-halfW * 0.25, -halfH * 0.25, halfW * 0.5, halfH * 0.5); 
        }
        
        ctx.shadowBlur = 0;
        ctx.restore();
    }
};

// --- ENHANCED UI ---
const UI = {
    hide: () => {
        document.querySelectorAll('.ui-layer').forEach(e => {
            e.classList.replace('visible','hidden');
            e.classList.remove('enhanced-transition');
        });
    },
    
    show: (id) => { 
        UI.hide();
        const element = document.getElementById(id);
        element.classList.replace('hidden', 'visible');
        element.classList.add('enhanced-transition');
        
        // Update controller navigation items
        if (Controller.connected) {
            Controller.navigationItems = Array.from(element.querySelectorAll('button, .lvl-btn.unlocked, .costume-item, .save-slot, .sound-item, .game-mode-item'));
            if (Controller.navigationItems.length > 0) {
                Controller.navigationItems[0].focus();
            }
        }
    },
    
    home: () => { 
        Game.state = 'menu';
        document.getElementById('hud').style.display = 'none';
        document.getElementById('unlock-count').innerText = unlocked;
        document.getElementById('menu-coins').innerText = totalCoins;
        document.getElementById('menu-achievements').innerText = `${Achievements.getUnlockedCount()}/${Achievements.list.length}`;
        Game.checkMobileControls();
        AUDIO.stopBGM();
        Game.clearSlowTimer(); 
        TimeTrial.reset();
        UI.show('menu-main');
    },
    
    startPlay: () => { 
        UI.showLevels();
    },
    
    changeLevelPage: (direction) => {
        const maxPage = Math.ceil(CFG.TOTAL_LEVELS / CFG.LEVELS_PER_PAGE);
        currentPage = Math.min(maxPage, Math.max(1, currentPage + direction));
        UI.renderLevelGrid();
    },

    renderLevelGrid: () => {
        const grid = document.getElementById('lvl-grid');
        const prevBtn = document.getElementById('level-prev');
        const nextBtn = document.getElementById('level-next');

        grid.innerHTML = '';
        
        const start = (currentPage - 1) * CFG.LEVELS_PER_PAGE;
        const end = Math.min(CFG.TOTAL_LEVELS, start + CFG.LEVELS_PER_PAGE);

        for(let i = start; i < end; i++) {
            let b = document.createElement('div');
            b.innerText = i + 1; 
            b.className = 'lvl-btn';
            b.tabIndex = 0;
            
            if(i + 1 > unlocked) {
                b.classList.add('locked');
            } else {
                b.classList.add('unlocked');
                b.onclick = () => {
                    Transitions.show(() => Game.loadLevel(i));
                };
                b.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        Transitions.show(() => Game.loadLevel(i));
                    }
                };
            }
            grid.appendChild(b);
        }
        
        for(let i = end; i < start + CFG.LEVELS_PER_PAGE; i++) {
            let b = document.createElement('div');
            b.innerText = '';
            b.className = 'lvl-btn locked';
            b.style.opacity = 0.2;
            grid.appendChild(b);
        }

        const maxPage = Math.ceil(CFG.TOTAL_LEVELS / CFG.LEVELS_PER_PAGE);
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= maxPage;
        
        // Update level rating display
        Game.updateLevelRatingDisplay();
    },

    showLevels: () => {
        UI.renderLevelGrid();
        UI.show('menu-levels');
    },

    renderShop: function() {
        const shopContent = document.getElementById('shop-content');
        shopContent.innerHTML = '';

        SKINS.forEach((skin, index) => {
            const item = document.createElement('div');
            item.className = 'costume-item';
            item.tabIndex = 0;

            const isUnlocked = unlockedSkins.includes(index);
            const isEquipped = equippedSkinIndex === index;

            if (isUnlocked) item.classList.add('unlocked');
            if (isEquipped) item.classList.add('equipped');

            const previewHTML = `
                <div class="costume-preview" style="border-color: ${skin.main};">
                    <div class="player-preview-cube" style="background-color:${skin.main}; border-color:${skin.secondary};">
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:15px; height:15px; background-color:${skin.secondary};"></div>
                        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:5px; height:5px; background-color:#fff;"></div>
                    </div>
                </div>
            `;
            
            let actionText = '';
            if (isEquipped) {
                actionText = '<span style="color:var(--neon-green); text-shadow: 0 0 10px var(--neon-green);">EQUIPPED</span>';
            } else if (isUnlocked) {
                actionText = 'Click to Equip';
            } else {
                actionText = `Cost: ${skin.cost} üí∞`;
            }

            item.innerHTML = `
                ${previewHTML}
                <strong style="color: ${skin.main};">${skin.name}</strong><br>
                <div class="cost">${actionText}</div>
            `;
            
            item.onclick = (e) => {
                e.stopPropagation(); 
                if (isUnlocked) {
                    Player.equipSkin(index);
                } else if (totalCoins >= skin.cost) {
                    totalCoins -= skin.cost;
                    unlockedSkins.push(index);
                    localStorage.setItem('nd_skins', JSON.stringify(unlockedSkins));
                    Game.updateCoinDisplay();
                    Player.equipSkin(index);
                    
                    // Achievement check
                    if (unlockedSkins.length >= 3) {
                        Achievements.unlock('skin_collector');
                    }
                    if (unlockedSkins.length === SKINS.length) {
                        Achievements.unlock('all_skins');
                    }
                } else {
                    alert(`Not enough coins! Requires ${skin.cost} üí∞.`);
                }
            };
            
            item.onkeydown = (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    item.onclick(e);
                }
            };

            shopContent.appendChild(item);
        });
    },

    showShop: function() {
        UI.renderShop();
        UI.show('menu-shop');
    },

    showEditor: function() {
        UI.show('menu-editor');
    },

    showSettings: function() {
        UI.show('menu-settings');
    },

    showWhatsNew: function() {
        UI.show('menu-whatsnew');
    },

    showAchievements: function() {
        Achievements.renderList();
        UI.show('menu-achievements');
    },

    showSaveSystem: function() {
        SaveSystem.updateSlotDisplay();
        UI.show('menu-savesystem');
    },

    showLeaderboard: function() {
        const typeSelect = document.getElementById('leaderboard-type');
        const levelSelect = document.getElementById('leaderboard-level');
        
        typeSelect.onchange = () => {
            Leaderboard.render(typeSelect.value);
        };
        
        levelSelect.onchange = () => {
            Leaderboard.render(typeSelect.value);
        };
        
        Leaderboard.render(typeSelect.value);
        UI.show('menu-leaderboard');
    },

    showSoundLibrary: function() {
        SoundLibrary.render();
        UI.show('menu-soundlibrary');
    },

    showGameModes: function() {
        GameModes.render();
        UI.show('menu-gamemodes');
    },

    showControllerLayout: function() {
        UI.show('menu-controllerlayout');
    },

    saveSettings: function() {
        // Save graphics settings
        settings.graphics.quality = document.getElementById('quality-select').value;
        settings.graphics.particles = document.getElementById('particles-toggle').checked;
        settings.graphics.screenshake = document.getElementById('screenshake-toggle').checked;
        settings.graphics.ipadMode = document.getElementById('ipad-mode-toggle').checked;
        
        // Save audio settings
        settings.audio.volume = parseInt(document.getElementById('volume-slider').value);
        settings.audio.musicVolume = parseInt(document.getElementById('music-volume-slider').value);
        settings.audio.sfx = document.getElementById('sfx-toggle').checked;
        settings.audio.music = document.getElementById('music-toggle').checked;
        settings.audio.soundPack = document.getElementById('sound-pack-select').value;
        
        // Save gameplay settings
        settings.gameplay.mobileOpt = document.getElementById('mobile-opt-toggle').checked;
        settings.gameplay.showFPS = document.getElementById('fps-toggle').checked;
        settings.gameplay.vibration = document.getElementById('vibration-toggle').checked;
        settings.gameplay.autoRetry = document.getElementById('auto-retry-toggle').checked;
        settings.gameplay.timeTrial = document.getElementById('time-trial-toggle').checked;
        
        // Save controls settings
        settings.controls.sensitivity = parseInt(document.getElementById('sensitivity-slider').value);
        settings.controls.controller = document.getElementById('controller-toggle').checked;
        settings.controls.deadzone = parseInt(document.getElementById('deadzone-slider').value);
        settings.controls.controllerSensitivity = parseFloat(document.getElementById('controller-sensitivity-value').textContent);
        Controller.setDeadzone(settings.controls.deadzone);
        Controller.setSensitivity(settings.controls.controllerSensitivity * 100);
        
        // Save display settings
        settings.display.uiScale = parseInt(document.getElementById('ui-scale-slider').value);
        settings.display.showTimer = document.getElementById('timer-toggle').checked;
        settings.display.colorblind = document.getElementById('colorblind-toggle').checked;
        settings.display.highContrast = document.getElementById('high-contrast-toggle').checked;
        settings.display.largeText = document.getElementById('large-text-toggle').checked;
        settings.display.reducedMotion = document.getElementById('reduced-motion-toggle').checked;
        settings.display.buttonBorders = document.getElementById('button-borders-toggle').checked;
        
        // Apply settings immediately
        AUDIO.setVolume(settings.audio.volume / 100);
        AUDIO.setMusicVolume(settings.audio.musicVolume / 100);
        Game.applyGraphicsSettings();
        Game.ipadMode = settings.graphics.ipadMode;
        Game.applyiPadMode();
        Game.applyAccessibilitySettings();
        Game.applyButtonBorders();
        Game.applyUIScale(settings.display.uiScale);
        Game.checkMobileControls();
        
        // Save to localStorage
        localStorage.setItem('nd_settings', JSON.stringify(settings));
        
        // Show confirmation
        Game.showTutorialMessage('Settings saved successfully!', 2000);
        
        UI.home();
    },

    resetToDefaults: function() {
        if (confirm('Reset all settings to defaults? This will not affect your game progress.')) {
            settings = {
                graphics: { quality: 'high', particles: true, screenshake: true, ipadMode: false },
                audio: { volume: 70, sfx: true, music: true, musicVolume: 50, soundPack: 'default' },
                gameplay: { mobileOpt: true, showFPS: false, vibration: true, autoRetry: false, timeTrial: false },
                controls: { sensitivity: 2, controller: true, deadzone: 8, controllerSensitivity: 0.3 },
                display: { uiScale: 100, showTimer: false, colorblind: false, buttonBorders: true, highContrast: false, largeText: false, reducedMotion: false },
                saveSystem: { autoSave: true, cloudBackup: false, saveSlots: [{}, {}, {}] }
            };
            
            localStorage.setItem('nd_settings', JSON.stringify(settings));
            Game.loadSettings();
            Game.showTutorialMessage('Settings reset to defaults!', 2000);
        }
    }
};

// --- ENHANCED LEVEL EDITOR ---
const LevelEditor = {
    isActive: false,
    currentTool: 1,
    tools: [
        { id: 1, name: 'Block', icon: '‚¨ú' },
        { id: 2, name: 'Spike', icon: '‚¨ÜÔ∏è' },
        { id: 3, name: 'Coin', icon: 'üí∞' },
        { id: 7, name: 'Jump Pad', icon: 'ü¶ò' },
        { id: 13, name: 'Checkpoint', icon: 'üíæ' },
        { id: 4, name: 'Ship Portal', icon: 'üöÄ' },
        { id: 5, name: 'UFO Portal', icon: 'üëΩ' },
        { id: 6, name: 'Cube Portal', icon: '‚¨õ' },
        { id: 11, name: 'Wave Portal', icon: 'üåä' },
        { id: 12, name: 'Robot Portal', icon: 'ü§ñ' },
        { id: 14, name: 'Swing Portal', icon: 'ü¶ç' },
        { id: 15, name: 'Dash Portal', icon: '‚ö°' },
        { id: 16, name: 'Slow Portal', icon: 'üêå' },
        { id: 9, name: 'Mini Portal', icon: 'üìè' },
        { id: 10, name: 'Macro Portal', icon: 'üìê' },
        { id: 20, name: 'Platform', icon: 'üüß' }
    ],
    editorCamX: 0,
    editorCamY: 0,
    gridSnap: true,
    showGrid: true,
    coinCount: 0,
    maxCoins: CFG.EDITOR_COIN_LIMIT,
    
    init: function() {
        this.createToolbar();
        this.setupEventListeners();
    },
    
    createToolbar: function() {
        const toolbar = document.getElementById('editor-tools');
        if (!toolbar) return;
        
        toolbar.innerHTML = '';
        
        this.tools.forEach((tool, index) => {
            const btn = document.createElement('button');
            btn.className = 'editor-tool-btn';
            btn.innerHTML = tool.icon;
            btn.title = tool.name;
            btn.dataset.tool = tool.id;
            
            if (tool.id === this.currentTool) {
                btn.classList.add('active');
            }
            
            btn.onclick = () => {
                this.selectTool(tool.id);
                document.querySelectorAll('.editor-tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            
            toolbar.appendChild(btn);
        });
        
        // Add control buttons
        const controls = document.createElement('div');
        controls.style.marginTop = '10px';
        controls.innerHTML = `
            <button class="editor-tool-btn" onclick="LevelEditor.testLevel()" title="Test Level (X Button)">‚ñ∂Ô∏è</button>
            <button class="editor-tool-btn" onclick="LevelEditor.save()" title="Save Level (Y Button)">üíæ</button>
            <button class="editor-tool-btn" onclick="LevelEditor.clear()" title="Clear Level">üóëÔ∏è</button>
            <button class="editor-tool-btn" onclick="LevelEditor.exit()" title="Exit Editor (Start Button)">üö™</button>
        `;
        toolbar.appendChild(controls);
    },
    
    setupEventListeners: function() {
        // Mouse events for editor
        Game.canvas.addEventListener('mousedown', (e) => {
            if (!this.isActive) return;
            
            const rect = Game.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (e.button === 0) { // Left click - place
                this.placeAt(x, y);
            } else if (e.button === 2) { // Right click - delete
                this.deleteAt(x, y);
            }
            
            e.preventDefault();
        });
        
        // Touch events for mobile
        Game.canvas.addEventListener('touchstart', (e) => {
            if (!this.isActive) return;
            
            const rect = Game.canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            this.placeAt(x, y);
            e.preventDefault();
        });
        
        // Prevent context menu on right click
        Game.canvas.addEventListener('contextmenu', (e) => {
            if (this.isActive) {
                e.preventDefault();
                return false;
            }
        });
    },
    
    startNew: function() {
        Game.state = 'editor';
        this.isActive = true;
        Game.level = [
            {t: 1, x: 10, y: 0},
            {t: 1, x: 14, y: 0},
            {t: 1, x: 18, y: 0},
            {t: 99, x: 50, y: 0}
        ];
        this.coinCount = 0;
        this.updateCoinCounter();
        UI.hide();
        document.getElementById('editor-tools').style.display = 'flex';
        document.getElementById('editor-coin-counter').style.display = 'block';
        
        // Enable controller editor mode
        Controller.enableEditorMode();
        
        Game.showTutorialMessage('Editor Mode: Left-click to place, Right-click to delete', 5000);
    },
    
    load: function() {
        const data = prompt('Paste level JSON data:');
        if (data) {
            try {
                const level = JSON.parse(data);
                if (Array.isArray(level)) {
                    Game.state = 'editor';
                    this.isActive = true;
                    Game.level = level;
                    this.coinCount = level.filter(o => o.t === 3).length;
                    this.updateCoinCounter();
                    UI.hide();
                    document.getElementById('editor-tools').style.display = 'flex';
                    document.getElementById('editor-coin-counter').style.display = 'block';
                    Controller.enableEditorMode();
                } else {
                    alert('Invalid level data');
                }
            } catch(e) {
                alert('Error parsing JSON: ' + e.message);
            }
        }
    },
    
    showCloudLevels: function() {
        // In a real implementation, this would fetch from a server
        alert('Cloud levels feature would connect to a server in the full version.');
    },
    
    selectTool: function(toolId) {
        this.currentTool = toolId;
    },
    
    placeAt: function(screenX, screenY) {
        const worldX = Math.floor((screenX + this.editorCamX) / CFG.tile);
        const worldY = Math.floor((Game.floorY - screenY) / CFG.tile);
        
        // Check for coin limit
        if (this.currentTool === 3 && this.coinCount >= this.maxCoins) {
            Game.showTutorialMessage(`Coin limit reached: ${this.maxCoins}`, 2000);
            return;
        }
        
        // Check if position is already occupied
        const existing = Game.level.findIndex(o => 
            o.x === worldX && o.y === worldY
        );
        
        if (existing >= 0) {
            // Replace existing object
            Game.level[existing].t = this.currentTool;
        } else {
            // Add new object
            Game.level.push({t: this.currentTool, x: worldX, y: worldY});
        }
        
        // Update coin count
        if (this.currentTool === 3) {
            this.coinCount++;
        } else if (existing >= 0 && Game.level[existing].t === 3) {
            this.coinCount--;
        }
        
        this.updateCoinCounter();
        
        // Visual feedback
        Effects.createParticle(screenX, screenY, '#00ff00', 0, 0, 30, 'circle', 8);
    },
    
    placeAtCrosshair: function(x, y) {
        this.placeAt(x, y);
    },
    
    deleteAt: function(screenX, screenY) {
        const worldX = Math.floor((screenX + this.editorCamX) / CFG.tile);
        const worldY = Math.floor((Game.floorY - screenY) / CFG.tile);
        
        const index = Game.level.findIndex(o => 
            o.x === worldX && o.y === worldY
        );
        
        if (index >= 0) {
            // Update coin count if deleting a coin
            if (Game.level[index].t === 3) {
                this.coinCount--;
            }
            
            Game.level.splice(index, 1);
            this.updateCoinCounter();
            
            // Visual feedback
            Effects.createParticle(screenX, screenY, '#ff0000', 0, 0, 30, 'circle', 8);
        }
    },
    
    deleteAtCrosshair: function(x, y) {
        this.deleteAt(x, y);
    },
    
    updateCoinCounter: function() {
        document.getElementById('editor-coin-counter').textContent = `Coins: ${this.coinCount}/${this.maxCoins}`;
    },
    
    testLevel: function() {
        // Save current editor state
        Game.originalEditorState = JSON.parse(JSON.stringify(Game.level));
        Game.exitToEditor = () => {
            Game.state = 'editor';
            this.isActive = true;
            Game.level = JSON.parse(JSON.stringify(Game.originalEditorState));
            UI.hide();
            document.getElementById('editor-tools').style.display = 'flex';
            document.getElementById('editor-coin-counter').style.display = 'block';
            Controller.enableEditorMode();
        };
        
        // Start testing the level
        Game.state = 'game';
        this.isActive = false;
        UI.hide();
        document.getElementById('editor-tools').style.display = 'none';
        document.getElementById('editor-coin-counter').style.display = 'none';
        document.getElementById('hud').style.display = 'block';
        Player.reset();
        Game.camX = 0;
        Game.att = 1;
        
        // Disable controller editor mode
        Controller.disableEditorMode();
        
        Game.showTutorialMessage('Testing level... Press Start to return to editor', 3000);
    },
    
    save: function() {
        // Ensure there's a goal
        const hasGoal = Game.level.some(o => o.t === 99);
        if (!hasGoal) {
            if (confirm('No goal found. Add a goal at the end?')) {
                const maxX = Math.max(...Game.level.map(o => o.x)) + 5;
                Game.level.push({t: 99, x: maxX, y: 0});
            } else {
                return;
            }
        }
        
        const data = JSON.stringify(Game.level);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `neon-dash-level-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        Game.showTutorialMessage('Level saved!', 2000);
        
        // Achievement check
        Achievements.unlock('editor_master');
    },
    
    clear: function() {
        if (confirm('Clear entire level?')) {
            Game.level = [];
            this.coinCount = 0;
            this.updateCoinCounter();
        }
    },
    
    exit: function() {
        if (confirm('Exit editor? Unsaved changes will be lost.')) {
            this.isActive = false;
            Game.state = 'menu';
            document.getElementById('editor-tools').style.display = 'none';
            document.getElementById('editor-coin-counter').style.display = 'none';
            Controller.disableEditorMode();
            UI.home();
        }
    },
    
    updateCamera: function() {
        // Camera follows mouse or controller crosshair
        if (Controller.editorMode) {
            // Follow crosshair
            this.editorCamX = Controller.crosshairX - window.innerWidth / 2;
        } else {
            // Follow mouse
            this.editorCamX = Game.canvas.width / 2;
        }
    }
};

// --- ENHANCED EFFECTS SYSTEM ---
const Effects = {
    particles: [],
    coinEffects: [],
    maxParticles: settings.graphics.quality === 'low' ? 50 : settings.graphics.quality === 'medium' ? 100 : 200,

    createParticle: function(x, y, color, velocityX, velocityY, life = 60, shape = 'circle', size = null) {
        if (!settings.graphics.particles || this.particles.length >= this.maxParticles) return;
        
        const particleSize = size || Math.random() * 8 + 4;
        
        this.particles.push({
            x: x,
            y: y,
            color: color,
            vx: velocityX,
            vy: velocityY,
            life: life,
            maxLife: life,
            size: particleSize,
            shape: shape,
            rotation: Math.random() * Math.PI * 2,
            rotationSpeed: (Math.random() - 0.5) * 0.1,
            glow: Math.random() > 0.5
        });
    },

    createDashEffect: function(x, y, color) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 15; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 15 + 5;
            this.createParticle(
                x + Math.random() * 40 - 20,
                y + Math.random() * 40 - 20,
                color,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                40,
                'star',
                6 + Math.random() * 4
            );
        }
        
        for (let i = 0; i < 5; i++) {
            this.createParticle(
                x - i * 10,
                y,
                color,
                -5 - Math.random() * 5,
                (Math.random() - 0.5) * 3,
                30,
                'circle',
                3 + Math.random() * 2
            );
        }
    },

    createDashTrail: function(x, y, color) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 3; i++) {
            this.createParticle(
                x + Math.random() * 30 - 15,
                y + Math.random() * 30 - 15,
                color,
                (Math.random() - 0.5) * 2,
                (Math.random() - 0.5) * 2,
                15,
                'circle',
                2 + Math.random() * 2
            );
        }
    },

    createJumpEffect: function(x, y, color) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 8; i++) {
            const angle = Math.PI + (Math.random() - 0.5) * Math.PI / 2;
            const speed = Math.random() * 8 + 4;
            this.createParticle(
                x + 20,
                y + 40,
                color,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                30,
                'circle',
                4 + Math.random() * 3
            );
        }
        
        for (let i = 0; i < 3; i++) {
            this.createParticle(
                x + 20,
                y + 40,
                '#ffffff',
                (Math.random() - 0.5) * 10,
                -Math.random() * 10,
                25,
                'star',
                2
            );
        }
    },

    createJumpPadEffect: function(x, y) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 10; i++) {
            const angle = Math.PI / 2 + (Math.random() - 0.5) * Math.PI / 3;
            const speed = Math.random() * 15 + 10;
            this.createParticle(
                x,
                y,
                '#00ffff',
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                50,
                'circle',
                5 + Math.random() * 3
            );
        }
        
        for (let i = 0; i < 12; i++) {
            const ringAngle = (i / 12) * Math.PI * 2;
            this.createParticle(
                x,
                y,
                '#ffffff',
                Math.cos(ringAngle) * 5,
                Math.sin(ringAngle) * 5,
                40,
                'circle',
                2
            );
        }
    },

    createModeChangeEffect: function(x, y, color) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 20; i++) {
            const angle = (i / 20) * Math.PI * 2;
            const speed = Math.random() * 20 + 10;
            this.createParticle(
                x + 20,
                y + 20,
                color,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                80,
                i % 2 === 0 ? 'circle' : 'square',
                6 + Math.random() * 4
            );
        }
        
        for (let i = 0; i < 5; i++) {
            this.createParticle(
                x + 20,
                y + 20,
                '#ffffff',
                (Math.random() - 0.5) * 5,
                (Math.random() - 0.5) * 5,
                60,
                'star',
                8
            );
        }
    },

    createPortalEffect: function(x, y, color) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 25; i++) {
            const angle = (i / 25) * Math.PI * 2;
            const speed = Math.random() * 25 + 15;
            this.createParticle(
                x,
                y,
                color,
                Math.cos(angle) * speed,
                Math.sin(angle) * speed,
                100,
                'circle',
                8 + Math.random() * 4
            );
        }
    },

    createCheckpointEffect: function(x, y) {
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 15; i++) {
            const angle = (i / 15) * Math.PI * 2;
            this.createParticle(
                x,
                y,
                '#00ff00',
                Math.cos(angle) * 12,
                Math.sin(angle) * 12,
                60,
                'circle',
                5 + Math.random() * 3
            );
        }
        
        for (let i = 0; i < 8; i++) {
            this.createParticle(
                x,
                y,
                '#ffffff',
                (Math.random() - 0.5) * 3,
                -Math.random() * 8 - 4,
                45,
                'circle',
                3
            );
        }
    },

    createCoinEffect: function(x, y) {
        const coinEffect = document.createElement('div');
        coinEffect.className = 'coin-effect';
        coinEffect.innerText = '+1';
        coinEffect.style.left = (x - Game.camX - 15) + 'px';
        coinEffect.style.top = (y + Game.floorY - 150 - 15) + 'px';
        document.body.appendChild(coinEffect);
        
        setTimeout(() => {
            if (coinEffect.parentNode) {
                coinEffect.parentNode.removeChild(coinEffect);
            }
        }, 1000);
        
        if (!settings.graphics.particles) return;
        
        for (let i = 0; i < 12; i++) {
            const angle = (i / 12) * Math.PI * 2;
            this.createParticle(
                x,
                y,
                '#ffff00',
                Math.cos(angle) * 8,
                Math.sin(angle) * 8,
                40,
                'circle',
                4 + Math.random() * 2
            );
        }
    },

    clearAllParticles: function() {
        this.particles = [];
        
        document.querySelectorAll('.coin-effect, .dash-effect').forEach(el => {
            if (el.parentNode) {
                el.parentNode.removeChild(el);
            }
        });
    },

    update: function() {
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.x += p.vx * Game.deltaTime;
            p.y += p.vy * Game.deltaTime;
            p.vy += 0.5 * Game.deltaTime;
            p.life -= Game.deltaTime;
            p.rotation += p.rotationSpeed * Game.deltaTime;

            if (p.life <= 0) {
                this.particles.splice(i, 1);
            }
        }
    },

    draw: function(ctx, camY) {
        if (!settings.graphics.particles) return;
        
        this.particles.sort((a, b) => a.life - b.life);
        
        this.particles.forEach(p => {
            const alpha = p.life / p.maxLife;
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = p.color;
            
            if (p.glow && Game.currentQuality === 'high' && !Game.ipadMode) {
                ctx.shadowBlur = 10;
                ctx.shadowColor = p.color;
            }
            
            const drawX = p.x - Game.camX;
            const drawY = p.y + camY;
            
            ctx.translate(drawX, drawY);
            ctx.rotate(p.rotation);
            
            if (p.shape === 'circle') {
                ctx.beginPath();
                ctx.arc(0, 0, p.size, 0, Math.PI * 2);
                ctx.fill();
            } else if (p.shape === 'square') {
                ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
            } else if (p.shape === 'star') {
                ctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    const angle = (i * 4 * Math.PI) / 5;
                    const radius = i % 2 === 0 ? p.size : p.size / 2;
                    const x = Math.cos(angle) * radius;
                    const y = Math.sin(angle) * radius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
            }
            
            ctx.restore();
        });
    }
};

// --- TRANSITIONS ---
const Transitions = {
    element: document.getElementById('screen-transition'),

    show: function(callback) {
        this.element.style.background = 'var(--neon-blue)';
        this.element.classList.add('transition-active');
        
        if (settings.graphics.screenshake) {
            document.body.classList.add('screen-shake');
        }
        
        setTimeout(() => {
            if (callback) callback();
            this.hide();
        }, 300);
    },

    hide: function() {
        setTimeout(() => {
            this.element.classList.remove('transition-active');
            document.body.classList.remove('screen-shake');
        }, 300);
    }
};

// --- INPUT SYSTEM ---
const Input = { 
    held: false, 
    mousePressed: false,
    touchSensitivity: settings.controls.sensitivity,
    touchThreshold: [15, 10, 5][settings.controls.sensitivity - 1]
};

const action = () => { 
    if(Game.state === 'game') {
        Input.held = true; 
        AUDIO.init(); 
        
        if (Player.mode !== 'ship' && Player.mode !== 'ufo') {
            Player.jump(); 
        }
    }
};

const release = () => { Input.held = false; };

const isUIElement = (target) => {
    return target.closest('.ui-layer') || target.closest('.mobile-btn') || target.tagName === 'BUTTON' || target.classList.contains('lvl-btn') || target.classList.contains('costume-item') || target.closest('#editor-tools');
};

Input.touchStartAction = (e) => { 
    e.preventDefault(); 
    e.stopPropagation();
    
    if (settings.gameplay.mobileOpt) {
        Input.mousePressed = true; 
        action(); 
    }
};

Input.touchEndAction = (e) => { 
    e.preventDefault(); 
    e.stopPropagation();
    Input.mousePressed = false; 
    release(); 
};

// Keyboard controls
window.onkeydown = (e) => { 
    if(e.repeat) return; 
    
    if(e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
        e.preventDefault(); 
        action();
    }
    else if (e.code === 'KeyR' || e.code === 'KeyY') {
        Game.retry();
    }
    else if (e.code === 'Escape' || e.code === 'Pause' || e.code === 'MediaPlayPause' || e.code === 'Backspace') {
        if (Game.state === 'game' || Game.state === 'dead' || Game.state === 'win') {
            UI.home();
        } else if (Game.state === 'editor' && Game.exitToEditor) {
            Game.exitToEditor();
        } else {
            UI.home();
        }
    }
    else if (e.code === 'KeyP') {
        if (Game.state === 'game') {
            UI.show('menu-pause');
        }
    }
    else if (e.code === 'KeyD' || e.code === 'KeyB') {
        if (Game.state === 'game' && Player.mode === 'cube') {
            Player.dash();
        }
    }
};

window.onkeyup = (e) => { 
    if(e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
        release();
    }
};

// Mouse controls
window.onmousedown = (e) => {
    if(!isUIElement(e.target) && Game.state === 'game') {
        Input.mousePressed = true;
        action();
    }
};

window.onmouseup = () => { 
    Input.mousePressed = false;
    release(); 
};

// Touch controls
window.ontouchstart = (e) => {
    if (isUIElement(e.target)) return;
    
    if (settings.gameplay.mobileOpt) {
        e.preventDefault();
        Input.touchStartAction(e);
    }
};

window.ontouchend = (e) => { 
    if (isUIElement(e.target)) return;
    
    if (settings.gameplay.mobileOpt) {
        e.preventDefault();
        Input.touchEndAction(e);
    }
};

// Prevent context menu
window.oncontextmenu = (e) => {
    if (Game.state === 'game' || Game.state === 'editor') {
        e.preventDefault();
        return false;
    }
};

// Initialize the game
Game.init();
</script>
</body>
</html>
